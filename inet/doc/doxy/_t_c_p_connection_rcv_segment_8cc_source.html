<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>INET Framework for OMNeT++/OMNEST: TCPConnectionRcvSegment.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_493eba74639f722aa88bd3d010f621b5.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_34a6fbd47227bd78d46d19b24c6937db.html">transport</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_9d5c10e2e4f3c4eb7cb80fb0f6ea3e10.html">tcp</a>
  </div>
</div>
<div class="contents">
<h1>TCPConnectionRcvSegment.cc</h1><a href="_t_c_p_connection_rcv_segment_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2004 Andras Varga</span>
<a name="l00003"></a>00003 <span class="comment">//               2009 Thomas Reschka</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00006"></a>00006 <span class="comment">// modify it under the terms of the GNU Lesser General Public License</span>
<a name="l00007"></a>00007 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00008"></a>00008 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment">// GNU Lesser General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment">//</span>
<a name="l00015"></a>00015 <span class="comment">// You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00016"></a>00016 <span class="comment">// along with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_8h.html">TCP.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_connection_8h.html">TCPConnection.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_segment_8h.html">TCPSegment.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_command__m_8h.html">TCPCommand_m.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_send_queue_8h.html">TCPSendQueue.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_s_a_c_k_rexmit_queue_8h.html">TCPSACKRexmitQueue.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_receive_queue_8h.html">TCPReceiveQueue.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_algorithm_8h.html">TCPAlgorithm.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="class_t_c_p_connection.html#a9b7d3f811eab0367d3826dfb20c8d931">00030</a> <span class="keywordtype">bool</span> <a class="code" href="class_t_c_p_connection.html#a9b7d3f811eab0367d3826dfb20c8d931">TCPConnection::tryFastRoute</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032     <span class="comment">// fast route processing not yet implemented</span>
<a name="l00033"></a>00033     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="class_t_c_p_connection.html#a82f6b7680530f0f784e9d8efa78fa5a5">00037</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#a82f6b7680530f0f784e9d8efa78fa5a5">TCPConnection::segmentArrivalWhileClosed</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Seg arrived: &quot;</span>;
<a name="l00040"></a>00040     <a class="code" href="class_t_c_p_connection.html#a188549e7c936c8cad622c180d3200c69">printSegmentBrief</a>(tcpseg);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     <span class="comment">// This segment doesn&apos;t belong to any connection, so this object</span>
<a name="l00043"></a>00043     <span class="comment">// must be a temp object created solely for the purpose of calling us</span>
<a name="l00044"></a>00044     ASSERT(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>==NULL);
<a name="l00045"></a>00045     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Segment doesn&apos;t belong to any existing connection\n&quot;</span>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="comment">// RFC 793:</span>
<a name="l00048"></a>00048     <span class="comment">//&quot;</span>
<a name="l00049"></a>00049     <span class="comment">// all data in the incoming segment is discarded.  An incoming</span>
<a name="l00050"></a>00050     <span class="comment">// segment containing a RST is discarded.  An incoming segment not</span>
<a name="l00051"></a>00051     <span class="comment">// containing a RST causes a RST to be sent in response.  The</span>
<a name="l00052"></a>00052     <span class="comment">// acknowledgment and sequence field values are selected to make the</span>
<a name="l00053"></a>00053     <span class="comment">// reset sequence acceptable to the TCP that sent the offending</span>
<a name="l00054"></a>00054     <span class="comment">// segment.</span>
<a name="l00055"></a>00055     <span class="comment">//</span>
<a name="l00056"></a>00056     <span class="comment">// If the ACK bit is off, sequence number zero is used,</span>
<a name="l00057"></a>00057     <span class="comment">//</span>
<a name="l00058"></a>00058     <span class="comment">//    &lt;SEQ=0&gt;&lt;ACK=SEG.SEQ+SEG.LEN&gt;&lt;CTL=RST,ACK&gt;</span>
<a name="l00059"></a>00059     <span class="comment">//</span>
<a name="l00060"></a>00060     <span class="comment">// If the ACK bit is on,</span>
<a name="l00061"></a>00061     <span class="comment">//</span>
<a name="l00062"></a>00062     <span class="comment">//    &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00063"></a>00063     <span class="comment">//&quot;</span>
<a name="l00064"></a>00064     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00065"></a>00065     {
<a name="l00066"></a>00066         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST bit set: dropping segment\n&quot;</span>;
<a name="l00067"></a>00067         <span class="keywordflow">return</span>;
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (!tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00071"></a>00071     {
<a name="l00072"></a>00072         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit not set: sending RST+ACK\n&quot;</span>;
<a name="l00073"></a>00073         uint32 ackNo = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00074"></a>00074         <a class="code" href="class_t_c_p_connection.html#ade3c9c38be0aa758b4eb448d5c1169b9">sendRstAck</a>(0,ackNo,destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076     <span class="keywordflow">else</span>
<a name="l00077"></a>00077     {
<a name="l00078"></a>00078         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set: sending RST\n&quot;</span>;
<a name="l00079"></a>00079         <a class="code" href="class_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="class_t_c_p_connection.html#a46ac1b09624942471db2eb76ef991143">00083</a> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <a class="code" href="class_t_c_p_connection.html#a46ac1b09624942471db2eb76ef991143">TCPConnection::process_RCV_SEGMENT</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> src, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> dest)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Seg arrived: &quot;</span>;
<a name="l00086"></a>00086     <a class="code" href="class_t_c_p_connection.html#a188549e7c936c8cad622c180d3200c69">printSegmentBrief</a>(tcpseg);
<a name="l00087"></a>00087     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;TCB: &quot;</span> &lt;&lt; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a93fbf3558fe0e1dfa27bdbab25c36aff">info</a>() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a02c1500cf2719ebc20fe5e44ca9c663f">rcvSeqVector</a>) <a class="code" href="class_t_c_p_connection.html#a02c1500cf2719ebc20fe5e44ca9c663f">rcvSeqVector</a>-&gt;record(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>());
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#abe4b8c8de0df4555c93fc23dcb099893">rcvAckVector</a>) <a class="code" href="class_t_c_p_connection.html#abe4b8c8de0df4555c93fc23dcb099893">rcvAckVector</a>-&gt;record(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">//</span>
<a name="l00093"></a>00093     <span class="comment">// Note: this code is organized exactly as RFC 793, section &quot;3.9 Event</span>
<a name="l00094"></a>00094     <span class="comment">// Processing&quot;, subsection &quot;SEGMENT ARRIVES&quot;.</span>
<a name="l00095"></a>00095     <span class="comment">//</span>
<a name="l00096"></a>00096     <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> event;
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca7f359883afd2bba5873121486706ccab">TCP_S_LISTEN</a>)
<a name="l00098"></a>00098     {
<a name="l00099"></a>00099         <span class="keyword">event</span> = <a class="code" href="class_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">processSegmentInListen</a>(tcpseg, src, dest);
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca70c06b27000be54aee473572dd755890">TCP_S_SYN_SENT</a>)
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103         <span class="keyword">event</span> = <a class="code" href="class_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">processSegmentInSynSent</a>(tcpseg, src, dest);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     <span class="keywordflow">else</span>
<a name="l00106"></a>00106     {
<a name="l00107"></a>00107         <span class="comment">// RFC 793 steps &quot;first check sequence number&quot;, &quot;second check the RST bit&quot;, etc</span>
<a name="l00108"></a>00108         <span class="keyword">event</span> = <a class="code" href="class_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">processSegment1stThru8th</a>(tcpseg);
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keyword">delete</span> tcpseg;
<a name="l00111"></a>00111     <span class="keywordflow">return</span> event;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="class_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">00114</a> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <a class="code" href="class_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">TCPConnection::processSegment1stThru8th</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <span class="comment">//</span>
<a name="l00117"></a>00117     <span class="comment">// RFC 793: first check sequence number</span>
<a name="l00118"></a>00118     <span class="comment">//</span>
<a name="l00119"></a>00119     <span class="keywordtype">bool</span> acceptable = <a class="code" href="class_t_c_p_connection.html#acceb561b23349d06b298858e39433435">isSegmentAcceptable</a>(tcpseg);
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (!acceptable)
<a name="l00121"></a>00121     {
<a name="l00122"></a>00122         <span class="comment">//&quot;</span>
<a name="l00123"></a>00123         <span class="comment">// If an incoming segment is not acceptable, an acknowledgment</span>
<a name="l00124"></a>00124         <span class="comment">// should be sent in reply (unless the RST bit is set, if so drop</span>
<a name="l00125"></a>00125         <span class="comment">// the segment and return):</span>
<a name="l00126"></a>00126         <span class="comment">//</span>
<a name="l00127"></a>00127         <span class="comment">//  &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00128"></a>00128         <span class="comment">//&quot;</span>
<a name="l00129"></a>00129         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00130"></a>00130         {
<a name="l00131"></a>00131             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST with unacceptable seqNum: dropping\n&quot;</span>;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133         <span class="keywordflow">else</span>
<a name="l00134"></a>00134         {
<a name="l00135"></a>00135             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00136"></a>00136             {
<a name="l00137"></a>00137                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN with unacceptable seqNum in &quot;</span> &lt;&lt;  <a class="code" href="class_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()) &lt;&lt; <span class="stringliteral">&quot; state received (SYN duplicat?)\n&quot;</span>;
<a name="l00138"></a>00138             }
<a name="l00139"></a>00139             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a> &amp;&amp; <a class="code" href="_t_c_p_connection_8h.html#aa2e84a0093c6f222b12a4b443c7278eb">seqLess</a>((tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()+tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()), <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>))
<a name="l00140"></a>00140             {
<a name="l00141"></a>00141                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#aa65590b4103c7d29454d8ea5b3a781c0">start_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00142"></a>00142                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ab59f15cb0300b2bb025186468e7a03a5">end_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00143"></a>00143                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8a15484ad9b2724916935eab69c6693f">snd_dsack</a> = <span class="keyword">true</span>;
<a name="l00144"></a>00144                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SND_D-SACK SET (dupseg rcvd)\n&quot;</span>;
<a name="l00145"></a>00145             }
<a name="l00146"></a>00146 
<a name="l00147"></a>00147             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Segment seqNum not acceptable, sending ACK with current receive seq\n&quot;</span>;
<a name="l00148"></a>00148             <span class="comment">// RFC 2018, page 4:</span>
<a name="l00149"></a>00149             <span class="comment">// &quot;The receiver SHOULD send an ACK for every valid segment that arrives</span>
<a name="l00150"></a>00150             <span class="comment">// containing new data, and each of these &quot;duplicate&quot; ACKs SHOULD bear a</span>
<a name="l00151"></a>00151             <span class="comment">// SACK option.&quot;</span>
<a name="l00152"></a>00152             <span class="comment">//</span>
<a name="l00153"></a>00153             <span class="comment">// The received segment is not &quot;valid&quot; therefore the ACK will not bear a SACK option, if snd_dsack (D-SACK) is not set.</span>
<a name="l00154"></a>00154             <a class="code" href="class_t_c_p_connection.html#a60ee5bc5b391d621e7e684857e195151">sendAck</a>();
<a name="l00155"></a>00155         }
<a name="l00156"></a>00156         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00157"></a>00157     }
<a name="l00158"></a>00158 
<a name="l00159"></a>00159     <span class="comment">//</span>
<a name="l00160"></a>00160     <span class="comment">// RFC 793: second check the RST bit,</span>
<a name="l00161"></a>00161     <span class="comment">//</span>
<a name="l00162"></a>00162     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00163"></a>00163     {
<a name="l00164"></a>00164         <span class="comment">// Note: if we come from LISTEN, processSegmentInListen() has already handled RST.</span>
<a name="l00165"></a>00165         <span class="keywordflow">switch</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l00166"></a>00166         {
<a name="l00167"></a>00167             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a>:
<a name="l00168"></a>00168                 <span class="comment">//&quot;</span>
<a name="l00169"></a>00169                 <span class="comment">// If this connection was initiated with a passive OPEN (i.e.,</span>
<a name="l00170"></a>00170                 <span class="comment">// came from the LISTEN state), then return this connection to</span>
<a name="l00171"></a>00171                 <span class="comment">// LISTEN state and return.  The user need not be informed.  If</span>
<a name="l00172"></a>00172                 <span class="comment">// this connection was initiated with an active OPEN (i.e., came</span>
<a name="l00173"></a>00173                 <span class="comment">// from SYN-SENT state) then the connection was refused, signal</span>
<a name="l00174"></a>00174                 <span class="comment">// the user &quot;connection refused&quot;.  In either case, all segments</span>
<a name="l00175"></a>00175                 <span class="comment">// on the retransmission queue should be removed.  And in the</span>
<a name="l00176"></a>00176                 <span class="comment">// active OPEN case, enter the CLOSED state and delete the TCB,</span>
<a name="l00177"></a>00177                 <span class="comment">// and return.</span>
<a name="l00178"></a>00178                 <span class="comment">//&quot;</span>
<a name="l00179"></a>00179                 <span class="keywordflow">return</span> <a class="code" href="class_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">processRstInSynReceived</a>(tcpseg);
<a name="l00180"></a>00180 
<a name="l00181"></a>00181             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaa8c5be2b3d7977abc27dfc396001f467">TCP_S_ESTABLISHED</a>:
<a name="l00182"></a>00182             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a>:
<a name="l00183"></a>00183             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>:
<a name="l00184"></a>00184             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca077a72ba910cb22c3a4139dd0a4c3107">TCP_S_CLOSE_WAIT</a>:
<a name="l00185"></a>00185                 <span class="comment">//&quot;</span>
<a name="l00186"></a>00186                 <span class="comment">// If the RST bit is set then, any outstanding RECEIVEs and SEND</span>
<a name="l00187"></a>00187                 <span class="comment">// should receive &quot;reset&quot; responses.  All segment queues should be</span>
<a name="l00188"></a>00188                 <span class="comment">// flushed.  Users should also receive an unsolicited general</span>
<a name="l00189"></a>00189                 <span class="comment">// &quot;connection reset&quot; signal.</span>
<a name="l00190"></a>00190                 <span class="comment">//</span>
<a name="l00191"></a>00191                 <span class="comment">// Enter the CLOSED state, delete the TCB, and return.</span>
<a name="l00192"></a>00192                 <span class="comment">//&quot;</span>
<a name="l00193"></a>00193                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST: performing connection reset, closing connection\n&quot;</span>;
<a name="l00194"></a>00194                 <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00195"></a>00195                 <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf96013e6e28c73e47277bb885fcf7aa6">TCP_E_RCV_RST</a>;  <span class="comment">// this will trigger state transition</span>
<a name="l00196"></a>00196 
<a name="l00197"></a>00197             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecac43577621e6bf197109353b11babacd1">TCP_S_CLOSING</a>:
<a name="l00198"></a>00198             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecab44fe111730bbb0c24e5bc652659fff7">TCP_S_LAST_ACK</a>:
<a name="l00199"></a>00199             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>:
<a name="l00200"></a>00200                 <span class="comment">//&quot;</span>
<a name="l00201"></a>00201                 <span class="comment">// enter the CLOSED state, delete the TCB, and return.</span>
<a name="l00202"></a>00202                 <span class="comment">//&quot;</span>
<a name="l00203"></a>00203                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST: closing connection\n&quot;</span>;
<a name="l00204"></a>00204                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()!=<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>)
<a name="l00205"></a>00205                     <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>); <span class="comment">// in TIME_WAIT, we&apos;ve already sent it</span>
<a name="l00206"></a>00206                 <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf96013e6e28c73e47277bb885fcf7aa6">TCP_E_RCV_RST</a>; <span class="comment">// this will trigger state transition</span>
<a name="l00207"></a>00207 
<a name="l00208"></a>00208             <span class="keywordflow">default</span>: ASSERT(0);
<a name="l00209"></a>00209         }
<a name="l00210"></a>00210     }
<a name="l00211"></a>00211 
<a name="l00212"></a>00212     <span class="comment">// RFC 793: third check security and precedence</span>
<a name="l00213"></a>00213     <span class="comment">// This step is ignored.</span>
<a name="l00214"></a>00214 
<a name="l00215"></a>00215     <span class="comment">//</span>
<a name="l00216"></a>00216     <span class="comment">// RFC 793: fourth, check the SYN bit,</span>
<a name="l00217"></a>00217     <span class="comment">//</span>
<a name="l00218"></a>00218     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00219"></a>00219     {
<a name="l00220"></a>00220         <span class="comment">//&quot;</span>
<a name="l00221"></a>00221         <span class="comment">// If the SYN is in the window it is an error, send a reset, any</span>
<a name="l00222"></a>00222         <span class="comment">// outstanding RECEIVEs and SEND should receive &quot;reset&quot; responses,</span>
<a name="l00223"></a>00223         <span class="comment">// all segment queues should be flushed, the user should also</span>
<a name="l00224"></a>00224         <span class="comment">// receive an unsolicited general &quot;connection reset&quot; signal, enter</span>
<a name="l00225"></a>00225         <span class="comment">// the CLOSED state, delete the TCB, and return.</span>
<a name="l00226"></a>00226         <span class="comment">//</span>
<a name="l00227"></a>00227         <span class="comment">// If the SYN is not in the window this step would not be reached</span>
<a name="l00228"></a>00228         <span class="comment">// and an ack would have been sent in the first step (sequence</span>
<a name="l00229"></a>00229         <span class="comment">// number check).</span>
<a name="l00230"></a>00230         <span class="comment">//&quot;</span>
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         ASSERT(<a class="code" href="class_t_c_p_connection.html#acceb561b23349d06b298858e39433435">isSegmentAcceptable</a>(tcpseg));  <span class="comment">// assert SYN is in the window</span>
<a name="l00233"></a>00233         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN is in the window: performing connection reset, closing connection\n&quot;</span>;
<a name="l00234"></a>00234         <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00235"></a>00235         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eac411ade35040a1a93a97487da933a6ff">TCP_E_RCV_UNEXP_SYN</a>;
<a name="l00236"></a>00236     }
<a name="l00237"></a>00237 
<a name="l00238"></a>00238     <span class="comment">//</span>
<a name="l00239"></a>00239     <span class="comment">// RFC 793: fifth check the ACK field,</span>
<a name="l00240"></a>00240     <span class="comment">//</span>
<a name="l00241"></a>00241     <span class="keywordflow">if</span> (!tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00242"></a>00242     {
<a name="l00243"></a>00243         <span class="comment">// if the ACK bit is off drop the segment and return</span>
<a name="l00244"></a>00244         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK not set, dropping segment\n&quot;</span>;
<a name="l00245"></a>00245         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00246"></a>00246     }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248     <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00249"></a>00249 
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a>)
<a name="l00251"></a>00251     {
<a name="l00252"></a>00252         <span class="comment">//&quot;</span>
<a name="l00253"></a>00253         <span class="comment">// If SND.UNA =&lt; SEG.ACK =&lt; SND.NXT then enter ESTABLISHED state</span>
<a name="l00254"></a>00254         <span class="comment">// and continue processing.</span>
<a name="l00255"></a>00255         <span class="comment">//</span>
<a name="l00256"></a>00256         <span class="comment">// If the segment acknowledgment is not acceptable, form a</span>
<a name="l00257"></a>00257         <span class="comment">// reset segment,</span>
<a name="l00258"></a>00258         <span class="comment">//</span>
<a name="l00259"></a>00259         <span class="comment">//  &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00260"></a>00260         <span class="comment">//</span>
<a name="l00261"></a>00261         <span class="comment">// and send it.</span>
<a name="l00262"></a>00262         <span class="comment">//&quot;</span>
<a name="l00263"></a>00263         <span class="keywordflow">if</span> (!<a class="code" href="_t_c_p_connection_8h.html#a55ef269e8ae44948c1d1f1cbe14bc92b">seqLE</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()) || !<a class="code" href="_t_c_p_connection_8h.html#a55ef269e8ae44948c1d1f1cbe14bc92b">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>))
<a name="l00264"></a>00264         {
<a name="l00265"></a>00265             <a class="code" href="class_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l00266"></a>00266             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00267"></a>00267         }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="comment">// notify tcpAlgorithm and app layer</span>
<a name="l00270"></a>00270         <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#a2d051b6a9e2a9fccfa6f8b64bb8c647d">established</a>(<span class="keyword">false</span>);
<a name="l00271"></a>00271         <a class="code" href="class_t_c_p_connection.html#ab04a91abde05d21293c30a78ab968eef">sendEstabIndicationToApp</a>();
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="comment">// This will trigger transition to ESTABLISHED. Timers and notifying</span>
<a name="l00274"></a>00274         <span class="comment">// app will be taken care of in stateEntered().</span>
<a name="l00275"></a>00275         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea5458371b7cd8cddaa5342ab47915844a">TCP_E_RCV_ACK</a>;
<a name="l00276"></a>00276     }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278     uint32 old_snd_nxt = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>; <span class="comment">// later we&apos;ll need to see if snd_nxt changed</span>
<a name="l00279"></a>00279     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaa8c5be2b3d7977abc27dfc396001f467">TCP_S_ESTABLISHED</a> ||
<a name="l00280"></a>00280         <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a> ||
<a name="l00281"></a>00281         <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca077a72ba910cb22c3a4139dd0a4c3107">TCP_S_CLOSE_WAIT</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecac43577621e6bf197109353b11babacd1">TCP_S_CLOSING</a>)
<a name="l00282"></a>00282     {
<a name="l00283"></a>00283         <span class="comment">//</span>
<a name="l00284"></a>00284         <span class="comment">// ESTABLISHED processing:</span>
<a name="l00285"></a>00285         <span class="comment">//&quot;</span>
<a name="l00286"></a>00286         <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT then, set SND.UNA &lt;- SEG.ACK.</span>
<a name="l00287"></a>00287         <span class="comment">//  Any segments on the retransmission queue which are thereby</span>
<a name="l00288"></a>00288         <span class="comment">//  entirely acknowledged are removed.  Users should receive</span>
<a name="l00289"></a>00289         <span class="comment">//  positive acknowledgments for buffers which have been SENT and</span>
<a name="l00290"></a>00290         <span class="comment">//  fully acknowledged (i.e., SEND buffer should be returned with</span>
<a name="l00291"></a>00291         <span class="comment">//  &quot;ok&quot; response).  If the ACK is a duplicate</span>
<a name="l00292"></a>00292         <span class="comment">//  (SEG.ACK &lt; SND.UNA), it can be ignored.  If the ACK acks</span>
<a name="l00293"></a>00293         <span class="comment">//  something not yet sent (SEG.ACK &gt; SND.NXT) then send an ACK,</span>
<a name="l00294"></a>00294         <span class="comment">//  drop the segment, and return.</span>
<a name="l00295"></a>00295         <span class="comment">//</span>
<a name="l00296"></a>00296         <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT, the send window should be</span>
<a name="l00297"></a>00297         <span class="comment">//  updated.  If (SND.WL1 &lt; SEG.SEQ or (SND.WL1 = SEG.SEQ and</span>
<a name="l00298"></a>00298         <span class="comment">//  SND.WL2 =&lt; SEG.ACK)), set SND.WND &lt;- SEG.WND, set</span>
<a name="l00299"></a>00299         <span class="comment">//  SND.WL1 &lt;- SEG.SEQ, and set SND.WL2 &lt;- SEG.ACK.</span>
<a name="l00300"></a>00300         <span class="comment">//</span>
<a name="l00301"></a>00301         <span class="comment">//  Note that SND.WND is an offset from SND.UNA, that SND.WL1</span>
<a name="l00302"></a>00302         <span class="comment">//  records the sequence number of the last segment used to update</span>
<a name="l00303"></a>00303         <span class="comment">//  SND.WND, and that SND.WL2 records the acknowledgment number of</span>
<a name="l00304"></a>00304         <span class="comment">//  the last segment used to update SND.WND.  The check here</span>
<a name="l00305"></a>00305         <span class="comment">//  prevents using old segments to update the window.</span>
<a name="l00306"></a>00306         <span class="comment">//&quot;</span>
<a name="l00307"></a>00307         <span class="keywordtype">bool</span> ok = <a class="code" href="class_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">processAckInEstabEtc</a>(tcpseg);
<a name="l00308"></a>00308         <span class="keywordflow">if</span> (!ok)
<a name="l00309"></a>00309             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;  <span class="comment">// if acks something not yet sent, drop it</span>
<a name="l00310"></a>00310     }
<a name="l00311"></a>00311 
<a name="l00312"></a>00312     <span class="keywordflow">if</span> ((<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a> &amp;&amp; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac70666b0903dcc4bb0c76e4e3ddd64cd">fin_ack_rcvd</a>))
<a name="l00313"></a>00313     {
<a name="l00314"></a>00314         <span class="comment">//&quot;</span>
<a name="l00315"></a>00315         <span class="comment">// FIN-WAIT-1 STATE</span>
<a name="l00316"></a>00316         <span class="comment">//   In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00317"></a>00317         <span class="comment">//   our FIN is now acknowledged then enter FIN-WAIT-2 and continue</span>
<a name="l00318"></a>00318         <span class="comment">//   processing in that state.</span>
<a name="l00319"></a>00319         <span class="comment">//&quot;</span>
<a name="l00320"></a>00320         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea5458371b7cd8cddaa5342ab47915844a">TCP_E_RCV_ACK</a>;  <span class="comment">// will trigger transition to FIN-WAIT-2</span>
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>)
<a name="l00324"></a>00324     {
<a name="l00325"></a>00325         <span class="comment">//&quot;</span>
<a name="l00326"></a>00326         <span class="comment">// FIN-WAIT-2 STATE</span>
<a name="l00327"></a>00327         <span class="comment">//  In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00328"></a>00328         <span class="comment">//  the retransmission queue is empty, the user&apos;s CLOSE can be</span>
<a name="l00329"></a>00329         <span class="comment">//  acknowledged (&quot;ok&quot;) but do not delete the TCB.</span>
<a name="l00330"></a>00330         <span class="comment">//&quot;</span>
<a name="l00331"></a>00331         <span class="comment">// nothing to do here (in our model, used commands don&apos;t need to be</span>
<a name="l00332"></a>00332         <span class="comment">// acknowledged)</span>
<a name="l00333"></a>00333     }
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecac43577621e6bf197109353b11babacd1">TCP_S_CLOSING</a>)
<a name="l00336"></a>00336     {
<a name="l00337"></a>00337         <span class="comment">//&quot;</span>
<a name="l00338"></a>00338         <span class="comment">// In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00339"></a>00339         <span class="comment">// the ACK acknowledges our FIN then enter the TIME-WAIT state,</span>
<a name="l00340"></a>00340         <span class="comment">// otherwise ignore the segment.</span>
<a name="l00341"></a>00341         <span class="comment">//&quot;</span>
<a name="l00342"></a>00342         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac70666b0903dcc4bb0c76e4e3ddd64cd">fin_ack_rcvd</a>)
<a name="l00343"></a>00343         {
<a name="l00344"></a>00344             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Our FIN acked -- can go to TIME_WAIT now\n&quot;</span>;
<a name="l00345"></a>00345             <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea5458371b7cd8cddaa5342ab47915844a">TCP_E_RCV_ACK</a>;  <span class="comment">// will trigger transition to TIME-WAIT</span>
<a name="l00346"></a>00346             <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);  <span class="comment">// start timer</span>
<a name="l00347"></a>00347 
<a name="l00348"></a>00348             <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00349"></a>00349             <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00350"></a>00350             <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00351"></a>00351         }
<a name="l00352"></a>00352     }
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecab44fe111730bbb0c24e5bc652659fff7">TCP_S_LAST_ACK</a>)
<a name="l00355"></a>00355     {
<a name="l00356"></a>00356         <span class="comment">//&quot;</span>
<a name="l00357"></a>00357         <span class="comment">// The only thing that can arrive in this state is an</span>
<a name="l00358"></a>00358         <span class="comment">// acknowledgment of our FIN.  If our FIN is now acknowledged,</span>
<a name="l00359"></a>00359         <span class="comment">// delete the TCB, enter the CLOSED state, and return.</span>
<a name="l00360"></a>00360         <span class="comment">//&quot;</span>
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0401bd2db76f20ea6141550db9ae4d61">send_fin</a> &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a20daa063530e578155124d9f9e4626f0">snd_fin_seq</a>+1)
<a name="l00362"></a>00362         {
<a name="l00363"></a>00363             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Last ACK arrived\n&quot;</span>;
<a name="l00364"></a>00364             <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00365"></a>00365             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea5458371b7cd8cddaa5342ab47915844a">TCP_E_RCV_ACK</a>; <span class="comment">// will trigger transition to CLOSED</span>
<a name="l00366"></a>00366         }
<a name="l00367"></a>00367     }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>)
<a name="l00370"></a>00370     {
<a name="l00371"></a>00371         <span class="comment">//&quot;</span>
<a name="l00372"></a>00372         <span class="comment">// The only thing that can arrive in this state is a</span>
<a name="l00373"></a>00373         <span class="comment">// retransmission of the remote FIN.  Acknowledge it, and restart</span>
<a name="l00374"></a>00374         <span class="comment">// the 2 MSL timeout.</span>
<a name="l00375"></a>00375         <span class="comment">//&quot;</span>
<a name="l00376"></a>00376         <span class="comment">// And we are staying in the TIME_WAIT state.</span>
<a name="l00377"></a>00377         <span class="comment">//</span>
<a name="l00378"></a>00378         <a class="code" href="class_t_c_p_connection.html#a60ee5bc5b391d621e7e684857e195151">sendAck</a>();
<a name="l00379"></a>00379         <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>);
<a name="l00380"></a>00380         <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">//</span>
<a name="l00384"></a>00384     <span class="comment">// RFC 793: sixth, check the URG bit,</span>
<a name="l00385"></a>00385     <span class="comment">//</span>
<a name="l00386"></a>00386     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() &amp;&amp; (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaa8c5be2b3d7977abc27dfc396001f467">TCP_S_ESTABLISHED</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a> ||
<a name="l00387"></a>00387         <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>))
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="comment">//&quot;</span>
<a name="l00390"></a>00390         <span class="comment">// If the URG bit is set, RCV.UP &lt;- max(RCV.UP,SEG.UP), and signal</span>
<a name="l00391"></a>00391         <span class="comment">// the user that the remote side has urgent data if the urgent</span>
<a name="l00392"></a>00392         <span class="comment">// pointer (RCV.UP) is in advance of the data consumed.  If the</span>
<a name="l00393"></a>00393         <span class="comment">// user has already been signaled (or is still in the &quot;urgent</span>
<a name="l00394"></a>00394         <span class="comment">// mode&quot;) for this continuous sequence of urgent data, do not</span>
<a name="l00395"></a>00395         <span class="comment">// signal the user again.</span>
<a name="l00396"></a>00396         <span class="comment">//&quot;</span>
<a name="l00397"></a>00397 
<a name="l00398"></a>00398         <span class="comment">// TBD: URG currently not supported</span>
<a name="l00399"></a>00399     }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401     <span class="comment">//</span>
<a name="l00402"></a>00402     <span class="comment">// RFC 793: seventh, process the segment text,</span>
<a name="l00403"></a>00403     <span class="comment">//</span>
<a name="l00404"></a>00404     uint32 old_rcv_nxt = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>; <span class="comment">// if rcv_nxt changes, we need to send/schedule an ACK</span>
<a name="l00405"></a>00405     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaa8c5be2b3d7977abc27dfc396001f467">TCP_S_ESTABLISHED</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>)
<a name="l00406"></a>00406     {
<a name="l00407"></a>00407         <span class="comment">//&quot;</span>
<a name="l00408"></a>00408         <span class="comment">// Once in the ESTABLISHED state, it is possible to deliver segment</span>
<a name="l00409"></a>00409         <span class="comment">// text to user RECEIVE buffers.  Text from segments can be moved</span>
<a name="l00410"></a>00410         <span class="comment">// into buffers until either the buffer is full or the segment is</span>
<a name="l00411"></a>00411         <span class="comment">// empty.  If the segment empties and carries an PUSH flag, then</span>
<a name="l00412"></a>00412         <span class="comment">// the user is informed, when the buffer is returned, that a PUSH</span>
<a name="l00413"></a>00413         <span class="comment">// has been received.</span>
<a name="l00414"></a>00414         <span class="comment">//</span>
<a name="l00415"></a>00415         <span class="comment">// When the TCP takes responsibility for delivering the data to the</span>
<a name="l00416"></a>00416         <span class="comment">// user it must also acknowledge the receipt of the data.</span>
<a name="l00417"></a>00417         <span class="comment">//</span>
<a name="l00418"></a>00418         <span class="comment">// Once the TCP takes responsibility for the data it advances</span>
<a name="l00419"></a>00419         <span class="comment">// RCV.NXT over the data accepted, and adjusts RCV.WND as</span>
<a name="l00420"></a>00420         <span class="comment">// apporopriate to the current buffer availability.  The total of</span>
<a name="l00421"></a>00421         <span class="comment">// RCV.NXT and RCV.WND should not be reduced.</span>
<a name="l00422"></a>00422         <span class="comment">//</span>
<a name="l00423"></a>00423         <span class="comment">// Please note the window management suggestions in section 3.7.</span>
<a name="l00424"></a>00424         <span class="comment">//</span>
<a name="l00425"></a>00425         <span class="comment">// Send an acknowledgment of the form:</span>
<a name="l00426"></a>00426         <span class="comment">//</span>
<a name="l00427"></a>00427         <span class="comment">//   &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00428"></a>00428         <span class="comment">//</span>
<a name="l00429"></a>00429         <span class="comment">// This acknowledgment should be piggybacked on a segment being</span>
<a name="l00430"></a>00430         <span class="comment">// transmitted if possible without incurring undue delay.</span>
<a name="l00431"></a>00431         <span class="comment">//&quot;</span>
<a name="l00432"></a>00432         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00433"></a>00433         {
<a name="l00434"></a>00434             <span class="comment">// check for full sized segment</span>
<a name="l00435"></a>00435             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>() == <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a2d9952d560079e7a0cf44f2308ac564f">snd_mss</a>)
<a name="l00436"></a>00436                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5d47c2c046bb9fe704be153bb0731e9a">full_sized_segment_counter</a>++;
<a name="l00437"></a>00437             <span class="comment">// check for persist probe</span>
<a name="l00438"></a>00438             if (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>() == 1)
<a name="l00439"></a>00439                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>;    <span class="comment">// TODO how to check if it is really a persist probe?</span>
<a name="l00440"></a>00440 
<a name="l00441"></a>00441             <a class="code" href="class_t_c_p_connection.html#ae25d720620d8fe927087e1af0692ed90">updateRcvQueueVars</a>();
<a name="l00442"></a>00442             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0a9bd82033191de60a5bc5b3915ba8ae">freeRcvBuffer</a> &gt;= tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()) <span class="comment">// enough freeRcvBuffer in rcvQueue for new segment?</span>
<a name="l00443"></a>00443             {
<a name="l00444"></a>00444                 <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment text in a data transfer state\n&quot;</span>;
<a name="l00445"></a>00445 
<a name="l00446"></a>00446                 <span class="comment">// insert into receive buffers. If this segment is contiguous with</span>
<a name="l00447"></a>00447                 <span class="comment">// previously received ones (seqNo==rcv_nxt), rcv_nxt can be increased;</span>
<a name="l00448"></a>00448                 <span class="comment">// otherwise it stays the same but the data must be cached nevertheless</span>
<a name="l00449"></a>00449                 <span class="comment">// (to avoid &quot;Failure to retain above-sequence data&quot; problem, RFC 2525</span>
<a name="l00450"></a>00450                 <span class="comment">// section 2.5).</span>
<a name="l00451"></a>00451 
<a name="l00452"></a>00452                 uint32 old_usedRcvBuffer = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3cb8ed26db2dbc9c3821a199354367ae">usedRcvBuffer</a>;
<a name="l00453"></a>00453                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> = <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#ac17c031fdec7aa75b656bf7e742a38d2">insertBytesFromSegment</a>(tcpseg);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455                 <span class="comment">// out-of-order segment?</span>
<a name="l00456"></a>00456                 <span class="keywordflow">if</span> (old_rcv_nxt==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>)
<a name="l00457"></a>00457                 {
<a name="l00458"></a>00458                     <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a2297a0a5817443e592d2770ec016b0a0">rcv_oooseg</a>++;
<a name="l00459"></a>00459                     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a6ae35f9e338201b6f1f36e1c0aaf9acb">rcvOooSegVector</a>)
<a name="l00460"></a>00460                         <a class="code" href="class_t_c_p_connection.html#a6ae35f9e338201b6f1f36e1c0aaf9acb">rcvOooSegVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a2297a0a5817443e592d2770ec016b0a0">rcv_oooseg</a>);
<a name="l00461"></a>00461 
<a name="l00462"></a>00462                     <span class="comment">// RFC 2018, page 4:</span>
<a name="l00463"></a>00463                     <span class="comment">// &quot;The receiver SHOULD send an ACK for every valid segment that arrives</span>
<a name="l00464"></a>00464                     <span class="comment">// containing new data, and each of these &quot;duplicate&quot; ACKs SHOULD bear a</span>
<a name="l00465"></a>00465                     <span class="comment">// SACK option.&quot;</span>
<a name="l00466"></a>00466                     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a>)
<a name="l00467"></a>00467                     {
<a name="l00468"></a>00468                         <span class="comment">// store start and end sequence numbers of current oooseg in state variables</span>
<a name="l00469"></a>00469                         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#aa65590b4103c7d29454d8ea5b3a781c0">start_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00470"></a>00470                         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ab59f15cb0300b2bb025186468e7a03a5">end_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                         <span class="keywordflow">if</span> (old_usedRcvBuffer == <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#a46f4aa6d8cd91c25275f3997fc3e2e04">getAmountOfBufferedBytes</a>()) <span class="comment">// D-SACK</span>
<a name="l00473"></a>00473                         {
<a name="l00474"></a>00474                             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8a15484ad9b2724916935eab69c6693f">snd_dsack</a> = <span class="keyword">true</span>;
<a name="l00475"></a>00475                             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SND_D-SACK SET (old_rcv_nxt==rcv_nxt duplicated oooseg rcvd)\n&quot;</span>;
<a name="l00476"></a>00476                         }
<a name="l00477"></a>00477                         <span class="keywordflow">else</span> <span class="comment">// SACK</span>
<a name="l00478"></a>00478                         {
<a name="l00479"></a>00479                             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ad03a121385224b940565040fe9eb433a">snd_sack</a> = <span class="keyword">true</span>;
<a name="l00480"></a>00480                             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SND_SACK SET (old_rcv_nxt==rcv_nxt oooseg rcvd)\n&quot;</span>;
<a name="l00481"></a>00481                         }
<a name="l00482"></a>00482                     }
<a name="l00483"></a>00483                     <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#a10903af17a26011a95b6745eb80f65ed">receivedOutOfOrderSegment</a>();
<a name="l00484"></a>00484                 }
<a name="l00485"></a>00485                 <span class="keywordflow">else</span>
<a name="l00486"></a>00486                 {
<a name="l00487"></a>00487                     <span class="comment">// forward data to app</span>
<a name="l00488"></a>00488                     <span class="comment">//</span>
<a name="l00489"></a>00489                     <span class="comment">// FIXME observe PSH bit</span>
<a name="l00490"></a>00490                     <span class="comment">//</span>
<a name="l00491"></a>00491                     <span class="comment">// FIXME we should implement socket READ command, and pass up only</span>
<a name="l00492"></a>00492                     <span class="comment">// as many bytes as requested. rcv_wnd should be decreased</span>
<a name="l00493"></a>00493                     <span class="comment">// accordingly!</span>
<a name="l00494"></a>00494                     <span class="comment">//</span>
<a name="l00495"></a>00495                     cPacket *msg;
<a name="l00496"></a>00496                     <span class="keywordflow">while</span> ((msg=<a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#abfb833d10d529c1f9fda7d09e3616699">extractBytesUpTo</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>))!=NULL)
<a name="l00497"></a>00497                     {
<a name="l00498"></a>00498                         msg-&gt;setKind(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba78bce3d41e158816c5212ed2fc959b06">TCP_I_DATA</a>);  <span class="comment">// TBD currently we never send TCP_I_URGENT_DATA</span>
<a name="l00499"></a>00499                         <a class="code" href="class_t_c_p_command.html">TCPCommand</a> *cmd = <span class="keyword">new</span> <a class="code" href="class_t_c_p_command.html">TCPCommand</a>();
<a name="l00500"></a>00500                         cmd-&gt;<a class="code" href="class_t_c_p_command.html#a2688defdcadd3de43faae9c27748be24">setConnId</a>(<a class="code" href="class_t_c_p_connection.html#a6fee1d63c934294942e34b17a92d2fd5">connId</a>);
<a name="l00501"></a>00501                         msg-&gt;setControlInfo(cmd);
<a name="l00502"></a>00502                         <a class="code" href="class_t_c_p_connection.html#a6aa48826843116a0f5c4e0fa37a69cfc">sendToApp</a>(msg);
<a name="l00503"></a>00503                     }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505                     <span class="comment">// if this segment &quot;filled the gap&quot; until the previously arrived segment</span>
<a name="l00506"></a>00506                     <span class="comment">// that carried a FIN (i.e.rcv_nxt==rcv_fin_seq), we have to advance</span>
<a name="l00507"></a>00507                     <span class="comment">// rcv_nxt over the FIN.</span>
<a name="l00508"></a>00508                     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a32121c2fcf9d110150db1588cafa595a">fin_rcvd</a> &amp;&amp; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1259e7450282a5b49755ea64b538a724">rcv_fin_seq</a>)
<a name="l00509"></a>00509                     {
<a name="l00510"></a>00510                         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>; <span class="comment">// although not mentioned in [Stevens, W.R.: TCP/IP Illustrated, Volume 2, page 861] seems like we have to set ack_now</span>
<a name="l00511"></a>00511                         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;All segments arrived up to the FIN segment, advancing rcv_nxt over the FIN\n&quot;</span>;
<a name="l00512"></a>00512                         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1259e7450282a5b49755ea64b538a724">rcv_fin_seq</a>+1;
<a name="l00513"></a>00513                         <span class="comment">// state transitions will be done in the state machine, here we just set</span>
<a name="l00514"></a>00514                         <span class="comment">// the proper event code (TCP_E_RCV_FIN or TCP_E_RCV_FIN_ACK)</span>
<a name="l00515"></a>00515                         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ead4c5a9bfbaf2accb23697809655f2e32">TCP_E_RCV_FIN</a>;
<a name="l00516"></a>00516                         <span class="keywordflow">switch</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l00517"></a>00517                         {
<a name="l00518"></a>00518                             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a>:
<a name="l00519"></a>00519                                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac70666b0903dcc4bb0c76e4e3ddd64cd">fin_ack_rcvd</a>)
<a name="l00520"></a>00520                                 {
<a name="l00521"></a>00521                                     <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea9b1f9ceb96465850b379c784bb4d66c0">TCP_E_RCV_FIN_ACK</a>;
<a name="l00522"></a>00522                                     <span class="comment">// start the time-wait timer, turn off the other timers</span>
<a name="l00523"></a>00523                                     <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#ab5a1fb22c64b7f9edd700721bdec1d20">finWait2Timer</a>);
<a name="l00524"></a>00524                                     <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526                                     <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00527"></a>00527                                     <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00528"></a>00528                                     <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00529"></a>00529                                 }
<a name="l00530"></a>00530                                 <span class="keywordflow">break</span>;
<a name="l00531"></a>00531                             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>:
<a name="l00532"></a>00532                                 <span class="comment">// Start the time-wait timer, turn off the other timers.</span>
<a name="l00533"></a>00533                                 <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#ab5a1fb22c64b7f9edd700721bdec1d20">finWait2Timer</a>);
<a name="l00534"></a>00534                                 <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00535"></a>00535 
<a name="l00536"></a>00536                                 <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00537"></a>00537                                 <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00538"></a>00538                                 <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00539"></a>00539                                 <span class="keywordflow">break</span>;
<a name="l00540"></a>00540                             <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>:
<a name="l00541"></a>00541                                 <span class="comment">// Restart the 2 MSL time-wait timeout.</span>
<a name="l00542"></a>00542                                 <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>);
<a name="l00543"></a>00543                                 <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00544"></a>00544                                 <span class="keywordflow">break</span>;
<a name="l00545"></a>00545                         }
<a name="l00546"></a>00546                         <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba98ff9f82c08b1d7ae58049835c47368a">TCP_I_PEER_CLOSED</a>);
<a name="l00547"></a>00547                     }
<a name="l00548"></a>00548                 }
<a name="l00549"></a>00549             }
<a name="l00550"></a>00550             <span class="keywordflow">else</span>    <span class="comment">// not enough freeRcvBuffer in rcvQueue for new segment</span>
<a name="l00551"></a>00551             {
<a name="l00552"></a>00552                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>++; <span class="comment">// update current number of tcp receive queue drops</span>
<a name="l00553"></a>00553                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>)
<a name="l00554"></a>00554                     <a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>);
<a name="l00555"></a>00555 
<a name="l00556"></a>00556                 <span class="comment">// if the ACK bit is off drop the segment and return</span>
<a name="l00557"></a>00557                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RcvQueueBuffer has run out, dropping segment\n&quot;</span>;
<a name="l00558"></a>00558                 <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00559"></a>00559             }
<a name="l00560"></a>00560         }
<a name="l00561"></a>00561     }
<a name="l00562"></a>00562 
<a name="l00563"></a>00563     <span class="comment">//</span>
<a name="l00564"></a>00564     <span class="comment">// RFC 793: eighth, check the FIN bit,</span>
<a name="l00565"></a>00565     <span class="comment">//</span>
<a name="l00566"></a>00566     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00567"></a>00567     {
<a name="l00568"></a>00568         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570         <span class="comment">//&quot;</span>
<a name="l00571"></a>00571         <span class="comment">// If the FIN bit is set, signal the user &quot;connection closing&quot; and</span>
<a name="l00572"></a>00572         <span class="comment">// return any pending RECEIVEs with same message, advance RCV.NXT</span>
<a name="l00573"></a>00573         <span class="comment">// over the FIN, and send an acknowledgment for the FIN.  Note that</span>
<a name="l00574"></a>00574         <span class="comment">// FIN implies PUSH for any segment text not yet delivered to the</span>
<a name="l00575"></a>00575         <span class="comment">// user.</span>
<a name="l00576"></a>00576         <span class="comment">//&quot;</span>
<a name="l00577"></a>00577 
<a name="l00578"></a>00578         <span class="comment">// Note: seems like RFC 793 is not entirely correct here: if the</span>
<a name="l00579"></a>00579         <span class="comment">// segment is &quot;above sequence&quot; (ie. RCV.NXT &lt; SEG.SEQ), we cannot</span>
<a name="l00580"></a>00580         <span class="comment">// advance RCV.NXT over the FIN. Instead we remember this sequence</span>
<a name="l00581"></a>00581         <span class="comment">// number and do it later.</span>
<a name="l00582"></a>00582         uint32 fin_seq = (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00583"></a>00583         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>==fin_seq)
<a name="l00584"></a>00584         {
<a name="l00585"></a>00585             <span class="comment">// advance rcv_nxt over FIN now</span>
<a name="l00586"></a>00586             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;FIN arrived, advancing rcv_nxt over the FIN\n&quot;</span>;
<a name="l00587"></a>00587             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>++;
<a name="l00588"></a>00588             <span class="comment">// state transitions will be done in the state machine, here we just set</span>
<a name="l00589"></a>00589             <span class="comment">// the proper event code (TCP_E_RCV_FIN or TCP_E_RCV_FIN_ACK)</span>
<a name="l00590"></a>00590             <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ead4c5a9bfbaf2accb23697809655f2e32">TCP_E_RCV_FIN</a>;
<a name="l00591"></a>00591             <span class="keywordflow">switch</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l00592"></a>00592             {
<a name="l00593"></a>00593                 <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca2cf3a0cecd0eeeed17966b0c4f208964">TCP_S_FIN_WAIT_1</a>:
<a name="l00594"></a>00594                     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac70666b0903dcc4bb0c76e4e3ddd64cd">fin_ack_rcvd</a>)
<a name="l00595"></a>00595                     {
<a name="l00596"></a>00596                         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea9b1f9ceb96465850b379c784bb4d66c0">TCP_E_RCV_FIN_ACK</a>;
<a name="l00597"></a>00597                         <span class="comment">// start the time-wait timer, turn off the other timers</span>
<a name="l00598"></a>00598                         <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#ab5a1fb22c64b7f9edd700721bdec1d20">finWait2Timer</a>);
<a name="l00599"></a>00599                         <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00600"></a>00600 
<a name="l00601"></a>00601                         <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00602"></a>00602                         <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00603"></a>00603                         <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00604"></a>00604                     }
<a name="l00605"></a>00605                     <span class="keywordflow">break</span>;
<a name="l00606"></a>00606                 <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>:
<a name="l00607"></a>00607                     <span class="comment">// Start the time-wait timer, turn off the other timers.</span>
<a name="l00608"></a>00608                     <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#ab5a1fb22c64b7f9edd700721bdec1d20">finWait2Timer</a>);
<a name="l00609"></a>00609                     <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00610"></a>00610 
<a name="l00611"></a>00611                     <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00612"></a>00612                     <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00613"></a>00613                     <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00614"></a>00614                     <span class="keywordflow">break</span>;
<a name="l00615"></a>00615                 <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>:
<a name="l00616"></a>00616                     <span class="comment">// Restart the 2 MSL time-wait timeout.</span>
<a name="l00617"></a>00617                     <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>);
<a name="l00618"></a>00618                     <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a0ea0361f0b40f10bc9a3ce397b2c0e2f">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00619"></a>00619                     <span class="keywordflow">break</span>;
<a name="l00620"></a>00620             }
<a name="l00621"></a>00621             <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba98ff9f82c08b1d7ae58049835c47368a">TCP_I_PEER_CLOSED</a>);
<a name="l00622"></a>00622         }
<a name="l00623"></a>00623         <span class="keywordflow">else</span>
<a name="l00624"></a>00624         {
<a name="l00625"></a>00625             <span class="comment">// we&apos;ll have to do it later (when an arriving segment &quot;fills the gap&quot;)</span>
<a name="l00626"></a>00626             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;FIN segment above sequence, storing sequence number of FIN\n&quot;</span>;
<a name="l00627"></a>00627             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a32121c2fcf9d110150db1588cafa595a">fin_rcvd</a> = <span class="keyword">true</span>;
<a name="l00628"></a>00628             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1259e7450282a5b49755ea64b538a724">rcv_fin_seq</a> = fin_seq;
<a name="l00629"></a>00629         }
<a name="l00630"></a>00630 
<a name="l00631"></a>00631         <span class="comment">// TBD do PUSH stuff</span>
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">if</span> (old_rcv_nxt!=<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>)
<a name="l00635"></a>00635     {
<a name="l00636"></a>00636         <span class="comment">// if rcv_nxt changed, either because we received segment text or we</span>
<a name="l00637"></a>00637         <span class="comment">// received a FIN that needs to be acked (or both), we need to send or</span>
<a name="l00638"></a>00638         <span class="comment">// schedule an ACK.</span>
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a>)
<a name="l00641"></a>00641         {
<a name="l00642"></a>00642             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#a906163ab3363c8f66c60371e61e3fef6">getQueueLength</a>()!=0)
<a name="l00643"></a>00643             {
<a name="l00644"></a>00644                 <span class="comment">// RFC 2018, page 4:</span>
<a name="l00645"></a>00645                 <span class="comment">// &quot;If sent at all, SACK options SHOULD be included in all ACKs which do</span>
<a name="l00646"></a>00646                 <span class="comment">// not ACK the highest sequence number in the data receiver&apos;s queue.&quot;</span>
<a name="l00647"></a>00647                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#aa65590b4103c7d29454d8ea5b3a781c0">start_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00648"></a>00648                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ab59f15cb0300b2bb025186468e7a03a5">end_seqno</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00649"></a>00649                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ad03a121385224b940565040fe9eb433a">snd_sack</a> = <span class="keyword">true</span>;
<a name="l00650"></a>00650                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SND_SACK SET (rcv_nxt changed, but rexmitQ is not empty)\n&quot;</span>;
<a name="l00651"></a>00651                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>; <span class="comment">// although not mentioned in [Stevens, W.R.: TCP/IP Illustrated, Volume 2, page 861] seems like we have to set ack_now</span>
<a name="l00652"></a>00652             }
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655         <span class="comment">// tcpAlgorithm decides when and how to do ACKs</span>
<a name="l00656"></a>00656         <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#abb6b842fa0651f13c99b30adebcc0e03">receiveSeqChanged</a>();
<a name="l00657"></a>00657     }
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="keywordflow">if</span> ((<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaa8c5be2b3d7977abc27dfc396001f467">TCP_S_ESTABLISHED</a> || <a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a>) &amp;&amp;
<a name="l00660"></a>00660         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0401bd2db76f20ea6141550db9ae4d61">send_fin</a> &amp;&amp; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a20daa063530e578155124d9f9e4626f0">snd_fin_seq</a>+1)
<a name="l00661"></a>00661     {
<a name="l00662"></a>00662         <span class="comment">// if the user issued the CLOSE command a long time ago and we&apos;ve just</span>
<a name="l00663"></a>00663         <span class="comment">// managed to send off FIN, we simulate a CLOSE command now (we had to</span>
<a name="l00664"></a>00664         <span class="comment">// defer it at that time because we still had data in the send queue.)</span>
<a name="l00665"></a>00665         <span class="comment">// This CLOSE will take us into the FIN_WAIT_1 state.</span>
<a name="l00666"></a>00666         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Now we can do the CLOSE which was deferred a while ago\n&quot;</span>;
<a name="l00667"></a>00667         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf537925659bfd1160ec2e37e0293c9cf">TCP_E_CLOSE</a>;
<a name="l00668"></a>00668     }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()==<a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca077a72ba910cb22c3a4139dd0a4c3107">TCP_S_CLOSE_WAIT</a> &amp;&amp; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0401bd2db76f20ea6141550db9ae4d61">send_fin</a> &amp;&amp;
<a name="l00671"></a>00671         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a20daa063530e578155124d9f9e4626f0">snd_fin_seq</a>+1 &amp;&amp; old_snd_nxt!=<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>)
<a name="l00672"></a>00672     {
<a name="l00673"></a>00673         <span class="comment">// if we&apos;re in CLOSE_WAIT and we just got to sent our long-pending FIN,</span>
<a name="l00674"></a>00674         <span class="comment">// we simulate a CLOSE command now (we had to defer it at that time because</span>
<a name="l00675"></a>00675         <span class="comment">// we still had data in the send queue.) This CLOSE will take us into the</span>
<a name="l00676"></a>00676         <span class="comment">// LAST_ACK state.</span>
<a name="l00677"></a>00677         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Now we can do the CLOSE which was deferred a while ago\n&quot;</span>;
<a name="l00678"></a>00678         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf537925659bfd1160ec2e37e0293c9cf">TCP_E_CLOSE</a>;
<a name="l00679"></a>00679     }
<a name="l00680"></a>00680 
<a name="l00681"></a>00681     <span class="keywordflow">return</span> event;
<a name="l00682"></a>00682 }
<a name="l00683"></a>00683 
<a name="l00684"></a>00684 <span class="comment">//----</span>
<a name="l00685"></a>00685 
<a name="l00686"></a><a class="code" href="class_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">00686</a> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <a class="code" href="class_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">TCPConnection::processSegmentInListen</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00687"></a>00687 {
<a name="l00688"></a>00688     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment in LISTEN\n&quot;</span>;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690     <span class="comment">//&quot;</span>
<a name="l00691"></a>00691     <span class="comment">// first check for an RST</span>
<a name="l00692"></a>00692     <span class="comment">//   An incoming RST should be ignored.  Return.</span>
<a name="l00693"></a>00693     <span class="comment">//&quot;</span>
<a name="l00694"></a>00694     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00695"></a>00695     {
<a name="l00696"></a>00696         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST bit set: dropping segment\n&quot;</span>;
<a name="l00697"></a>00697         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00698"></a>00698     }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment">//&quot;</span>
<a name="l00701"></a>00701     <span class="comment">// second check for an ACK</span>
<a name="l00702"></a>00702     <span class="comment">//    Any acknowledgment is bad if it arrives on a connection still in</span>
<a name="l00703"></a>00703     <span class="comment">//    the LISTEN state.  An acceptable reset segment should be formed</span>
<a name="l00704"></a>00704     <span class="comment">//    for any arriving ACK-bearing segment.  The RST should be</span>
<a name="l00705"></a>00705     <span class="comment">//    formatted as follows:</span>
<a name="l00706"></a>00706     <span class="comment">//</span>
<a name="l00707"></a>00707     <span class="comment">//      &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00708"></a>00708     <span class="comment">//</span>
<a name="l00709"></a>00709     <span class="comment">//    Return.</span>
<a name="l00710"></a>00710     <span class="comment">//&quot;</span>
<a name="l00711"></a>00711     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00712"></a>00712     {
<a name="l00713"></a>00713         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set: dropping segment and sending RST\n&quot;</span>;
<a name="l00714"></a>00714         <a class="code" href="class_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00715"></a>00715         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00716"></a>00716     }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718     <span class="comment">//&quot;</span>
<a name="l00719"></a>00719     <span class="comment">// third check for a SYN</span>
<a name="l00720"></a>00720     <span class="comment">//&quot;</span>
<a name="l00721"></a>00721     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00722"></a>00722     {
<a name="l00723"></a>00723         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00724"></a>00724         {
<a name="l00725"></a>00725             <span class="comment">// Looks like implementations vary on how to react to SYN+FIN.</span>
<a name="l00726"></a>00726             <span class="comment">// Some treat it as plain SYN (and reply with SYN+ACK), some send RST+ACK.</span>
<a name="l00727"></a>00727             <span class="comment">// Let&apos;s just do the former here.</span>
<a name="l00728"></a>00728             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00729"></a>00729         }
<a name="l00730"></a>00730 
<a name="l00731"></a>00731         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN bit set: filling in foreign socket and sending SYN+ACK\n&quot;</span>;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733         <span class="comment">//&quot;</span>
<a name="l00734"></a>00734         <span class="comment">// If the listen was not fully specified (i.e., the foreign socket was not</span>
<a name="l00735"></a>00735         <span class="comment">// fully specified), then the unspecified fields should be filled in now.</span>
<a name="l00736"></a>00736         <span class="comment">//&quot;</span>
<a name="l00737"></a>00737         <span class="comment">//</span>
<a name="l00738"></a>00738         <span class="comment">// Also, we may need to fork, in order to leave another connection</span>
<a name="l00739"></a>00739         <span class="comment">// LISTENing on the port. Note: forking will change our connId.</span>
<a name="l00740"></a>00740         <span class="comment">//</span>
<a name="l00741"></a>00741         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8762f606d8dd51286d61ebbe833df932">fork</a>)
<a name="l00742"></a>00742         {
<a name="l00743"></a>00743             <a class="code" href="class_t_c_p_connection.html">TCPConnection</a> *conn = <a class="code" href="class_t_c_p_connection.html#a1d5624dcbc77e79d142f6a886b3e788d">cloneListeningConnection</a>(); <span class="comment">// &quot;conn&quot; is the clone which will stay LISTENing, while &quot;this&quot; gets updated with the remote address</span>
<a name="l00744"></a>00744             <a class="code" href="class_t_c_p_connection.html#ae74f100a2d121edee4b0e167596b8ac5">tcpMain</a>-&gt;<a class="code" href="class_t_c_p.html#abec1cedad1e72a349f7bd804501584fa">addForkedConnection</a>(<span class="keyword">this</span>, conn, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00745"></a>00745             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Connection forked: this connection got new connId=&quot;</span> &lt;&lt; <a class="code" href="class_t_c_p_connection.html#a6fee1d63c934294942e34b17a92d2fd5">connId</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00746"></a>00746                 <span class="stringliteral">&quot;spinoff keeps LISTENing with connId=&quot;</span> &lt;&lt; conn-&gt;<a class="code" href="class_t_c_p_connection.html#a6fee1d63c934294942e34b17a92d2fd5">connId</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00747"></a>00747         }
<a name="l00748"></a>00748         <span class="keywordflow">else</span>
<a name="l00749"></a>00749         {
<a name="l00750"></a>00750             <a class="code" href="class_t_c_p_connection.html#ae74f100a2d121edee4b0e167596b8ac5">tcpMain</a>-&gt;<a class="code" href="class_t_c_p.html#a89cade3eb3a3f44ffae57c08dedd9285">updateSockPair</a>(<span class="keyword">this</span>, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00751"></a>00751         }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753         <span class="comment">//&quot;</span>
<a name="l00754"></a>00754         <span class="comment">//  Set RCV.NXT to SEG.SEQ+1, IRS is set to SEG.SEQ and any other</span>
<a name="l00755"></a>00755         <span class="comment">//  control or text should be queued for processing later.  ISS</span>
<a name="l00756"></a>00756         <span class="comment">//  should be selected and a SYN segment sent of the form:</span>
<a name="l00757"></a>00757         <span class="comment">//</span>
<a name="l00758"></a>00758         <span class="comment">//    &lt;SEQ=ISS&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=SYN,ACK&gt;</span>
<a name="l00759"></a>00759         <span class="comment">//</span>
<a name="l00760"></a>00760         <span class="comment">//  SND.NXT is set to ISS+1 and SND.UNA to ISS.  The connection</span>
<a name="l00761"></a>00761         <span class="comment">//  state should be changed to SYN-RECEIVED.</span>
<a name="l00762"></a>00762         <span class="comment">//&quot;</span>
<a name="l00763"></a>00763         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()+1;
<a name="l00764"></a>00764         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3ff9c29dc3db01ad50308f6e0f917cb3">rcv_adv</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> + <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#aad67fe91f8983d1769877b559a0e9d00">rcv_wnd</a>;
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a985637bb70c925f74fa6ad8bb53af0d0">rcvAdvVector</a>) <a class="code" href="class_t_c_p_connection.html#a985637bb70c925f74fa6ad8bb53af0d0">rcvAdvVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3ff9c29dc3db01ad50308f6e0f917cb3">rcv_adv</a>);
<a name="l00766"></a>00766         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3263aa617c113523e9459db081cf3208">irs</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00767"></a>00767         <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#aa830dbb0737de38e3a564aaa806ea99f">init</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>);   <span class="comment">// FIXME may init twice...</span>
<a name="l00768"></a>00768         <a class="code" href="class_t_c_p_connection.html#a585bbcdd70565eb01b6bfe17a1487c78">selectInitialSeqNum</a>();
<a name="l00769"></a>00769 
<a name="l00770"></a>00770         <span class="comment">// although not mentioned in RFC 793, seems like we have to pick up</span>
<a name="l00771"></a>00771         <span class="comment">// initial snd_wnd from the segment here.</span>
<a name="l00772"></a>00772         <a class="code" href="class_t_c_p_connection.html#af1daa72bce81fcdc2cb7ccb03c134b7b">updateWndInfo</a>(tcpseg, <span class="keyword">true</span>);
<a name="l00773"></a>00773 
<a name="l00774"></a>00774         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a86df3be69e394a9e805013810c4df1ba">getHeaderLength</a>() &gt; <a class="code" href="_t_c_p_segment__m_8h.html#a77315d68700647283fc64814a5862090">TCP_HEADER_OCTETS</a>) <span class="comment">// Header options present? TCP_HEADER_OCTETS = 20</span>
<a name="l00775"></a>00775             <a class="code" href="class_t_c_p_connection.html#a9a8bf987d5f32ecff2b85ba0f635f019">readHeaderOptions</a>(tcpseg);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>;
<a name="l00778"></a>00778         <a class="code" href="class_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>();
<a name="l00779"></a>00779         <a class="code" href="class_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">startSynRexmitTimer</a>();
<a name="l00780"></a>00780         <span class="keywordflow">if</span> (!<a class="code" href="class_t_c_p_connection.html#a93b66fc68b48870a93479aa0bf4ac773">connEstabTimer</a>-&gt;isScheduled())
<a name="l00781"></a>00781             <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#a93b66fc68b48870a93479aa0bf4ac773">connEstabTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a512458671be6d68703cc89178b0b35f0">TCP_TIMEOUT_CONN_ESTAB</a>);
<a name="l00782"></a>00782 
<a name="l00783"></a>00783         <span class="comment">//&quot;</span>
<a name="l00784"></a>00784         <span class="comment">// Note that any other incoming control or data (combined with SYN)</span>
<a name="l00785"></a>00785         <span class="comment">// will be processed in the SYN-RECEIVED state, but processing of SYN</span>
<a name="l00786"></a>00786         <span class="comment">// and ACK should not be repeated.</span>
<a name="l00787"></a>00787         <span class="comment">//&quot;</span>
<a name="l00788"></a>00788         <span class="comment">// We don&apos;t send text in SYN or SYN+ACK, but accept it. Otherwise</span>
<a name="l00789"></a>00789         <span class="comment">// there isn&apos;t much left to do: RST, SYN, ACK, FIN got processed already,</span>
<a name="l00790"></a>00790         <span class="comment">// so there&apos;s only URG and PSH left to handle.</span>
<a name="l00791"></a>00791         <span class="comment">//</span>
<a name="l00792"></a>00792         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00793"></a>00793         {
<a name="l00794"></a>00794             <a class="code" href="class_t_c_p_connection.html#ae25d720620d8fe927087e1af0692ed90">updateRcvQueueVars</a>();
<a name="l00795"></a>00795             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0a9bd82033191de60a5bc5b3915ba8ae">freeRcvBuffer</a> &gt;= tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()) <span class="comment">// enough freeRcvBuffer in rcvQueue for new segment?</span>
<a name="l00796"></a>00796             {
<a name="l00797"></a>00797                 <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#ac17c031fdec7aa75b656bf7e742a38d2">insertBytesFromSegment</a>(tcpseg);
<a name="l00798"></a>00798             }
<a name="l00799"></a>00799             <span class="keywordflow">else</span>    <span class="comment">// not enough freeRcvBuffer in rcvQueue for new segment</span>
<a name="l00800"></a>00800             {
<a name="l00801"></a>00801                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>++; <span class="comment">// update current number of tcp receive queue drops</span>
<a name="l00802"></a>00802                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>)
<a name="l00803"></a>00803                     <a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>);
<a name="l00804"></a>00804 
<a name="l00805"></a>00805                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RcvQueueBuffer has run out, dropping segment\n&quot;</span>;
<a name="l00806"></a>00806                 <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00807"></a>00807             }
<a name="l00808"></a>00808         }
<a name="l00809"></a>00809         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l00810"></a>00810             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l00811"></a>00811 
<a name="l00812"></a>00812         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea541f61a44292b46f1adaf374e22126a5">TCP_E_RCV_SYN</a>;  <span class="comment">// this will take us to SYN_RCVD</span>
<a name="l00813"></a>00813     }
<a name="l00814"></a>00814 
<a name="l00815"></a>00815     <span class="comment">//&quot;</span>
<a name="l00816"></a>00816     <span class="comment">//  fourth other text or control</span>
<a name="l00817"></a>00817     <span class="comment">//   So you are unlikely to get here, but if you do, drop the segment, and return.</span>
<a name="l00818"></a>00818     <span class="comment">//&quot;</span>
<a name="l00819"></a>00819     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Unexpected segment: dropping it\n&quot;</span>;
<a name="l00820"></a>00820     <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 
<a name="l00823"></a><a class="code" href="class_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">00823</a> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <a class="code" href="class_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">TCPConnection::processSegmentInSynSent</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00824"></a>00824 {
<a name="l00825"></a>00825     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment in SYN_SENT\n&quot;</span>;
<a name="l00826"></a>00826 
<a name="l00827"></a>00827     <span class="comment">//&quot;</span>
<a name="l00828"></a>00828     <span class="comment">// first check the ACK bit</span>
<a name="l00829"></a>00829     <span class="comment">//</span>
<a name="l00830"></a>00830     <span class="comment">//   If the ACK bit is set</span>
<a name="l00831"></a>00831     <span class="comment">//</span>
<a name="l00832"></a>00832     <span class="comment">//     If SEG.ACK =&lt; ISS, or SEG.ACK &gt; SND.NXT, send a reset (unless</span>
<a name="l00833"></a>00833     <span class="comment">//     the RST bit is set, if so drop the segment and return)</span>
<a name="l00834"></a>00834     <span class="comment">//</span>
<a name="l00835"></a>00835     <span class="comment">//       &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00836"></a>00836     <span class="comment">//</span>
<a name="l00837"></a>00837     <span class="comment">//     and discard the segment.  Return.</span>
<a name="l00838"></a>00838     <span class="comment">//</span>
<a name="l00839"></a>00839     <span class="comment">//     If SND.UNA =&lt; SEG.ACK =&lt; SND.NXT then the ACK is acceptable.</span>
<a name="l00840"></a>00840     <span class="comment">//&quot;</span>
<a name="l00841"></a>00841     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00842"></a>00842     {
<a name="l00843"></a>00843         <span class="keywordflow">if</span> (<a class="code" href="_t_c_p_connection_8h.html#a55ef269e8ae44948c1d1f1cbe14bc92b">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a68394945e99768afc131310ce6a37ea1">iss</a>) || <a class="code" href="_t_c_p_connection_8h.html#a459ac205bbda777389c12b7353227fbe">seqGreater</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>))
<a name="l00844"></a>00844         {
<a name="l00845"></a>00845             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set but wrong AckNo, sending RST\n&quot;</span>;
<a name="l00846"></a>00846             <a class="code" href="class_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00847"></a>00847             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00848"></a>00848         }
<a name="l00849"></a>00849         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set, AckNo acceptable\n&quot;</span>;
<a name="l00850"></a>00850     }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852     <span class="comment">//&quot;</span>
<a name="l00853"></a>00853     <span class="comment">// second check the RST bit</span>
<a name="l00854"></a>00854     <span class="comment">//</span>
<a name="l00855"></a>00855     <span class="comment">//   If the RST bit is set</span>
<a name="l00856"></a>00856     <span class="comment">//</span>
<a name="l00857"></a>00857     <span class="comment">//     If the ACK was acceptable then signal the user &quot;error:</span>
<a name="l00858"></a>00858     <span class="comment">//     connection reset&quot;, drop the segment, enter CLOSED state,</span>
<a name="l00859"></a>00859     <span class="comment">//     delete TCB, and return.  Otherwise (no ACK) drop the segment</span>
<a name="l00860"></a>00860     <span class="comment">//     and return.</span>
<a name="l00861"></a>00861     <span class="comment">//&quot;</span>
<a name="l00862"></a>00862     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00863"></a>00863     {
<a name="l00864"></a>00864         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00865"></a>00865         {
<a name="l00866"></a>00866             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST+ACK: performing connection reset\n&quot;</span>;
<a name="l00867"></a>00867             <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00868"></a>00868             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf96013e6e28c73e47277bb885fcf7aa6">TCP_E_RCV_RST</a>;
<a name="l00869"></a>00869         }
<a name="l00870"></a>00870         <span class="keywordflow">else</span>
<a name="l00871"></a>00871         {
<a name="l00872"></a>00872             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST without ACK: dropping segment\n&quot;</span>;
<a name="l00873"></a>00873             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00874"></a>00874         }
<a name="l00875"></a>00875     }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877     <span class="comment">//&quot;</span>
<a name="l00878"></a>00878     <span class="comment">// third check the security and precedence -- not done</span>
<a name="l00879"></a>00879     <span class="comment">//</span>
<a name="l00880"></a>00880     <span class="comment">// fourth check the SYN bit</span>
<a name="l00881"></a>00881     <span class="comment">//</span>
<a name="l00882"></a>00882     <span class="comment">//   This step should be reached only if the ACK is ok, or there is</span>
<a name="l00883"></a>00883     <span class="comment">//   no ACK, and it the segment did not contain a RST.</span>
<a name="l00884"></a>00884     <span class="comment">//</span>
<a name="l00885"></a>00885     <span class="comment">//   If the SYN bit is on and the security/compartment and precedence</span>
<a name="l00886"></a>00886     <span class="comment">//   are acceptable then,</span>
<a name="l00887"></a>00887     <span class="comment">//&quot;</span>
<a name="l00888"></a>00888     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00889"></a>00889     {
<a name="l00890"></a>00890         <span class="comment">//</span>
<a name="l00891"></a>00891         <span class="comment">//   RCV.NXT is set to SEG.SEQ+1, IRS is set to</span>
<a name="l00892"></a>00892         <span class="comment">//   SEG.SEQ.  SND.UNA should be advanced to equal SEG.ACK (if there</span>
<a name="l00893"></a>00893         <span class="comment">//   is an ACK), and any segments on the retransmission queue which</span>
<a name="l00894"></a>00894         <span class="comment">//   are thereby acknowledged should be removed.</span>
<a name="l00895"></a>00895         <span class="comment">//</span>
<a name="l00896"></a>00896         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()+1;
<a name="l00897"></a>00897         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3ff9c29dc3db01ad50308f6e0f917cb3">rcv_adv</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a> + <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#aad67fe91f8983d1769877b559a0e9d00">rcv_wnd</a>;
<a name="l00898"></a>00898         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a985637bb70c925f74fa6ad8bb53af0d0">rcvAdvVector</a>) <a class="code" href="class_t_c_p_connection.html#a985637bb70c925f74fa6ad8bb53af0d0">rcvAdvVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3ff9c29dc3db01ad50308f6e0f917cb3">rcv_adv</a>);
<a name="l00899"></a>00899         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3263aa617c113523e9459db081cf3208">irs</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00900"></a>00900         <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#aa830dbb0737de38e3a564aaa806ea99f">init</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a5b9de18a3fb71fab5a540f98173b12b1">rcv_nxt</a>);
<a name="l00901"></a>00901 
<a name="l00902"></a>00902         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00903"></a>00903         {
<a name="l00904"></a>00904             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l00905"></a>00905             <a class="code" href="class_t_c_p_connection.html#a0dec48343ab1df2cc4157a3da114f54e">sendQueue</a>-&gt;<a class="code" href="class_t_c_p_send_queue.html#ae04471092e8ddf943c8c938ef1aa9c9f">discardUpTo</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>);
<a name="l00906"></a>00906             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a>)
<a name="l00907"></a>00907                 <a class="code" href="class_t_c_p_connection.html#a7de9df6b234a7dabb5b5e7eb7520734d">rexmitQueue</a>-&gt;<a class="code" href="class_t_c_p_s_a_c_k_rexmit_queue.html#a07b77209c59eb50fce9751418039ed64">discardUpTo</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>);
<a name="l00908"></a>00908 
<a name="l00909"></a>00909             <span class="comment">// although not mentioned in RFC 793, seems like we have to pick up</span>
<a name="l00910"></a>00910             <span class="comment">// initial snd_wnd from the segment here.</span>
<a name="l00911"></a>00911             <a class="code" href="class_t_c_p_connection.html#af1daa72bce81fcdc2cb7ccb03c134b7b">updateWndInfo</a>(tcpseg, <span class="keyword">true</span>);
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         <span class="comment">// this also seems to be a good time to learn our local IP address</span>
<a name="l00915"></a>00915         <span class="comment">// (was probably unspecified at connection open)</span>
<a name="l00916"></a>00916         <a class="code" href="class_t_c_p_connection.html#ae74f100a2d121edee4b0e167596b8ac5">tcpMain</a>-&gt;<a class="code" href="class_t_c_p.html#a89cade3eb3a3f44ffae57c08dedd9285">updateSockPair</a>(<span class="keyword">this</span>, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00917"></a>00917 
<a name="l00918"></a>00918         <span class="comment">//&quot;</span>
<a name="l00919"></a>00919         <span class="comment">//   If SND.UNA &gt; ISS (our SYN has been ACKed), change the connection</span>
<a name="l00920"></a>00920         <span class="comment">//   state to ESTABLISHED, form an ACK segment</span>
<a name="l00921"></a>00921         <span class="comment">//</span>
<a name="l00922"></a>00922         <span class="comment">//     &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00923"></a>00923         <span class="comment">//</span>
<a name="l00924"></a>00924         <span class="comment">//   and send it.  Data or controls which were queued for</span>
<a name="l00925"></a>00925         <span class="comment">//   transmission may be included.  If there are other controls or</span>
<a name="l00926"></a>00926         <span class="comment">//   text in the segment then continue processing at the sixth step</span>
<a name="l00927"></a>00927         <span class="comment">//   below where the URG bit is checked, otherwise return.</span>
<a name="l00928"></a>00928         <span class="comment">//&quot;</span>
<a name="l00929"></a>00929         <span class="keywordflow">if</span> (<a class="code" href="_t_c_p_connection_8h.html#a459ac205bbda777389c12b7353227fbe">seqGreater</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>, <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a68394945e99768afc131310ce6a37ea1">iss</a>))
<a name="l00930"></a>00930         {
<a name="l00931"></a>00931             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+ACK bits set, connection established.\n&quot;</span>;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933             <span class="comment">// RFC says &quot;continue processing at the sixth step below where</span>
<a name="l00934"></a>00934             <span class="comment">// the URG bit is checked&quot;. Those steps deal with: URG, segment text</span>
<a name="l00935"></a>00935             <span class="comment">// (and PSH), and FIN.</span>
<a name="l00936"></a>00936             <span class="comment">// Now: URG and PSH we don&apos;t support yet; in SYN+FIN we ignore FIN;</span>
<a name="l00937"></a>00937             <span class="comment">// with segment text we just take it easy and put it in the receiveQueue</span>
<a name="l00938"></a>00938             <span class="comment">// -- we&apos;ll forward it to the user when more data arrives.</span>
<a name="l00939"></a>00939             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00940"></a>00940                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+ACK+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00941"></a>00941             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00942"></a>00942             {
<a name="l00943"></a>00943                 <a class="code" href="class_t_c_p_connection.html#ae25d720620d8fe927087e1af0692ed90">updateRcvQueueVars</a>();
<a name="l00944"></a>00944                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0a9bd82033191de60a5bc5b3915ba8ae">freeRcvBuffer</a> &gt;= tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()) <span class="comment">// enough freeRcvBuffer in rcvQueue for new segment?</span>
<a name="l00945"></a>00945                 {
<a name="l00946"></a>00946                     <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#ac17c031fdec7aa75b656bf7e742a38d2">insertBytesFromSegment</a>(tcpseg);  <span class="comment">// TBD forward to app, etc.</span>
<a name="l00947"></a>00947                 }
<a name="l00948"></a>00948                 <span class="keywordflow">else</span>    <span class="comment">// not enough freeRcvBuffer in rcvQueue for new segment</span>
<a name="l00949"></a>00949                 {
<a name="l00950"></a>00950                     <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>++; <span class="comment">// update current number of tcp receive queue drops</span>
<a name="l00951"></a>00951                     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>)
<a name="l00952"></a>00952                         <a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RcvQueueBuffer has run out, dropping segment\n&quot;</span>;
<a name="l00955"></a>00955                     <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l00956"></a>00956                 }
<a name="l00957"></a>00957             }
<a name="l00958"></a>00958             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l00959"></a>00959                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN+ACK\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l00960"></a>00960 
<a name="l00961"></a>00961             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a86df3be69e394a9e805013810c4df1ba">getHeaderLength</a>() &gt; <a class="code" href="_t_c_p_segment__m_8h.html#a77315d68700647283fc64814a5862090">TCP_HEADER_OCTETS</a>) <span class="comment">// Header options present? TCP_HEADER_OCTETS = 20</span>
<a name="l00962"></a>00962                 <a class="code" href="class_t_c_p_connection.html#a9a8bf987d5f32ecff2b85ba0f635f019">readHeaderOptions</a>(tcpseg);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964             <span class="comment">// notify tcpAlgorithm (it has to send ACK of SYN) and app layer</span>
<a name="l00965"></a>00965             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac945d97e6a37246ca8cf3648e01a8a26">ack_now</a> = <span class="keyword">true</span>;
<a name="l00966"></a>00966             <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#a2d051b6a9e2a9fccfa6f8b64bb8c647d">established</a>(<span class="keyword">true</span>);
<a name="l00967"></a>00967             <a class="code" href="class_t_c_p_connection.html#ab04a91abde05d21293c30a78ab968eef">sendEstabIndicationToApp</a>();
<a name="l00968"></a>00968 
<a name="l00969"></a>00969             <span class="comment">// This will trigger transition to ESTABLISHED. Timers and notifying</span>
<a name="l00970"></a>00970             <span class="comment">// app will be taken care of in stateEntered().</span>
<a name="l00971"></a>00971             <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea8458ff8c0f604c80aa5aa6ee49f850c3">TCP_E_RCV_SYN_ACK</a>;
<a name="l00972"></a>00972         }
<a name="l00973"></a>00973 
<a name="l00974"></a>00974         <span class="comment">//&quot;</span>
<a name="l00975"></a>00975         <span class="comment">//   Otherwise enter SYN-RECEIVED, form a SYN,ACK segment</span>
<a name="l00976"></a>00976         <span class="comment">//</span>
<a name="l00977"></a>00977         <span class="comment">//     &lt;SEQ=ISS&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=SYN,ACK&gt;</span>
<a name="l00978"></a>00978         <span class="comment">//</span>
<a name="l00979"></a>00979         <span class="comment">//   and send it.  If there are other controls or text in the</span>
<a name="l00980"></a>00980         <span class="comment">//   segment, queue them for processing after the ESTABLISHED state</span>
<a name="l00981"></a>00981         <span class="comment">//   has been reached, return.</span>
<a name="l00982"></a>00982         <span class="comment">//&quot;</span>
<a name="l00983"></a>00983         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN bit set: sending SYN+ACK\n&quot;</span>;
<a name="l00984"></a>00984         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a68394945e99768afc131310ce6a37ea1">iss</a>;
<a name="l00985"></a>00985         <a class="code" href="class_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>();
<a name="l00986"></a>00986         <a class="code" href="class_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">startSynRexmitTimer</a>();
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <span class="comment">// Note: code below is similar to processing SYN in LISTEN.</span>
<a name="l00989"></a>00989 
<a name="l00990"></a>00990         <span class="comment">// For consistency with that code, we ignore SYN+FIN here</span>
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00992"></a>00992             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         <span class="comment">// We don&apos;t send text in SYN or SYN+ACK, but accept it. Otherwise</span>
<a name="l00995"></a>00995         <span class="comment">// there isn&apos;t much left to do: RST, SYN, ACK, FIN got processed already,</span>
<a name="l00996"></a>00996         <span class="comment">// so there&apos;s only URG and PSH left to handle.</span>
<a name="l00997"></a>00997         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00998"></a>00998         {
<a name="l00999"></a>00999             <a class="code" href="class_t_c_p_connection.html#ae25d720620d8fe927087e1af0692ed90">updateRcvQueueVars</a>();
<a name="l01000"></a>01000             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0a9bd82033191de60a5bc5b3915ba8ae">freeRcvBuffer</a> &gt;= tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()) <span class="comment">// enough freeRcvBuffer in rcvQueue for new segment?</span>
<a name="l01001"></a>01001             {
<a name="l01002"></a>01002                 <a class="code" href="class_t_c_p_connection.html#a1f9a74ed0fae5b105a1a1cfb2bab9006">receiveQueue</a>-&gt;<a class="code" href="class_t_c_p_receive_queue.html#ac17c031fdec7aa75b656bf7e742a38d2">insertBytesFromSegment</a>(tcpseg);  <span class="comment">// TBD forward to app, etc.</span>
<a name="l01003"></a>01003             }
<a name="l01004"></a>01004             <span class="keywordflow">else</span>    <span class="comment">// not enough freeRcvBuffer in rcvQueue for new segment</span>
<a name="l01005"></a>01005             {
<a name="l01006"></a>01006                 <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>++; <span class="comment">// update current number of tcp receive queue drops</span>
<a name="l01007"></a>01007                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>)
<a name="l01008"></a>01008                     <a class="code" href="class_t_c_p_connection.html#ad24c6dbc6d3b7e143ca4fc180092aa6b">tcpRcvQueueDropsVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47f5ceae81f976297ea36112eb36c133">tcpRcvQueueDrops</a>);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RcvQueueBuffer has run out, dropping segment\n&quot;</span>;
<a name="l01011"></a>01011                 <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l01012"></a>01012             }
<a name="l01013"></a>01013         }
<a name="l01014"></a>01014         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l01015"></a>01015             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l01016"></a>01016 
<a name="l01017"></a>01017         <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea541f61a44292b46f1adaf374e22126a5">TCP_E_RCV_SYN</a>;
<a name="l01018"></a>01018     }
<a name="l01019"></a>01019 
<a name="l01020"></a>01020     <span class="comment">//&quot;</span>
<a name="l01021"></a>01021     <span class="comment">// fifth, if neither of the SYN or RST bits is set then drop the</span>
<a name="l01022"></a>01022     <span class="comment">// segment and return.</span>
<a name="l01023"></a>01023     <span class="comment">//&quot;</span>
<a name="l01024"></a>01024     <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea543beef056b1f7e1f0b341f615393f6a">TCP_E_IGNORE</a>;
<a name="l01025"></a>01025 }
<a name="l01026"></a>01026 
<a name="l01027"></a><a class="code" href="class_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">01027</a> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a> <a class="code" href="class_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">TCPConnection::processRstInSynReceived</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l01028"></a>01028 {
<a name="l01029"></a>01029     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing RST in SYN_RCVD\n&quot;</span>;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031     <span class="comment">//&quot;</span>
<a name="l01032"></a>01032     <span class="comment">// If this connection was initiated with a passive OPEN (i.e.,</span>
<a name="l01033"></a>01033     <span class="comment">// came from the LISTEN state), then return this connection to</span>
<a name="l01034"></a>01034     <span class="comment">// LISTEN state and return.  The user need not be informed.  If</span>
<a name="l01035"></a>01035     <span class="comment">// this connection was initiated with an active OPEN (i.e., came</span>
<a name="l01036"></a>01036     <span class="comment">// from SYN-SENT state) then the connection was refused, signal</span>
<a name="l01037"></a>01037     <span class="comment">// the user &quot;connection refused&quot;.  In either case, all segments</span>
<a name="l01038"></a>01038     <span class="comment">// on the retransmission queue should be removed.  And in the</span>
<a name="l01039"></a>01039     <span class="comment">// active OPEN case, enter the CLOSED state and delete the TCB,</span>
<a name="l01040"></a>01040     <span class="comment">// and return.</span>
<a name="l01041"></a>01041     <span class="comment">//&quot;</span>
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <a class="code" href="class_t_c_p_connection.html#a0dec48343ab1df2cc4157a3da114f54e">sendQueue</a>-&gt;<a class="code" href="class_t_c_p_send_queue.html#ae04471092e8ddf943c8c938ef1aa9c9f">discardUpTo</a>(<a class="code" href="class_t_c_p_connection.html#a0dec48343ab1df2cc4157a3da114f54e">sendQueue</a>-&gt;<a class="code" href="class_t_c_p_send_queue.html#a1bb1013e8a3df8d76598b1cf3a92246c">getBufferEndSeq</a>()); <span class="comment">// flush send queue</span>
<a name="l01044"></a>01044     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a>)
<a name="l01045"></a>01045         <a class="code" href="class_t_c_p_connection.html#a7de9df6b234a7dabb5b5e7eb7520734d">rexmitQueue</a>-&gt;<a class="code" href="class_t_c_p_s_a_c_k_rexmit_queue.html#a07b77209c59eb50fce9751418039ed64">discardUpTo</a>(<a class="code" href="class_t_c_p_connection.html#a7de9df6b234a7dabb5b5e7eb7520734d">rexmitQueue</a>-&gt;<a class="code" href="class_t_c_p_s_a_c_k_rexmit_queue.html#aab51c929cca62ab481aebf24ecaff747">getBufferEndSeq</a>()); <span class="comment">// flush rexmit queue</span>
<a name="l01046"></a>01046 
<a name="l01047"></a>01047     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a4341a40e233610fbf989e373e450a08d">active</a>)
<a name="l01048"></a>01048     {
<a name="l01049"></a>01049         <span class="comment">// signal &quot;connection refused&quot;</span>
<a name="l01050"></a>01050         <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba21824d5a95e3b86c41f35775bb5f23ab">TCP_I_CONNECTION_REFUSED</a>);
<a name="l01051"></a>01051     }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053     <span class="comment">// on RCV_RST, FSM will go either to LISTEN or to CLOSED, depending on state-&gt;active</span>
<a name="l01054"></a>01054     <span class="comment">// FIXME if this was a forked connection, it should rather close than go back to listening (otherwise we&apos;d now have two listening connections with the original one!)</span>
<a name="l01055"></a>01055     <span class="keywordflow">return</span> <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85eaf96013e6e28c73e47277bb885fcf7aa6">TCP_E_RCV_RST</a>;
<a name="l01056"></a>01056 }
<a name="l01057"></a>01057 
<a name="l01058"></a><a class="code" href="class_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">01058</a> <span class="keywordtype">bool</span> <a class="code" href="class_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">TCPConnection::processAckInEstabEtc</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l01059"></a>01059 {
<a name="l01060"></a>01060     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing ACK in a data transfer state\n&quot;</span>;
<a name="l01061"></a>01061 
<a name="l01062"></a>01062     <span class="comment">//</span>
<a name="l01063"></a>01063     <span class="comment">//&quot;</span>
<a name="l01064"></a>01064     <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT then, set SND.UNA &lt;- SEG.ACK.</span>
<a name="l01065"></a>01065     <span class="comment">//  Any segments on the retransmission queue which are thereby</span>
<a name="l01066"></a>01066     <span class="comment">//  entirely acknowledged are removed.  Users should receive</span>
<a name="l01067"></a>01067     <span class="comment">//  positive acknowledgments for buffers which have been SENT and</span>
<a name="l01068"></a>01068     <span class="comment">//  fully acknowledged (i.e., SEND buffer should be returned with</span>
<a name="l01069"></a>01069     <span class="comment">//  &quot;ok&quot; response).  If the ACK is a duplicate</span>
<a name="l01070"></a>01070     <span class="comment">//  (SEG.ACK &lt; SND.UNA), it can be ignored.  If the ACK acks</span>
<a name="l01071"></a>01071     <span class="comment">//  something not yet sent (SEG.ACK &gt; SND.NXT) then send an ACK,</span>
<a name="l01072"></a>01072     <span class="comment">//  drop the segment, and return.</span>
<a name="l01073"></a>01073     <span class="comment">//</span>
<a name="l01074"></a>01074     <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT, the send window should be</span>
<a name="l01075"></a>01075     <span class="comment">//  updated.  If (SND.WL1 &lt; SEG.SEQ or (SND.WL1 = SEG.SEQ and</span>
<a name="l01076"></a>01076     <span class="comment">//  SND.WL2 =&lt; SEG.ACK)), set SND.WND &lt;- SEG.WND, set</span>
<a name="l01077"></a>01077     <span class="comment">//  SND.WL1 &lt;- SEG.SEQ, and set SND.WL2 &lt;- SEG.ACK.</span>
<a name="l01078"></a>01078     <span class="comment">//</span>
<a name="l01079"></a>01079     <span class="comment">//  Note that SND.WND is an offset from SND.UNA, that SND.WL1</span>
<a name="l01080"></a>01080     <span class="comment">//  records the sequence number of the last segment used to update</span>
<a name="l01081"></a>01081     <span class="comment">//  SND.WND, and that SND.WL2 records the acknowledgment number of</span>
<a name="l01082"></a>01082     <span class="comment">//  the last segment used to update SND.WND.  The check here</span>
<a name="l01083"></a>01083     <span class="comment">//  prevents using old segments to update the window.</span>
<a name="l01084"></a>01084     <span class="comment">//&quot;</span>
<a name="l01085"></a>01085     <span class="comment">// Note: should use SND.MAX instead of SND.NXT in above checks</span>
<a name="l01086"></a>01086     <span class="comment">//</span>
<a name="l01087"></a>01087     <span class="keywordflow">if</span> (<a class="code" href="_t_c_p_connection_8h.html#af4745b9cf95eb5b78d8ae6c3c8429cfc">seqGE</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()))
<a name="l01088"></a>01088     {
<a name="l01089"></a>01089         <span class="comment">//</span>
<a name="l01090"></a>01090         <span class="comment">// duplicate ACK? A received TCP segment is a duplicate ACK if all of</span>
<a name="l01091"></a>01091         <span class="comment">// the following apply:</span>
<a name="l01092"></a>01092         <span class="comment">//    (1) snd_una==ackNo</span>
<a name="l01093"></a>01093         <span class="comment">//    (2) segment contains no data</span>
<a name="l01094"></a>01094         <span class="comment">//    (3) there&apos;s unacked data (snd_una!=snd_max)</span>
<a name="l01095"></a>01095         <span class="comment">//</span>
<a name="l01096"></a>01096         <span class="comment">// Note: ssfnet uses additional constraint &quot;window is the same as last</span>
<a name="l01097"></a>01097         <span class="comment">// received (not an update)&quot; -- we don&apos;t do that because window updates</span>
<a name="l01098"></a>01098         <span class="comment">// are ignored anyway if neither seqNo nor ackNo has changed.</span>
<a name="l01099"></a>01099         <span class="comment">//</span>
<a name="l01100"></a>01100         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>==tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>() &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()==0 &amp;&amp; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>!=<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a>)
<a name="l01101"></a>01101         {
<a name="l01102"></a>01102             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a>++;
<a name="l01103"></a>01103             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>)
<a name="l01104"></a>01104                 <a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a>);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106             <span class="comment">// we need to update send window even if the ACK is a dupACK, because rcv win could have been changed if faulty data receiver is not respecting the &quot;do not shrink window&quot; rule</span>
<a name="l01107"></a>01107             <a class="code" href="class_t_c_p_connection.html#af1daa72bce81fcdc2cb7ccb03c134b7b">updateWndInfo</a>(tcpseg);
<a name="l01108"></a>01108 
<a name="l01109"></a>01109             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a86df3be69e394a9e805013810c4df1ba">getHeaderLength</a>() &gt; <a class="code" href="_t_c_p_segment__m_8h.html#a77315d68700647283fc64814a5862090">TCP_HEADER_OCTETS</a>) <span class="comment">// Header options present? TCP_HEADER_OCTETS = 20</span>
<a name="l01110"></a>01110                 <a class="code" href="class_t_c_p_connection.html#a9a8bf987d5f32ecff2b85ba0f635f019">readHeaderOptions</a>(tcpseg);
<a name="l01111"></a>01111 
<a name="l01112"></a>01112             <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#a83a8916731ff5ce73e5d4f05d8ae6d30">receivedDuplicateAck</a>();
<a name="l01113"></a>01113         }
<a name="l01114"></a>01114         <span class="keywordflow">else</span>
<a name="l01115"></a>01115         {
<a name="l01116"></a>01116             <span class="comment">// if doesn&apos;t qualify as duplicate ACK, just ignore it.</span>
<a name="l01117"></a>01117             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()==0)
<a name="l01118"></a>01118             {
<a name="l01119"></a>01119                 <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>!=tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>())
<a name="l01120"></a>01120                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Old ACK: ackNo&lt;snd_una\n&quot;</span>;
<a name="l01121"></a>01121                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a>)
<a name="l01122"></a>01122                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK looks duplicate but we have currently no unacked data (snd_una==snd_max)\n&quot;</span>;
<a name="l01123"></a>01123             }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125             <span class="comment">// reset counter</span>
<a name="l01126"></a>01126             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a> = 0;
<a name="l01127"></a>01127             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>)
<a name="l01128"></a>01128                 <a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a>);
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130     }
<a name="l01131"></a>01131     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="_t_c_p_connection_8h.html#a55ef269e8ae44948c1d1f1cbe14bc92b">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(), <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a>))
<a name="l01132"></a>01132     {
<a name="l01133"></a>01133         <span class="comment">// ack in window.</span>
<a name="l01134"></a>01134         uint32 old_snd_una = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>;
<a name="l01135"></a>01135         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l01136"></a>01136         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a7cc325d99a5b02944a46c6a425fd01fc">unackedVector</a>) <a class="code" href="class_t_c_p_connection.html#a7cc325d99a5b02944a46c6a425fd01fc">unackedVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a> - <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>);
<a name="l01137"></a>01137 
<a name="l01138"></a>01138         <span class="comment">// after retransmitting a lost segment, we may get an ack well ahead of snd_nxt</span>
<a name="l01139"></a>01139         <span class="keywordflow">if</span> (<a class="code" href="_t_c_p_connection_8h.html#aa2e84a0093c6f222b12a4b443c7278eb">seqLess</a>(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a>, <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>))
<a name="l01140"></a>01140             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a8bd36330faab4393bbb4c56e89d140a1">snd_nxt</a> = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>;
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         uint32 discardUpToSeq = <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a3a8a7f455c793cf894e22d4d72dbdc93">snd_una</a>;
<a name="l01143"></a>01143 
<a name="l01144"></a>01144         <span class="comment">// our FIN acked?</span>
<a name="l01145"></a>01145         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a0401bd2db76f20ea6141550db9ae4d61">send_fin</a> &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()==<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a20daa063530e578155124d9f9e4626f0">snd_fin_seq</a>+1)
<a name="l01146"></a>01146         {
<a name="l01147"></a>01147             <span class="comment">// set flag that our FIN has been acked</span>
<a name="l01148"></a>01148             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK acks our FIN\n&quot;</span>;
<a name="l01149"></a>01149             <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ac70666b0903dcc4bb0c76e4e3ddd64cd">fin_ack_rcvd</a> = <span class="keyword">true</span>;
<a name="l01150"></a>01150             discardUpToSeq--; <span class="comment">// the FIN sequence number is not real data</span>
<a name="l01151"></a>01151         }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153         <span class="comment">// acked data no longer needed in send queue</span>
<a name="l01154"></a>01154         <a class="code" href="class_t_c_p_connection.html#a0dec48343ab1df2cc4157a3da114f54e">sendQueue</a>-&gt;<a class="code" href="class_t_c_p_send_queue.html#ae04471092e8ddf943c8c938ef1aa9c9f">discardUpTo</a>(discardUpToSeq);
<a name="l01155"></a>01155         <span class="comment">// acked data no longer needed in rexmit queue</span>
<a name="l01156"></a>01156         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a47c0467054bd0209efc992c63d5d4d04">sack_enabled</a>)
<a name="l01157"></a>01157             <a class="code" href="class_t_c_p_connection.html#a7de9df6b234a7dabb5b5e7eb7520734d">rexmitQueue</a>-&gt;<a class="code" href="class_t_c_p_s_a_c_k_rexmit_queue.html#a07b77209c59eb50fce9751418039ed64">discardUpTo</a>(discardUpToSeq);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159         <a class="code" href="class_t_c_p_connection.html#af1daa72bce81fcdc2cb7ccb03c134b7b">updateWndInfo</a>(tcpseg);
<a name="l01160"></a>01160 
<a name="l01161"></a>01161         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a86df3be69e394a9e805013810c4df1ba">getHeaderLength</a>() &gt; <a class="code" href="_t_c_p_segment__m_8h.html#a77315d68700647283fc64814a5862090">TCP_HEADER_OCTETS</a>) <span class="comment">// Header options present? TCP_HEADER_OCTETS = 20</span>
<a name="l01162"></a>01162             <a class="code" href="class_t_c_p_connection.html#a9a8bf987d5f32ecff2b85ba0f635f019">readHeaderOptions</a>(tcpseg);
<a name="l01163"></a>01163 
<a name="l01164"></a>01164         <span class="comment">// notify</span>
<a name="l01165"></a>01165         <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#abe5d8e8c02ba34cd5c50eca71824b81e">receivedDataAck</a>(old_snd_una);
<a name="l01166"></a>01166 
<a name="l01167"></a>01167         <span class="comment">// in the receivedDataAck we need the old value</span>
<a name="l01168"></a>01168         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a> = 0;
<a name="l01169"></a>01169         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>)
<a name="l01170"></a>01170             <a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a>);
<a name="l01171"></a>01171     }
<a name="l01172"></a>01172     <span class="keywordflow">else</span>
<a name="l01173"></a>01173     {
<a name="l01174"></a>01174         ASSERT(<a class="code" href="_t_c_p_connection_8h.html#a459ac205bbda777389c12b7353227fbe">seqGreater</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(), <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a220683addcd800e00fc59f348b40cff2">snd_max</a>)); <span class="comment">// from if-ladder</span>
<a name="l01175"></a>01175 
<a name="l01176"></a>01176         <span class="comment">// send an ACK, drop the segment, and return.</span>
<a name="l01177"></a>01177         <a class="code" href="class_t_c_p_connection.html#a305b76fec9de3d8524f7ae5cf1dd55f0">tcpAlgorithm</a>-&gt;<a class="code" href="class_t_c_p_algorithm.html#a113d03b1de3e1b788ae95635d69e064d">receivedAckForDataNotYetSent</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l01178"></a>01178         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a> = 0;
<a name="l01179"></a>01179         <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>)
<a name="l01180"></a>01180             <a class="code" href="class_t_c_p_connection.html#abceb1f0559f6e8c9f0e8d906b3e124e7">dupAcksVector</a>-&gt;record(<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#ae3ddd98e68751df8e6a8f4c0c7081f28">dupacks</a>);
<a name="l01181"></a>01181         <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// means &quot;drop&quot;</span>
<a name="l01182"></a>01182     }
<a name="l01183"></a>01183 
<a name="l01184"></a>01184     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a>01187 <span class="comment">//----</span>
<a name="l01188"></a>01188 
<a name="l01189"></a><a class="code" href="class_t_c_p_connection.html#a7b47d21fa8a97f13cab52097f3332ea6">01189</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#a7b47d21fa8a97f13cab52097f3332ea6">TCPConnection::process_TIMEOUT_CONN_ESTAB</a>()
<a name="l01190"></a>01190 {
<a name="l01191"></a>01191     <span class="keywordflow">switch</span>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l01192"></a>01192     {
<a name="l01193"></a>01193         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a>:
<a name="l01194"></a>01194         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca70c06b27000be54aee473572dd755890">TCP_S_SYN_SENT</a>:
<a name="l01195"></a>01195             <span class="comment">// Nothing to do here. TIMEOUT_CONN_ESTAB event will automatically</span>
<a name="l01196"></a>01196             <span class="comment">// take the connection to LISTEN or CLOSED, and cancel SYN-REXMIT timer.</span>
<a name="l01197"></a>01197             <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a4341a40e233610fbf989e373e450a08d">active</a>)
<a name="l01198"></a>01198             {
<a name="l01199"></a>01199                 <span class="comment">// notify user if we&apos;re on the active side</span>
<a name="l01200"></a>01200                 <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba06629e44a0aef5201b4cd424596127bf">TCP_I_TIMED_OUT</a>);
<a name="l01201"></a>01201             }
<a name="l01202"></a>01202             <span class="keywordflow">break</span>;
<a name="l01203"></a>01203         <span class="keywordflow">default</span>:
<a name="l01204"></a>01204             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01205"></a>01205             opp_error(<span class="stringliteral">&quot;Internal error: received CONN_ESTAB timeout in state %s&quot;</span>, <a class="code" href="class_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()));
<a name="l01206"></a>01206     }
<a name="l01207"></a>01207 }
<a name="l01208"></a>01208 
<a name="l01209"></a><a class="code" href="class_t_c_p_connection.html#ae29072ef963e593c4c3053827ebbec6e">01209</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#ae29072ef963e593c4c3053827ebbec6e">TCPConnection::process_TIMEOUT_2MSL</a>()
<a name="l01210"></a>01210 {
<a name="l01211"></a>01211     <span class="comment">//&quot;</span>
<a name="l01212"></a>01212     <span class="comment">// If the time-wait timeout expires on a connection delete the TCB,</span>
<a name="l01213"></a>01213     <span class="comment">// enter the CLOSED state and return.</span>
<a name="l01214"></a>01214     <span class="comment">//&quot;</span>
<a name="l01215"></a>01215     <span class="keywordflow">switch</span>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l01216"></a>01216     {
<a name="l01217"></a>01217         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecae102ae04107468f65ed2c9d80bc50997">TCP_S_TIME_WAIT</a>:
<a name="l01218"></a>01218             <span class="comment">// Nothing to do here. The TIMEOUT_2MSL event will automatically take</span>
<a name="l01219"></a>01219             <span class="comment">// the connection to CLOSED. We already notified the user</span>
<a name="l01220"></a>01220             <span class="comment">// (TCP_I_CLOSED) when we entered the TIME_WAIT state from CLOSING,</span>
<a name="l01221"></a>01221             <span class="comment">// FIN_WAIT_1 or FIN_WAIT_2.</span>
<a name="l01222"></a>01222             <span class="keywordflow">break</span>;
<a name="l01223"></a>01223         <span class="keywordflow">default</span>:
<a name="l01224"></a>01224             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01225"></a>01225             opp_error(<span class="stringliteral">&quot;Internal error: received time-wait (2MSL) timeout in state %s&quot;</span>, <a class="code" href="class_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()));
<a name="l01226"></a>01226     }
<a name="l01227"></a>01227 }
<a name="l01228"></a>01228 
<a name="l01229"></a><a class="code" href="class_t_c_p_connection.html#a53d62d237307ad56bae8d320ff557e48">01229</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#a53d62d237307ad56bae8d320ff557e48">TCPConnection::process_TIMEOUT_FIN_WAIT_2</a>()
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231     <span class="keywordflow">switch</span>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l01232"></a>01232     {
<a name="l01233"></a>01233         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfecaba28bfede161fc6d56ec1d30a363e463">TCP_S_FIN_WAIT_2</a>:
<a name="l01234"></a>01234             <span class="comment">// Nothing to do here. The TIMEOUT_FIN_WAIT_2 event will automatically take</span>
<a name="l01235"></a>01235             <span class="comment">// the connection to CLOSED.</span>
<a name="l01236"></a>01236             <a class="code" href="class_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l01237"></a>01237             <span class="keywordflow">break</span>;
<a name="l01238"></a>01238         <span class="keywordflow">default</span>:
<a name="l01239"></a>01239             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01240"></a>01240             opp_error(<span class="stringliteral">&quot;Internal error: received FIN_WAIT_2 timeout in state %s&quot;</span>, <a class="code" href="class_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()));
<a name="l01241"></a>01241     }
<a name="l01242"></a>01242 }
<a name="l01243"></a>01243 
<a name="l01244"></a><a class="code" href="class_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">01244</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">TCPConnection::startSynRexmitTimer</a>()
<a name="l01245"></a>01245 {
<a name="l01246"></a>01246     <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#abfce4d61e489f5c73d2f73aa072814e6">syn_rexmit_count</a> = 0;
<a name="l01247"></a>01247     <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a> = <a class="code" href="_t_c_p_connection_8h.html#a89ce38305130a5021e21134602a88f79">TCP_TIMEOUT_SYN_REXMIT</a>;
<a name="l01248"></a>01248 
<a name="l01249"></a>01249     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#ad2e24541092cf4c58f67845e6621f3cb">synRexmitTimer</a>-&gt;isScheduled())
<a name="l01250"></a>01250         <a class="code" href="class_t_c_p_connection.html#aecded14193441e78c31ca0c635ac19c8">cancelEvent</a>(<a class="code" href="class_t_c_p_connection.html#ad2e24541092cf4c58f67845e6621f3cb">synRexmitTimer</a>);
<a name="l01251"></a>01251     <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#ad2e24541092cf4c58f67845e6621f3cb">synRexmitTimer</a>, <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a>);
<a name="l01252"></a>01252 }
<a name="l01253"></a>01253 
<a name="l01254"></a><a class="code" href="class_t_c_p_connection.html#a33c6fe420de8b7fc6c09761f70118ed0">01254</a> <span class="keywordtype">void</span> <a class="code" href="class_t_c_p_connection.html#a33c6fe420de8b7fc6c09761f70118ed0">TCPConnection::process_TIMEOUT_SYN_REXMIT</a>(<a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85e">TCPEventCode</a>&amp; event)
<a name="l01255"></a>01255 {
<a name="l01256"></a>01256     <span class="keywordflow">if</span> (++<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#abfce4d61e489f5c73d2f73aa072814e6">syn_rexmit_count</a>&gt;<a class="code" href="_t_c_p_connection_8h.html#acd69c7cf1d3622b1d7aa706d7f9b97f9">MAX_SYN_REXMIT_COUNT</a>)
<a name="l01257"></a>01257     {
<a name="l01258"></a>01258         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Retransmission count during connection setup exceeds &quot;</span> &lt;&lt; <a class="code" href="_t_c_p_connection_8h.html#acd69c7cf1d3622b1d7aa706d7f9b97f9">MAX_SYN_REXMIT_COUNT</a> &lt;&lt; <span class="stringliteral">&quot;, giving up\n&quot;</span>;
<a name="l01259"></a>01259         <span class="comment">// Note ABORT will take the connection to closed, and cancel CONN-ESTAB timer as well</span>
<a name="l01260"></a>01260         <span class="keyword">event</span> = <a class="code" href="_t_c_p_connection_8h.html#a9187fb8d597fec5e53124ffe46c7e85ea2cc18190ce98d4997975fa624a8e147d">TCP_E_ABORT</a>;
<a name="l01261"></a>01261         <span class="keywordflow">return</span>;
<a name="l01262"></a>01262     }
<a name="l01263"></a>01263 
<a name="l01264"></a>01264     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Performing retransmission #&quot;</span> &lt;&lt; <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#abfce4d61e489f5c73d2f73aa072814e6">syn_rexmit_count</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01265"></a>01265 
<a name="l01266"></a>01266     <span class="comment">// resend what&apos;s needed</span>
<a name="l01267"></a>01267     <span class="keywordflow">switch</span>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState())
<a name="l01268"></a>01268     {
<a name="l01269"></a>01269         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca70c06b27000be54aee473572dd755890">TCP_S_SYN_SENT</a>: <a class="code" href="class_t_c_p_connection.html#abcd8f7efecc7c0077050184d3384b493">sendSyn</a>(); <span class="keywordflow">break</span>;
<a name="l01270"></a>01270         <span class="keywordflow">case</span> <a class="code" href="_t_c_p_connection_8h.html#a4310b47e70de394d33f7cf601e35bfeca6d12bc57c1710f3d93ee80e392e1361f">TCP_S_SYN_RCVD</a>: <a class="code" href="class_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>(); <span class="keywordflow">break</span>;
<a name="l01271"></a>01271         <span class="keywordflow">default</span>:  opp_error(<span class="stringliteral">&quot;Internal error: SYN-REXMIT timer expired while in state %s&quot;</span>, <a class="code" href="class_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="class_t_c_p_connection.html#af7032e0a7991f87167efce40df32535e">fsm</a>.getState()));
<a name="l01272"></a>01272     }
<a name="l01273"></a>01273 
<a name="l01274"></a>01274     <span class="comment">// reschedule timer</span>
<a name="l01275"></a>01275     <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a> *= 2;
<a name="l01276"></a>01276 
<a name="l01277"></a>01277     <span class="keywordflow">if</span> (<a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a> &gt; <a class="code" href="_t_c_p_connection_8h.html#a0b48410b2bd35dbc6509568bfb1842aa">TCP_TIMEOUT_SYN_REXMIT_MAX</a>)
<a name="l01278"></a>01278         <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a> = <a class="code" href="_t_c_p_connection_8h.html#a0b48410b2bd35dbc6509568bfb1842aa">TCP_TIMEOUT_SYN_REXMIT_MAX</a>;
<a name="l01279"></a>01279     <a class="code" href="class_t_c_p_connection.html#a60c9fb67af21fc9c1cee62369a8a1486">scheduleTimeout</a>(<a class="code" href="class_t_c_p_connection.html#ad2e24541092cf4c58f67845e6621f3cb">synRexmitTimer</a>, <a class="code" href="class_t_c_p_connection.html#a4780b0038982452cef8139e04f84b4c8">state</a>-&gt;<a class="code" href="class_t_c_p_state_variables.html#a1bad9ac8364085b574ef441748c2e723">syn_rexmit_timeout</a>);
<a name="l01280"></a>01280 }
<a name="l01281"></a>01281 
<a name="l01282"></a>01282 
<a name="l01283"></a>01283 <span class="comment">//</span>
<a name="l01284"></a>01284 <span class="comment">//TBD:</span>
<a name="l01285"></a>01285 <span class="comment">//&quot;</span>
<a name="l01286"></a>01286 <span class="comment">// USER TIMEOUT</span>
<a name="l01287"></a>01287 <span class="comment">//</span>
<a name="l01288"></a>01288 <span class="comment">//    For any state if the user timeout expires, flush all queues, signal</span>
<a name="l01289"></a>01289 <span class="comment">//    the user &quot;error:  connection aborted due to user timeout&quot; in general</span>
<a name="l01290"></a>01290 <span class="comment">//    and for any outstanding calls, delete the TCB, enter the CLOSED</span>
<a name="l01291"></a>01291 <span class="comment">//    state and return.</span>
<a name="l01292"></a>01292 <span class="comment">//&quot;</span>
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Mar 23 17:08:30 2010 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
