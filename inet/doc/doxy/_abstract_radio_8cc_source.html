<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>INET Framework for OMNeT++/OMNEST: AbstractRadio.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_493eba74639f722aa88bd3d010f621b5.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_15f4b73e4143e94d16b8a3f5620d968f.html">linklayer</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_87439912e21bb46b7242378c002bfe40.html">radio</a>
  </div>
</div>
<div class="contents">
<h1>AbstractRadio.cc</h1><a href="_abstract_radio_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2006 Andras Varga, Levente Meszaros</span>
<a name="l00003"></a>00003 <span class="comment">// Based on the Mobility Framework&apos;s SnrEval by Marc Loebbers</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00006"></a>00006 <span class="comment">// modify it under the terms of the GNU Lesser General Public License</span>
<a name="l00007"></a>00007 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00008"></a>00008 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00009"></a>00009 <span class="comment">//</span>
<a name="l00010"></a>00010 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00013"></a>00013 <span class="comment">// GNU Lesser General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment">//</span>
<a name="l00015"></a>00015 <span class="comment">// You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00016"></a>00016 <span class="comment">// along with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00017"></a>00017 <span class="comment">//</span>
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_abstract_radio_8h.html">AbstractRadio.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_f_w_math_8h.html">FWMath.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_phy_control_info__m_8h.html">PhyControlInfo_m.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_ieee80211_consts_8h.html">Ieee80211Consts.h</a>&quot;</span>  <span class="comment">//XXX for the COLLISION and BITERROR msg kind constants</span>
<a name="l00024"></a>00024 
<a name="l00025"></a>00025 
<a name="l00026"></a><a class="code" href="_abstract_radio_8cc.html#a2a9cfeaaf7c63479165e7050a39b24ee">00026</a> <span class="preprocessor">#define MK_TRANSMISSION_OVER  1</span>
<a name="l00027"></a><a class="code" href="_abstract_radio_8cc.html#aebda9a0d17a20bb583e3a05765538194">00027</a> <span class="preprocessor"></span><span class="preprocessor">#define MK_RECEPTION_COMPLETE 2</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span>
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="class_abstract_radio.html#a7438e8075f8a43bed2d5f2495993905c">00030</a> <a class="code" href="class_abstract_radio.html#a7438e8075f8a43bed2d5f2495993905c">AbstractRadio::AbstractRadio</a>() : rs(this-&gt;getId())
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032     <a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a> = NULL;
<a name="l00033"></a>00033     <a class="code" href="class_abstract_radio.html#a2d472dafa39234e2d2ceb3c77ca20c4f">receptionModel</a> = NULL;
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="class_abstract_radio.html#ad646c42cb1ee4b8fa5d0bf555a6ef0fe">00036</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#ad646c42cb1ee4b8fa5d0bf555a6ef0fe" title="Register with ChannelControl and subscribe to hostPos.">AbstractRadio::initialize</a>(<span class="keywordtype">int</span> stage)
<a name="l00037"></a>00037 {
<a name="l00038"></a>00038     <a class="code" href="class_abstract_radio.html#ad646c42cb1ee4b8fa5d0bf555a6ef0fe" title="Register with ChannelControl and subscribe to hostPos.">ChannelAccess::initialize</a>(stage);
<a name="l00039"></a>00039 
<a name="l00040"></a>00040     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Initializing AbstractRadio, stage=&quot;</span> &lt;&lt; stage &lt;&lt; endl;
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     <span class="keywordflow">if</span> (stage == 0)
<a name="l00043"></a>00043     {
<a name="l00044"></a>00044         gate(<span class="stringliteral">&quot;radioIn&quot;</span>)-&gt;setDeliverOnReceptionStart(<span class="keyword">true</span>);
<a name="l00045"></a>00045 
<a name="l00046"></a>00046         <a class="code" href="class_abstract_radio.html#ae9254113d76c6aeecfaf2483105ae824">uppergateIn</a> = findGate(<span class="stringliteral">&quot;uppergateIn&quot;</span>);
<a name="l00047"></a>00047         <a class="code" href="class_abstract_radio.html#ab4183b07dda8b3909b5e098990f1f420">uppergateOut</a> = findGate(<span class="stringliteral">&quot;uppergateOut&quot;</span>);
<a name="l00048"></a>00048 
<a name="l00049"></a>00049         <span class="comment">// read parameters</span>
<a name="l00050"></a>00050         <a class="code" href="class_abstract_radio.html#a3b2cd111e9febcbced779a755c4a960a">transmitterPower</a> = par(<span class="stringliteral">&quot;transmitterPower&quot;</span>);
<a name="l00051"></a>00051         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a3b2cd111e9febcbced779a755c4a960a">transmitterPower</a> &gt; (<span class="keywordtype">double</span>) (<a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;par(<span class="stringliteral">&quot;pMax&quot;</span>)))
<a name="l00052"></a>00052             error(<span class="stringliteral">&quot;transmitterPower cannot be bigger than pMax in ChannelControl!&quot;</span>);
<a name="l00053"></a>00053         <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a789f5ce6d79f31a60e9473cbc07a5d49">setBitrate</a>(par(<span class="stringliteral">&quot;bitrate&quot;</span>));
<a name="l00054"></a>00054         <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab4ce41a963cc11f5bbd10a5d9b894a71">setChannelNumber</a>(par(<span class="stringliteral">&quot;channelNumber&quot;</span>));
<a name="l00055"></a>00055         <a class="code" href="class_abstract_radio.html#aeff3be287270fa5332e3bb4db3955cee">thermalNoise</a> = <a class="code" href="class_f_w_math.html#af308407856d9835b103f2421e373ee28">FWMath::dBm2mW</a>(par(<span class="stringliteral">&quot;thermalNoise&quot;</span>));
<a name="l00056"></a>00056         <a class="code" href="class_abstract_radio.html#afd694d58688e028489f993597a9f44af">carrierFrequency</a> = <a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;par(<span class="stringliteral">&quot;carrierFrequency&quot;</span>);  <span class="comment">// taken from ChannelControl</span>
<a name="l00057"></a>00057         <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a> = <a class="code" href="class_f_w_math.html#af308407856d9835b103f2421e373ee28">FWMath::dBm2mW</a>(par(<span class="stringliteral">&quot;sensitivity&quot;</span>));
<a name="l00058"></a>00058 
<a name="l00059"></a>00059         <span class="comment">// initialize noiseLevel</span>
<a name="l00060"></a>00060         <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> = <a class="code" href="class_abstract_radio.html#aeff3be287270fa5332e3bb4db3955cee">thermalNoise</a>;
<a name="l00061"></a>00061 
<a name="l00062"></a>00062         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Initialized channel with noise: &quot;</span> &lt;&lt; <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> &lt;&lt; <span class="stringliteral">&quot; sensitivity: &quot;</span> &lt;&lt; <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a> &lt;&lt;
<a name="l00063"></a>00063             endl;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065         <span class="comment">// initialize the pointer of the snrInfo with NULL to indicate</span>
<a name="l00066"></a>00066         <span class="comment">// that currently no message is received</span>
<a name="l00067"></a>00067         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> = NULL;
<a name="l00068"></a>00068 
<a name="l00069"></a>00069         <span class="comment">// no channel switch pending</span>
<a name="l00070"></a>00070         <a class="code" href="class_abstract_radio.html#a198f3ac6a1ab6a0f7252bebb4048ca47">newChannel</a> = -1;
<a name="l00071"></a>00071 
<a name="l00072"></a>00072         <span class="comment">// Initialize radio state. If thermal noise is already to high, radio</span>
<a name="l00073"></a>00073         <span class="comment">// state has to be initialized as RECV</span>
<a name="l00074"></a>00074         <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ae524aa6442043b5cdecb052a84ca57aa">setState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aeb600ab2fbbbbc2d12d874edb9320ec0">RadioState::IDLE</a>);
<a name="l00075"></a>00075         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> &gt;= <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a>)
<a name="l00076"></a>00076             <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ae524aa6442043b5cdecb052a84ca57aa">setState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>);
<a name="l00077"></a>00077 
<a name="l00078"></a>00078         WATCH(<a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a>);
<a name="l00079"></a>00079         WATCH(<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00080"></a>00080 
<a name="l00081"></a>00081         <a class="code" href="class_abstract_radio.html#a2d472dafa39234e2d2ceb3c77ca20c4f">receptionModel</a> = <a class="code" href="class_abstract_radio.html#a6cf413915eeb3105a89acaf1d6e4e894">createReceptionModel</a>();
<a name="l00082"></a>00082         <a class="code" href="class_abstract_radio.html#a2d472dafa39234e2d2ceb3c77ca20c4f">receptionModel</a>-&gt;<a class="code" href="class_i_reception_model.html#a054edd0e5822f95dff9501b96802d2ab">initializeFrom</a>(<span class="keyword">this</span>);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084         <a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a> = <a class="code" href="class_abstract_radio.html#a59a22e03b4bd27c61e3f966e4185cd02">createRadioModel</a>();
<a name="l00085"></a>00085         <a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a>-&gt;<a class="code" href="class_i_radio_model.html#a77a41286d82a93c67d1b834e4236f0d3">initializeFrom</a>(<span class="keyword">this</span>);
<a name="l00086"></a>00086     }
<a name="l00087"></a>00087     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stage == 1)
<a name="l00088"></a>00088     {
<a name="l00089"></a>00089         <span class="comment">// tell initial values to MAC; must be done in stage 1, because they</span>
<a name="l00090"></a>00090         <span class="comment">// subscribe in stage 0</span>
<a name="l00091"></a>00091         <a class="code" href="class_basic_module.html#addff3486601f037d673200507e1fbf12" title="Cached pointer to the NotificationBoard module.">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55baa6e69ccdaad903262ac00b89b6208a69">NF_RADIOSTATE_CHANGED</a>, &amp;<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00092"></a>00092         <a class="code" href="class_basic_module.html#addff3486601f037d673200507e1fbf12" title="Cached pointer to the NotificationBoard module.">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf3cbaad9c60e34c5cd7ca3da116fa468">NF_RADIO_CHANNEL_CHANGED</a>, &amp;<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00093"></a>00093     }
<a name="l00094"></a>00094     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (stage == 2)
<a name="l00095"></a>00095     {
<a name="l00096"></a>00096         <span class="comment">// tell initial channel number to ChannelControl; should be done in</span>
<a name="l00097"></a>00097         <span class="comment">// stage==2 or later, because base class initializes myHostRef in that stage</span>
<a name="l00098"></a>00098         <a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;<a class="code" href="class_channel_control.html#a04bbb08c92d001b804c06ba42d8e43ea" title="Called when host switches channel.">updateHostChannel</a>(<a class="code" href="class_channel_access.html#aff3d33ee8db5a945fff05fe4305ccf2e" title="Identifies this host in the ChannelControl module.">myHostRef</a>, <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a0799344b13882d66af3376919bdf9c7d">getChannelNumber</a>());
<a name="l00099"></a>00099     }
<a name="l00100"></a>00100 }
<a name="l00101"></a>00101 
<a name="l00102"></a><a class="code" href="class_abstract_radio.html#a618ff4c01fa836ccf906d7dee514c214">00102</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a618ff4c01fa836ccf906d7dee514c214">AbstractRadio::finish</a>()
<a name="l00103"></a>00103 {
<a name="l00104"></a>00104 }
<a name="l00105"></a>00105 
<a name="l00106"></a><a class="code" href="class_abstract_radio.html#a2ae96666e302359b8441895f3dc8d716">00106</a> <a class="code" href="class_abstract_radio.html#a2ae96666e302359b8441895f3dc8d716">AbstractRadio::~AbstractRadio</a>()
<a name="l00107"></a>00107 {
<a name="l00108"></a>00108     <span class="keyword">delete</span> <a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a>;
<a name="l00109"></a>00109     <span class="keyword">delete</span> <a class="code" href="class_abstract_radio.html#a2d472dafa39234e2d2ceb3c77ca20c4f">receptionModel</a>;
<a name="l00110"></a>00110 
<a name="l00111"></a>00111     <span class="comment">// delete messages being received</span>
<a name="l00112"></a>00112     <span class="keywordflow">for</span> (RecvBuff::iterator it = <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.begin(); it!=<a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.end(); ++it)
<a name="l00113"></a>00113         <span class="keyword">delete</span> it-&gt;first;
<a name="l00114"></a>00114 }
<a name="l00115"></a>00115 
<a name="l00131"></a><a class="code" href="class_abstract_radio.html#aa7800db11fac1c18457a7d5c57d81c3d">00131</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#aa7800db11fac1c18457a7d5c57d81c3d">AbstractRadio::handleMessage</a>(cMessage *msg)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     <span class="comment">// handle commands</span>
<a name="l00134"></a>00134     <span class="keywordflow">if</span> (msg-&gt;getArrivalGateId()==<a class="code" href="class_abstract_radio.html#ae9254113d76c6aeecfaf2483105ae824">uppergateIn</a> &amp;&amp; !msg-&gt;isPacket() <span class="comment">/*FIXME XXX ENSURE REALLY PLAIN cMessage ARE SENT AS COMMANDS!!! &amp;&amp; msg-&gt;getBitLength()==0*/</span>)
<a name="l00135"></a>00135     {
<a name="l00136"></a>00136         cPolymorphic *ctrl = msg-&gt;removeControlInfo();
<a name="l00137"></a>00137         <span class="keywordflow">if</span> (msg-&gt;getKind()==0)
<a name="l00138"></a>00138             error(<span class="stringliteral">&quot;Message &apos;%s&apos; with length==0 is supposed to be a command, but msg kind is also zero&quot;</span>, msg-&gt;getName());
<a name="l00139"></a>00139         <a class="code" href="class_abstract_radio.html#a364d17ee4e46c541896622141607c0c0">handleCommand</a>(msg-&gt;getKind(), ctrl);
<a name="l00140"></a>00140         <span class="keyword">delete</span> msg;
<a name="l00141"></a>00141         <span class="keywordflow">return</span>;
<a name="l00142"></a>00142     }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (msg-&gt;getArrivalGateId() == <a class="code" href="class_abstract_radio.html#ae9254113d76c6aeecfaf2483105ae824">uppergateIn</a>)
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = <a class="code" href="class_abstract_radio.html#aca7489dae305d0afeaa9d2beda764dc2">encapsulatePacket</a>(<a class="code" href="_i_n_e_t_defs_8h.html#ae5b816f7de3c5248c812bdb6920f4e06">PK</a>(msg));
<a name="l00147"></a>00147         <a class="code" href="class_abstract_radio.html#aee4b43805a3b94cbb1b65b698a80f3bf">handleUpperMsg</a>(airframe);
<a name="l00148"></a>00148     }
<a name="l00149"></a>00149     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
<a name="l00150"></a>00150     {
<a name="l00151"></a>00151         <a class="code" href="class_abstract_radio.html#a3035e4a5d365d6a5a9267329199fa3a6">handleSelfMsg</a>(msg);
<a name="l00152"></a>00152     }
<a name="l00153"></a>00153     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (check_and_cast&lt;AirFrame *&gt;(msg)-&gt;<a class="code" href="class_abstract_radio.html#a5d08dc0ef0b75513e2a2c1a7ea8397fb">getChannelNumber</a>() == <a class="code" href="class_abstract_radio.html#a5d08dc0ef0b75513e2a2c1a7ea8397fb">getChannelNumber</a>())
<a name="l00154"></a>00154     {
<a name="l00155"></a>00155         <span class="comment">// must be an AirFrame</span>
<a name="l00156"></a>00156         <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = (<a class="code" href="class_air_frame.html">AirFrame</a> *) msg;
<a name="l00157"></a>00157         <a class="code" href="class_abstract_radio.html#ab99c16474f3d123d1597f5b67c985e7e" title="Buffer the frame and update noise levels and snr information.">handleLowerMsgStart</a>(airframe);
<a name="l00158"></a>00158         <a class="code" href="class_abstract_radio.html#a9a0a19c2ffd8a9f1a516c368a6e4b7b0" title="Buffers message for &amp;#39;transmission time&amp;#39;.">bufferMsg</a>(airframe);
<a name="l00159"></a>00159     }
<a name="l00160"></a>00160     <span class="keywordflow">else</span>
<a name="l00161"></a>00161     {
<a name="l00162"></a>00162         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;listening to different channel when receiving message -- dropping it\n&quot;</span>;
<a name="l00163"></a>00163         <span class="keyword">delete</span> msg;
<a name="l00164"></a>00164     }
<a name="l00165"></a>00165 }
<a name="l00166"></a>00166 
<a name="l00173"></a><a class="code" href="class_abstract_radio.html#a9a0a19c2ffd8a9f1a516c368a6e4b7b0">00173</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a9a0a19c2ffd8a9f1a516c368a6e4b7b0" title="Buffers message for &amp;#39;transmission time&amp;#39;.">AbstractRadio::bufferMsg</a>(<a class="code" href="class_air_frame.html">AirFrame</a> *airframe) <span class="comment">//FIXME: add explicit simtime_t atTime arg?</span>
<a name="l00174"></a>00174 {
<a name="l00175"></a>00175     <span class="comment">// set timer to indicate transmission is complete</span>
<a name="l00176"></a>00176     cMessage *endRxTimer = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;endRx&quot;</span>, <a class="code" href="_abstract_radio_8cc.html#aebda9a0d17a20bb583e3a05765538194">MK_RECEPTION_COMPLETE</a>);
<a name="l00177"></a>00177     endRxTimer-&gt;setContextPointer(airframe);
<a name="l00178"></a>00178     airframe-&gt;setContextPointer(endRxTimer);
<a name="l00179"></a>00179 
<a name="l00180"></a>00180     <span class="comment">// NOTE: use arrivalTime instead of simTime, because we might be calling this</span>
<a name="l00181"></a>00181     <span class="comment">// function during a channel change, when we&apos;re picking up ongoing transmissions</span>
<a name="l00182"></a>00182     <span class="comment">// on the channel -- and then the message&apos;s arrival time is in the past!</span>
<a name="l00183"></a>00183     scheduleAt(airframe-&gt;getArrivalTime() + airframe-&gt;<a class="code" href="class_air_frame.html#a564aa81be93f77dfd92846f53d6c9f40">getDuration</a>(), endRxTimer);
<a name="l00184"></a>00184 }
<a name="l00185"></a>00185 
<a name="l00186"></a><a class="code" href="class_abstract_radio.html#aca7489dae305d0afeaa9d2beda764dc2">00186</a> <a class="code" href="class_air_frame.html">AirFrame</a> *<a class="code" href="class_abstract_radio.html#aca7489dae305d0afeaa9d2beda764dc2">AbstractRadio::encapsulatePacket</a>(cPacket *frame)
<a name="l00187"></a>00187 {
<a name="l00188"></a>00188     <a class="code" href="class_phy_control_info.html">PhyControlInfo</a> *ctrl = <span class="keyword">dynamic_cast&lt;</span><a class="code" href="class_phy_control_info.html">PhyControlInfo</a> *<span class="keyword">&gt;</span>(frame-&gt;removeControlInfo());
<a name="l00189"></a>00189     ASSERT(!ctrl || ctrl-&gt;<a class="code" href="class_phy_control_info.html#adf34f991f466b2ed39bcc3d484612167">getChannelNumber</a>()==-1); <span class="comment">// per-packet channel switching not supported</span>
<a name="l00190"></a>00190 
<a name="l00191"></a>00191     <span class="comment">// Note: we don&apos;t set length() of the AirFrame, because duration will be used everywhere instead</span>
<a name="l00192"></a>00192     <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = <a class="code" href="class_abstract_radio.html#a2d6020e8f7601cc7dbbe71500cab6c26">createAirFrame</a>();
<a name="l00193"></a>00193     airframe-&gt;setName(frame-&gt;getName());
<a name="l00194"></a>00194     airframe-&gt;setPSend(<a class="code" href="class_abstract_radio.html#a3b2cd111e9febcbced779a755c4a960a">transmitterPower</a>);
<a name="l00195"></a>00195     airframe-&gt;setChannelNumber(<a class="code" href="class_abstract_radio.html#a5d08dc0ef0b75513e2a2c1a7ea8397fb">getChannelNumber</a>());
<a name="l00196"></a>00196     airframe-&gt;encapsulate(frame);
<a name="l00197"></a>00197     airframe-&gt;setBitrate(ctrl ? ctrl-&gt;<a class="code" href="class_phy_control_info.html#a75467afe8d5de4d4aa72e8f773117736">getBitrate</a>() : <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a2f127045c28c2a709aa1212ba098b9b4">getBitrate</a>());
<a name="l00198"></a>00198     airframe-&gt;setDuration(<a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a>-&gt;<a class="code" href="class_i_radio_model.html#af8aff6a5a5c7b81321818141c7d97b95">calculateDuration</a>(airframe));
<a name="l00199"></a>00199     airframe-&gt;setSenderPos(<a class="code" href="class_channel_access.html#a9e51969a624ff64101cf808514d50d4f" title="Returns the host&amp;#39;s position.">getMyPosition</a>());
<a name="l00200"></a>00200     <span class="keyword">delete</span> ctrl;
<a name="l00201"></a>00201 
<a name="l00202"></a>00202     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Frame (&quot;</span> &lt;&lt; frame-&gt;getClassName() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; frame-&gt;getName()
<a name="l00203"></a>00203        &lt;&lt; <span class="stringliteral">&quot; will be transmitted at &quot;</span> &lt;&lt; (airframe-&gt;getBitrate()/1e6) &lt;&lt; <span class="stringliteral">&quot;Mbps\n&quot;</span>;
<a name="l00204"></a>00204     <span class="keywordflow">return</span> airframe;
<a name="l00205"></a>00205 }
<a name="l00206"></a>00206 
<a name="l00207"></a><a class="code" href="class_abstract_radio.html#a31ac7ea59c04d9614d6f61e72ab2e3b4">00207</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a31ac7ea59c04d9614d6f61e72ab2e3b4">AbstractRadio::sendUp</a>(<a class="code" href="class_air_frame.html">AirFrame</a> *airframe)
<a name="l00208"></a>00208 {
<a name="l00209"></a>00209     cPacket *frame = airframe-&gt;decapsulate();
<a name="l00210"></a>00210     <span class="keyword">delete</span> airframe;
<a name="l00211"></a>00211     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending up frame &quot;</span> &lt;&lt; frame-&gt;getName() &lt;&lt; endl;
<a name="l00212"></a>00212     send(frame, <a class="code" href="class_abstract_radio.html#ab4183b07dda8b3909b5e098990f1f420">uppergateOut</a>);
<a name="l00213"></a>00213 }
<a name="l00214"></a>00214 
<a name="l00215"></a><a class="code" href="class_abstract_radio.html#a871595ad4b30a0dc843899edce0c6897">00215</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a871595ad4b30a0dc843899edce0c6897">AbstractRadio::sendDown</a>(<a class="code" href="class_air_frame.html">AirFrame</a> *airframe)
<a name="l00216"></a>00216 {
<a name="l00217"></a>00217     <a class="code" href="class_channel_access.html#a562995b3d9c5b279ed8a55c5221dd7b7" title="Sends a message to all hosts in range.">sendToChannel</a>(airframe);
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00224"></a><a class="code" href="class_abstract_radio.html#a64e2958a548e3cf480f1afe215e1dea9">00224</a> <a class="code" href="class_air_frame.html">AirFrame</a> *<a class="code" href="class_abstract_radio.html#a64e2958a548e3cf480f1afe215e1dea9" title="Unbuffers a message after &amp;#39;transmission time&amp;#39;.">AbstractRadio::unbufferMsg</a>(cMessage *msg)
<a name="l00225"></a>00225 {
<a name="l00226"></a>00226     <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = (<a class="code" href="class_air_frame.html">AirFrame</a> *) msg-&gt;getContextPointer();
<a name="l00227"></a>00227     <span class="comment">//delete the self message</span>
<a name="l00228"></a>00228     <span class="keyword">delete</span> msg;
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <span class="keywordflow">return</span> airframe;
<a name="l00231"></a>00231 }
<a name="l00232"></a>00232 
<a name="l00243"></a><a class="code" href="class_abstract_radio.html#aee4b43805a3b94cbb1b65b698a80f3bf">00243</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#aee4b43805a3b94cbb1b65b698a80f3bf">AbstractRadio::handleUpperMsg</a>(<a class="code" href="class_air_frame.html">AirFrame</a> *airframe)
<a name="l00244"></a>00244 {
<a name="l00245"></a>00245     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>)
<a name="l00246"></a>00246         error(<span class="stringliteral">&quot;Trying to send a message while already transmitting -- MAC should &quot;</span>
<a name="l00247"></a>00247               <span class="stringliteral">&quot;take care this does not happen&quot;</span>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249     <span class="comment">// if a packet was being received, it is corrupted now as should be treated as noise</span>
<a name="l00250"></a>00250     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> != NULL)
<a name="l00251"></a>00251     {
<a name="l00252"></a>00252         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Sending a message while receiving another. The received one is now corrupted.\n&quot;</span>;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254         <span class="comment">// remove the snr information stored for the message currently being</span>
<a name="l00255"></a>00255         <span class="comment">// received. This message is treated as noise now and the</span>
<a name="l00256"></a>00256         <span class="comment">// receive power has to be added to the noiseLevel</span>
<a name="l00257"></a>00257 
<a name="l00258"></a>00258         <span class="comment">// delete the pointer to indicate that no message is being received</span>
<a name="l00259"></a>00259         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> = NULL;
<a name="l00260"></a>00260         <span class="comment">// clear the snr list</span>
<a name="l00261"></a>00261         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a>.clear();
<a name="l00262"></a>00262         <span class="comment">// add the receive power to the noise level</span>
<a name="l00263"></a>00263         <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> += <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a4d916ac27467f3f7dd5ebec0689b4887" title="received power of the message">rcvdPower</a>;
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <span class="comment">// now we are done with all the exception handling and can take care</span>
<a name="l00267"></a>00267     <span class="comment">// about the &quot;real&quot; stuff</span>
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="comment">// change radio status</span>
<a name="l00270"></a>00270     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending, changing RadioState to TRANSMIT\n&quot;</span>;
<a name="l00271"></a>00271     <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>);
<a name="l00272"></a>00272 
<a name="l00273"></a>00273     cMessage *timer = <span class="keyword">new</span> cMessage(NULL, <a class="code" href="_abstract_radio_8cc.html#a2a9cfeaaf7c63479165e7050a39b24ee">MK_TRANSMISSION_OVER</a>);
<a name="l00274"></a>00274     scheduleAt(simTime() + airframe-&gt;<a class="code" href="class_air_frame.html#a564aa81be93f77dfd92846f53d6c9f40">getDuration</a>(), timer);
<a name="l00275"></a>00275     <a class="code" href="class_abstract_radio.html#a871595ad4b30a0dc843899edce0c6897">sendDown</a>(airframe);
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00278"></a><a class="code" href="class_abstract_radio.html#a364d17ee4e46c541896622141607c0c0">00278</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a364d17ee4e46c541896622141607c0c0">AbstractRadio::handleCommand</a>(<span class="keywordtype">int</span> msgkind, cPolymorphic *ctrl)
<a name="l00279"></a>00279 {
<a name="l00280"></a>00280     <span class="keywordflow">if</span> (msgkind==<a class="code" href="_phy_control_info__m_8h.html#a827a8f9f0f91bb52136f8f155337862fa5eb8d08b5c380e0589a4622fa0ca5ee9">PHY_C_CONFIGURERADIO</a>)
<a name="l00281"></a>00281     {
<a name="l00282"></a>00282         <span class="comment">// extract new channel number</span>
<a name="l00283"></a>00283         <a class="code" href="class_phy_control_info.html">PhyControlInfo</a> *phyCtrl = check_and_cast&lt;<a class="code" href="class_phy_control_info.html">PhyControlInfo</a> *&gt;(ctrl);
<a name="l00284"></a>00284         <span class="keywordtype">int</span> <a class="code" href="class_abstract_radio.html#a198f3ac6a1ab6a0f7252bebb4048ca47">newChannel</a> = phyCtrl-&gt;<a class="code" href="class_phy_control_info.html#adf34f991f466b2ed39bcc3d484612167">getChannelNumber</a>();
<a name="l00285"></a>00285         <span class="keywordtype">double</span> <a class="code" href="class_abstract_radio.html#a7e23b50ae626be43197b6950a772537d">newBitrate</a> = phyCtrl-&gt;<a class="code" href="class_phy_control_info.html#a75467afe8d5de4d4aa72e8f773117736">getBitrate</a>();
<a name="l00286"></a>00286         <span class="keyword">delete</span> ctrl;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288         <span class="keywordflow">if</span> (newChannel!=-1)
<a name="l00289"></a>00289         {
<a name="l00290"></a>00290             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Command received: change to channel #&quot;</span> &lt;&lt; newChannel &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00291"></a>00291 
<a name="l00292"></a>00292             <span class="comment">// do it</span>
<a name="l00293"></a>00293             <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a0799344b13882d66af3376919bdf9c7d">getChannelNumber</a>()==newChannel)
<a name="l00294"></a>00294                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Right on that channel, nothing to do\n&quot;</span>; <span class="comment">// fine, nothing to do</span>
<a name="l00295"></a>00295             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>()==<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>) {
<a name="l00296"></a>00296                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;We&apos;re transmitting right now, remembering to change after it&apos;s completed\n&quot;</span>;
<a name="l00297"></a>00297                 this-&gt;newChannel = newChannel;
<a name="l00298"></a>00298             } <span class="keywordflow">else</span>
<a name="l00299"></a>00299                 <a class="code" href="class_abstract_radio.html#adf9361bf91285886c54fbc917c8e3e89">changeChannel</a>(newChannel); <span class="comment">// change channel right now</span>
<a name="l00300"></a>00300         }
<a name="l00301"></a>00301         <span class="keywordflow">if</span> (newBitrate!=-1)
<a name="l00302"></a>00302         {
<a name="l00303"></a>00303             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Command received: change bitrate to &quot;</span> &lt;&lt; (newBitrate/1e6) &lt;&lt; <span class="stringliteral">&quot;Mbps\n&quot;</span>;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305             <span class="comment">// do it</span>
<a name="l00306"></a>00306             <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a2f127045c28c2a709aa1212ba098b9b4">getBitrate</a>()==newBitrate)
<a name="l00307"></a>00307                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Right at that bitrate, nothing to do\n&quot;</span>; <span class="comment">// fine, nothing to do</span>
<a name="l00308"></a>00308             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>()==<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>) {
<a name="l00309"></a>00309                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;We&apos;re transmitting right now, remembering to change after it&apos;s completed\n&quot;</span>;
<a name="l00310"></a>00310                 this-&gt;newBitrate = newBitrate;
<a name="l00311"></a>00311             } <span class="keywordflow">else</span>
<a name="l00312"></a>00312                 <a class="code" href="class_abstract_radio.html#a2d2c984f3ad5621135b287615b2e4147">setBitrate</a>(newBitrate); <span class="comment">// change bitrate right now</span>
<a name="l00313"></a>00313         }
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     <span class="keywordflow">else</span>
<a name="l00316"></a>00316     {
<a name="l00317"></a>00317         error(<span class="stringliteral">&quot;unknown command (msgkind=%d)&quot;</span>, msgkind);
<a name="l00318"></a>00318     }
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="class_abstract_radio.html#a3035e4a5d365d6a5a9267329199fa3a6">00321</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a3035e4a5d365d6a5a9267329199fa3a6">AbstractRadio::handleSelfMsg</a>(cMessage *msg)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323     <span class="keywordflow">if</span> (msg-&gt;getKind()==<a class="code" href="_abstract_radio_8cc.html#aebda9a0d17a20bb583e3a05765538194">MK_RECEPTION_COMPLETE</a>)
<a name="l00324"></a>00324     {
<a name="l00325"></a>00325         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;frame is completely received now\n&quot;</span>;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         <span class="comment">// unbuffer the message</span>
<a name="l00328"></a>00328         <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = <a class="code" href="class_abstract_radio.html#a64e2958a548e3cf480f1afe215e1dea9" title="Unbuffers a message after &amp;#39;transmission time&amp;#39;.">unbufferMsg</a>(msg);
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         <a class="code" href="class_abstract_radio.html#a1f8cd41c9dc2c34f51e1c68b561c27cf" title="Unbuffer the frame and update noise levels and snr information.">handleLowerMsgEnd</a>(airframe);
<a name="l00331"></a>00331     }
<a name="l00332"></a>00332     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;getKind() == <a class="code" href="_abstract_radio_8cc.html#a2a9cfeaaf7c63479165e7050a39b24ee">MK_TRANSMISSION_OVER</a>)
<a name="l00333"></a>00333     {
<a name="l00334"></a>00334         <span class="comment">// Transmission has completed. The RadioState has to be changed</span>
<a name="l00335"></a>00335         <span class="comment">// to IDLE or RECV, based on the noise level on the channel.</span>
<a name="l00336"></a>00336         <span class="comment">// If the noise level is bigger than the sensitivity switch to receive mode,</span>
<a name="l00337"></a>00337         <span class="comment">// otherwise to idle mode.</span>
<a name="l00338"></a>00338         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> &lt; <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a>)
<a name="l00339"></a>00339         {
<a name="l00340"></a>00340             <span class="comment">// set the RadioState to IDLE</span>
<a name="l00341"></a>00341             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;transmission over, switch to idle mode (state:IDLE)\n&quot;</span>;
<a name="l00342"></a>00342             <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aeb600ab2fbbbbc2d12d874edb9320ec0">RadioState::IDLE</a>);
<a name="l00343"></a>00343         }
<a name="l00344"></a>00344         <span class="keywordflow">else</span>
<a name="l00345"></a>00345         {
<a name="l00346"></a>00346             <span class="comment">// set the RadioState to RECV</span>
<a name="l00347"></a>00347             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;transmission over but noise level too high, switch to recv mode (state:RECV)\n&quot;</span>;
<a name="l00348"></a>00348             <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>);
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351         <span class="comment">// delete the timer</span>
<a name="l00352"></a>00352         <span class="keyword">delete</span> msg;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         <span class="comment">// switch channel if it needs be</span>
<a name="l00355"></a>00355         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a198f3ac6a1ab6a0f7252bebb4048ca47">newChannel</a>!=-1)
<a name="l00356"></a>00356         {
<a name="l00357"></a>00357             <a class="code" href="class_abstract_radio.html#adf9361bf91285886c54fbc917c8e3e89">changeChannel</a>(<a class="code" href="class_abstract_radio.html#a198f3ac6a1ab6a0f7252bebb4048ca47">newChannel</a>);
<a name="l00358"></a>00358             <a class="code" href="class_abstract_radio.html#a198f3ac6a1ab6a0f7252bebb4048ca47">newChannel</a> = -1;
<a name="l00359"></a>00359         }
<a name="l00360"></a>00360     }
<a name="l00361"></a>00361     <span class="keywordflow">else</span>
<a name="l00362"></a>00362     {
<a name="l00363"></a>00363         error(<span class="stringliteral">&quot;Internal error: unknown self-message `%s&apos;&quot;</span>, msg-&gt;getName());
<a name="l00364"></a>00364     }
<a name="l00365"></a>00365 }
<a name="l00366"></a>00366 
<a name="l00367"></a>00367 
<a name="l00391"></a><a class="code" href="class_abstract_radio.html#ab99c16474f3d123d1597f5b67c985e7e">00391</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#ab99c16474f3d123d1597f5b67c985e7e" title="Buffer the frame and update noise levels and snr information.">AbstractRadio::handleLowerMsgStart</a>(<a class="code" href="class_air_frame.html">AirFrame</a> * airframe)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393     <span class="comment">// Calculate the receive power of the message</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395     <span class="comment">// calculate distance</span>
<a name="l00396"></a>00396     <span class="keyword">const</span> <a class="code" href="class_coord.html" title="Class for storing host positions.">Coord</a>&amp; myPos = <a class="code" href="class_channel_access.html#a9e51969a624ff64101cf808514d50d4f" title="Returns the host&amp;#39;s position.">getMyPosition</a>();
<a name="l00397"></a>00397     <span class="keyword">const</span> <a class="code" href="class_coord.html" title="Class for storing host positions.">Coord</a>&amp; framePos = airframe-&gt;<a class="code" href="class_air_frame.html#a6330e718269d5471a1beaeba7b505a60">getSenderPos</a>();
<a name="l00398"></a>00398     <span class="keywordtype">double</span> distance = myPos.<a class="code" href="class_coord.html#ab6a7bfcc5c55e5d8edbc7c0cb5a11626">distance</a>(framePos);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400     <span class="comment">// calculate receive power</span>
<a name="l00401"></a>00401     <span class="keywordtype">double</span> rcvdPower = <a class="code" href="class_abstract_radio.html#a2d472dafa39234e2d2ceb3c77ca20c4f">receptionModel</a>-&gt;<a class="code" href="class_i_reception_model.html#a4c62c5996f5afac48e0f0a88bdeed308">calculateReceivedPower</a>(airframe-&gt;<a class="code" href="class_air_frame.html#a8b0e2eb1d14e0a5d9cab5c5a6f66c044">getPSend</a>(), <a class="code" href="class_abstract_radio.html#afd694d58688e028489f993597a9f44af">carrierFrequency</a>, distance);
<a name="l00402"></a>00402 
<a name="l00403"></a>00403     <span class="comment">// store the receive power in the recvBuff</span>
<a name="l00404"></a>00404     <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>[airframe] = rcvdPower;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406     <span class="comment">// if receive power is bigger than sensitivity and if not sending</span>
<a name="l00407"></a>00407     <span class="comment">// and currently not receiving another message and the message has</span>
<a name="l00408"></a>00408     <span class="comment">// arrived in time</span>
<a name="l00409"></a>00409     <span class="comment">// NOTE: a message may have arrival time in the past here when we are</span>
<a name="l00410"></a>00410     <span class="comment">// processing ongoing transmissions during a channel change</span>
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (airframe-&gt;getArrivalTime() == simTime() &amp;&amp; rcvdPower &gt;= <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a> &amp;&amp; <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() != <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a> &amp;&amp; <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> == NULL)
<a name="l00412"></a>00412     {
<a name="l00413"></a>00413         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;receiving frame &quot;</span> &lt;&lt; airframe-&gt;getName() &lt;&lt; endl;
<a name="l00414"></a>00414 
<a name="l00415"></a>00415         <span class="comment">// Put frame and related SnrList in receive buffer</span>
<a name="l00416"></a>00416         <a class="code" href="_snr_list_8h.html#a241b5e7c9575e932988a55f7a5012a61" title="List to store SNR information for a message.">SnrList</a> snrList;
<a name="l00417"></a>00417         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> = airframe;
<a name="l00418"></a>00418         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a4d916ac27467f3f7dd5ebec0689b4887" title="received power of the message">rcvdPower</a> = rcvdPower;
<a name="l00419"></a>00419         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a> = snrList;
<a name="l00420"></a>00420 
<a name="l00421"></a>00421         <span class="comment">// add initial snr value</span>
<a name="l00422"></a>00422         <a class="code" href="class_abstract_radio.html#a98b9b9d5f0124b4c292b372aae123913">addNewSnr</a>();
<a name="l00423"></a>00423 
<a name="l00424"></a>00424         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() != <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>)
<a name="l00425"></a>00425         {
<a name="l00426"></a>00426             <span class="comment">// publish new RadioState</span>
<a name="l00427"></a>00427             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;publish new RadioState:RECV\n&quot;</span>;
<a name="l00428"></a>00428             <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>);
<a name="l00429"></a>00429         }
<a name="l00430"></a>00430     }
<a name="l00431"></a>00431     <span class="comment">// receive power is too low or another message is being sent or received</span>
<a name="l00432"></a>00432     <span class="keywordflow">else</span>
<a name="l00433"></a>00433     {
<a name="l00434"></a>00434         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;frame &quot;</span> &lt;&lt; airframe-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; is just noise\n&quot;</span>;
<a name="l00435"></a>00435         <span class="comment">//add receive power to the noise level</span>
<a name="l00436"></a>00436         <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> += rcvdPower;
<a name="l00437"></a>00437 
<a name="l00438"></a>00438         <span class="comment">// if a message is being received add a new snr value</span>
<a name="l00439"></a>00439         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> != NULL)
<a name="l00440"></a>00440         {
<a name="l00441"></a>00441             <span class="comment">// update snr info for currently being received message</span>
<a name="l00442"></a>00442             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;adding new snr value to snr list of message being received\n&quot;</span>;
<a name="l00443"></a>00443             <a class="code" href="class_abstract_radio.html#a98b9b9d5f0124b4c292b372aae123913">addNewSnr</a>();
<a name="l00444"></a>00444         }
<a name="l00445"></a>00445 
<a name="l00446"></a>00446         <span class="comment">// update the RadioState if the noiseLevel exceeded the threshold</span>
<a name="l00447"></a>00447         <span class="comment">// and the radio is currently not in receive or in send mode</span>
<a name="l00448"></a>00448         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> &gt;= <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a> &amp;&amp; <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aeb600ab2fbbbbc2d12d874edb9320ec0">RadioState::IDLE</a>)
<a name="l00449"></a>00449         {
<a name="l00450"></a>00450             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;setting radio state to RECV\n&quot;</span>;
<a name="l00451"></a>00451             <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>);
<a name="l00452"></a>00452         }
<a name="l00453"></a>00453     }
<a name="l00454"></a>00454 }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 
<a name="l00467"></a><a class="code" href="class_abstract_radio.html#a1f8cd41c9dc2c34f51e1c68b561c27cf">00467</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a1f8cd41c9dc2c34f51e1c68b561c27cf" title="Unbuffer the frame and update noise levels and snr information.">AbstractRadio::handleLowerMsgEnd</a>(<a class="code" href="class_air_frame.html">AirFrame</a> * airframe)
<a name="l00468"></a>00468 {
<a name="l00469"></a>00469     <span class="comment">// check if message has to be send to the decider</span>
<a name="l00470"></a>00470     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> == airframe)
<a name="l00471"></a>00471     {
<a name="l00472"></a>00472         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;reception of frame over, preparing to send packet to upper layer\n&quot;</span>;
<a name="l00473"></a>00473         <span class="comment">// get Packet and list out of the receive buffer:</span>
<a name="l00474"></a>00474         <a class="code" href="_snr_list_8h.html#a241b5e7c9575e932988a55f7a5012a61" title="List to store SNR information for a message.">SnrList</a> list;
<a name="l00475"></a>00475         list = <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a>;
<a name="l00476"></a>00476 
<a name="l00477"></a>00477         <span class="comment">// delete the pointer to indicate that no message is currently</span>
<a name="l00478"></a>00478         <span class="comment">// being received and clear the list</span>
<a name="l00479"></a>00479         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> = NULL;
<a name="l00480"></a>00480         <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a>.clear();
<a name="l00481"></a>00481 
<a name="l00482"></a>00482         <span class="comment">// delete the frame from the recvBuff</span>
<a name="l00483"></a>00483         <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.erase(airframe);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485         <span class="comment">//XXX send up the frame:</span>
<a name="l00486"></a>00486         <span class="comment">//if (radioModel-&gt;isReceivedCorrectly(airframe, list))</span>
<a name="l00487"></a>00487         <span class="comment">//    sendUp(airframe);</span>
<a name="l00488"></a>00488         <span class="comment">//else</span>
<a name="l00489"></a>00489         <span class="comment">//    delete airframe;</span>
<a name="l00490"></a>00490         <span class="keywordflow">if</span> (!<a class="code" href="class_abstract_radio.html#a7e6436fc8bb1931f46c47ae7a7446d01">radioModel</a>-&gt;<a class="code" href="class_i_radio_model.html#a107eaa67a662f3dce05eb691dae90f84">isReceivedCorrectly</a>(airframe, list))
<a name="l00491"></a>00491         {
<a name="l00492"></a>00492             airframe-&gt;getEncapsulatedMsg()-&gt;setKind(list.size()&gt;1 ? <a class="code" href="_ieee80211_consts_8h.html#aafd826a123a41fd03a9c88842387a821">COLLISION</a> : <a class="code" href="_ieee80211_consts_8h.html#adc91194d5fc156e1d3b796361b38a54d">BITERROR</a>);
<a name="l00493"></a>00493             airframe-&gt;setName(list.size()&gt;1 ? <span class="stringliteral">&quot;COLLISION&quot;</span> : <span class="stringliteral">&quot;BITERROR&quot;</span>);
<a name="l00494"></a>00494         }
<a name="l00495"></a>00495         <a class="code" href="class_abstract_radio.html#a31ac7ea59c04d9614d6f61e72ab2e3b4">sendUp</a>(airframe);
<a name="l00496"></a>00496     }
<a name="l00497"></a>00497     <span class="comment">// all other messages are noise</span>
<a name="l00498"></a>00498     <span class="keywordflow">else</span>
<a name="l00499"></a>00499     {
<a name="l00500"></a>00500         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;reception of noise message over, removing recvdPower from noiseLevel....\n&quot;</span>;
<a name="l00501"></a>00501         <span class="comment">// get the rcvdPower and subtract it from the noiseLevel</span>
<a name="l00502"></a>00502         <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> -= <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>[airframe];
<a name="l00503"></a>00503 
<a name="l00504"></a>00504         <span class="comment">// delete message from the recvBuff</span>
<a name="l00505"></a>00505         <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.erase(airframe);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507         <span class="comment">// update snr info for message currently being received if any</span>
<a name="l00508"></a>00508         <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> != NULL)
<a name="l00509"></a>00509         {
<a name="l00510"></a>00510             <a class="code" href="class_abstract_radio.html#a98b9b9d5f0124b4c292b372aae123913">addNewSnr</a>();
<a name="l00511"></a>00511         }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513         <span class="comment">// message should be deleted</span>
<a name="l00514"></a>00514         <span class="keyword">delete</span> airframe;
<a name="l00515"></a>00515         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;message deleted\n&quot;</span>;
<a name="l00516"></a>00516     }
<a name="l00517"></a>00517 
<a name="l00518"></a>00518     <span class="comment">// check the RadioState and update if necessary</span>
<a name="l00519"></a>00519     <span class="comment">// change to idle if noiseLevel smaller than threshold and state was</span>
<a name="l00520"></a>00520     <span class="comment">// not idle before</span>
<a name="l00521"></a>00521     <span class="comment">// do not change state if currently sending or receiving a message!!!</span>
<a name="l00522"></a>00522     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a> &lt; <a class="code" href="class_abstract_radio.html#aff52d795ae9cc6d12075ad120848da44">sensitivity</a> &amp;&amp; <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a> &amp;&amp; <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> == NULL)
<a name="l00523"></a>00523     {
<a name="l00524"></a>00524         <span class="comment">// publish the new RadioState:</span>
<a name="l00525"></a>00525         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;new RadioState is IDLE\n&quot;</span>;
<a name="l00526"></a>00526         <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aeb600ab2fbbbbc2d12d874edb9320ec0">RadioState::IDLE</a>);
<a name="l00527"></a>00527     }
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="class_abstract_radio.html#a98b9b9d5f0124b4c292b372aae123913">00530</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a98b9b9d5f0124b4c292b372aae123913">AbstractRadio::addNewSnr</a>()
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532     <a class="code" href="struct_snr_list_entry.html" title="struct for SNR information">SnrListEntry</a> listEntry;     <span class="comment">// create a new entry</span>
<a name="l00533"></a>00533     listEntry.<a class="code" href="struct_snr_list_entry.html#a0a91ab67cfd340b315a7badf6da14ce8" title="timestamp for this SNR value">time</a> = simTime();
<a name="l00534"></a>00534     listEntry.<a class="code" href="struct_snr_list_entry.html#a9126b6070ee24b0a586a267de6ebc94b" title="the SNR value">snr</a> = <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a4d916ac27467f3f7dd5ebec0689b4887" title="received power of the message">rcvdPower</a> / <a class="code" href="class_abstract_radio.html#aeea450d539294f8e54917dd5bc279ff6">noiseLevel</a>;
<a name="l00535"></a>00535     <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a>.push_back(listEntry);
<a name="l00536"></a>00536 }
<a name="l00537"></a>00537 
<a name="l00538"></a><a class="code" href="class_abstract_radio.html#adf9361bf91285886c54fbc917c8e3e89">00538</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#adf9361bf91285886c54fbc917c8e3e89">AbstractRadio::changeChannel</a>(<span class="keywordtype">int</span> channel)
<a name="l00539"></a>00539 {
<a name="l00540"></a>00540     <span class="keywordflow">if</span> (channel == <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a0799344b13882d66af3376919bdf9c7d">getChannelNumber</a>())
<a name="l00541"></a>00541         <span class="keywordflow">return</span>;
<a name="l00542"></a>00542     <span class="keywordflow">if</span> (channel &lt; 0 || channel &gt;= <a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;<a class="code" href="class_channel_control.html#ac3a565b50d10c70e4fe2e7a0442aa086" title="Returns the number of radio channels (frequencies) simulated.">getNumChannels</a>())
<a name="l00543"></a>00543         error(<span class="stringliteral">&quot;changeChannel(): channel number %d is out of range (hint: numChannels is a parameter of ChannelControl)&quot;</span>, channel);
<a name="l00544"></a>00544     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>)
<a name="l00545"></a>00545         error(<span class="stringliteral">&quot;changing channel while transmitting is not allowed&quot;</span>);
<a name="l00546"></a>00546 
<a name="l00547"></a>00547     <span class="comment">// if we are currently receiving, must clean that up before moving to different channel</span>
<a name="l00548"></a>00548     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449ab9ff1508b0f4aac00ec13bd9e9335c4b">RadioState::RECV</a>)
<a name="l00549"></a>00549     {
<a name="l00550"></a>00550         <span class="comment">// delete messages being received, and cancel associated self-messages</span>
<a name="l00551"></a>00551         <span class="keywordflow">for</span> (RecvBuff::iterator it = <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.begin(); it!=<a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.end(); ++it)
<a name="l00552"></a>00552         {
<a name="l00553"></a>00553             <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = it-&gt;first;
<a name="l00554"></a>00554             cMessage *endRxTimer = (cMessage *)airframe-&gt;getContextPointer();
<a name="l00555"></a>00555             <span class="keyword">delete</span> airframe;
<a name="l00556"></a>00556             <span class="keyword">delete</span> cancelEvent(endRxTimer);
<a name="l00557"></a>00557         }
<a name="l00558"></a>00558         <a class="code" href="class_abstract_radio.html#a4555680a6bf06aebbbed01a67c03b638">recvBuff</a>.clear();
<a name="l00559"></a>00559     }
<a name="l00560"></a>00560 
<a name="l00561"></a>00561     <span class="comment">// clear snr info</span>
<a name="l00562"></a>00562     <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a50829d26259d1bb7cbbff74179e8a800" title="pointer to the message this information belongs to">ptr</a> = NULL;
<a name="l00563"></a>00563     <a class="code" href="class_abstract_radio.html#ac43bfe80e1284106a494732f79de8cb8">snrInfo</a>.<a class="code" href="struct_abstract_radio_1_1_snr_struct.html#a69a0eeb12fe8bf0c96afb82c2a720077" title="stores SNR over time">sList</a>.clear();
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     <span class="comment">// do channel switch</span>
<a name="l00566"></a>00566     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Changing to channel #&quot;</span> &lt;&lt; channel &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab4ce41a963cc11f5bbd10a5d9b894a71">setChannelNumber</a>(channel);
<a name="l00569"></a>00569     <a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;<a class="code" href="class_channel_control.html#a04bbb08c92d001b804c06ba42d8e43ea" title="Called when host switches channel.">updateHostChannel</a>(<a class="code" href="class_channel_access.html#aff3d33ee8db5a945fff05fe4305ccf2e" title="Identifies this host in the ChannelControl module.">myHostRef</a>, channel);
<a name="l00570"></a>00570     <a class="code" href="class_channel_control.html#a3d946c87c47729fdd4ad4ae9a17b406f">ChannelControl::TransmissionList</a> tl = <a class="code" href="class_channel_access.html#a0f42b731ff69be4b1193929356e75aff" title="Pointer to the ChannelControl module.">cc</a>-&gt;<a class="code" href="class_channel_control.html#a29b60c6b3cdaa3c63a9c48e83beb9f9e" title="Provides a list of transmissions currently on the air.">getOngoingTransmissions</a>(channel);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572     cModule *myHost = <a class="code" href="class_basic_module.html#a8188a32c320b4632bdd2c0e7241d06f8" title="Function to get a pointer to the host module.">findHost</a>();
<a name="l00573"></a>00573     cGate *radioGate = myHost-&gt;gate(<span class="stringliteral">&quot;radioIn&quot;</span>);
<a name="l00574"></a>00574 
<a name="l00575"></a>00575     <span class="comment">// pick up ongoing transmissions on the new channel</span>
<a name="l00576"></a>00576     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Picking up ongoing transmissions on new channel:\n&quot;</span>;
<a name="l00577"></a>00577     <span class="keywordflow">for</span> (ChannelControl::TransmissionList::const_iterator it = tl.begin(); it != tl.end(); ++it)
<a name="l00578"></a>00578     {
<a name="l00579"></a>00579         <a class="code" href="class_air_frame.html">AirFrame</a> *airframe = *it;
<a name="l00580"></a>00580         <span class="comment">// time for the message to reach us</span>
<a name="l00581"></a>00581         <span class="keywordtype">double</span> distance = <a class="code" href="class_channel_access.html#aff3d33ee8db5a945fff05fe4305ccf2e" title="Identifies this host in the ChannelControl module.">myHostRef</a>-&gt;<a class="code" href="struct_channel_control_1_1_host_entry.html#a3e6df3511ce1af969e4dc2254f7f4c40">pos</a>.<a class="code" href="class_coord.html#ab6a7bfcc5c55e5d8edbc7c0cb5a11626">distance</a>(airframe-&gt;<a class="code" href="class_air_frame.html#a6330e718269d5471a1beaeba7b505a60">getSenderPos</a>());
<a name="l00582"></a>00582         simtime_t propagationDelay = distance / <a class="code" href="_channel_control_8h.html#a2f3addaba3e40cfb6e78224398707712">LIGHT_SPEED</a>;
<a name="l00583"></a>00583 
<a name="l00584"></a>00584         <span class="comment">// if this transmission is on our new channel and it would reach us in the future, then schedule it</span>
<a name="l00585"></a>00585         <span class="keywordflow">if</span> (channel == airframe-&gt;<a class="code" href="class_air_frame.html#a8cabf7478ff3a18c0c535eee85afdd01">getChannelNumber</a>())
<a name="l00586"></a>00586         {
<a name="l00587"></a>00587             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot; - (&quot;</span> &lt;&lt; airframe-&gt;getClassName() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; airframe-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;: &quot;</span>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589             <span class="comment">// if there is a message on the air which will reach us in the future</span>
<a name="l00590"></a>00590             <span class="keywordflow">if</span> (airframe-&gt;getTimestamp() + propagationDelay &gt;= simTime())
<a name="l00591"></a>00591             {
<a name="l00592"></a>00592                  <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;will arrive in the future, scheduling it\n&quot;</span>;
<a name="l00593"></a>00593 
<a name="l00594"></a>00594                  <span class="comment">// we need to send to each radioIn[] gate of this host</span>
<a name="l00595"></a>00595                  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; radioGate-&gt;size(); i++)
<a name="l00596"></a>00596                      sendDirect(airframe-&gt;<a class="code" href="class_air_frame.html#aee29f72e2445142e19cfb652f6d2f0ff">dup</a>(), airframe-&gt;getTimestamp() + propagationDelay - simTime(), airframe-&gt;<a class="code" href="class_air_frame.html#a564aa81be93f77dfd92846f53d6c9f40">getDuration</a>(), myHost, radioGate-&gt;getId() + i);
<a name="l00597"></a>00597             }
<a name="l00598"></a>00598             <span class="comment">// if we hear some part of the message</span>
<a name="l00599"></a>00599             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (airframe-&gt;getTimestamp() + airframe-&gt;<a class="code" href="class_air_frame.html#a564aa81be93f77dfd92846f53d6c9f40">getDuration</a>() + propagationDelay &gt; simTime())
<a name="l00600"></a>00600             {
<a name="l00601"></a>00601                  <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;missed beginning of frame, processing it as noise\n&quot;</span>;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603                  <a class="code" href="class_air_frame.html">AirFrame</a> *frameDup = airframe-&gt;<a class="code" href="class_air_frame.html#aee29f72e2445142e19cfb652f6d2f0ff">dup</a>();
<a name="l00604"></a>00604                  frameDup-&gt;setArrivalTime(airframe-&gt;getTimestamp() + propagationDelay);
<a name="l00605"></a>00605                  <a class="code" href="class_abstract_radio.html#ab99c16474f3d123d1597f5b67c985e7e" title="Buffer the frame and update noise levels and snr information.">handleLowerMsgStart</a>(frameDup);
<a name="l00606"></a>00606                  <a class="code" href="class_abstract_radio.html#a9a0a19c2ffd8a9f1a516c368a6e4b7b0" title="Buffers message for &amp;#39;transmission time&amp;#39;.">bufferMsg</a>(frameDup);
<a name="l00607"></a>00607             }
<a name="l00608"></a>00608             <span class="keywordflow">else</span>
<a name="l00609"></a>00609             {
<a name="l00610"></a>00610                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;in the past\n&quot;</span>;
<a name="l00611"></a>00611             }
<a name="l00612"></a>00612         }
<a name="l00613"></a>00613     }
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     <span class="comment">// notify other modules about the channel switch; and actually, radio state has changed too</span>
<a name="l00616"></a>00616     <a class="code" href="class_basic_module.html#addff3486601f037d673200507e1fbf12" title="Cached pointer to the NotificationBoard module.">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55baf3cbaad9c60e34c5cd7ca3da116fa468">NF_RADIO_CHANNEL_CHANGED</a>, &amp;<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00617"></a>00617     <a class="code" href="class_basic_module.html#addff3486601f037d673200507e1fbf12" title="Cached pointer to the NotificationBoard module.">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55baa6e69ccdaad903262ac00b89b6208a69">NF_RADIOSTATE_CHANGED</a>, &amp;<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 
<a name="l00620"></a><a class="code" href="class_abstract_radio.html#a2d2c984f3ad5621135b287615b2e4147">00620</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a2d2c984f3ad5621135b287615b2e4147">AbstractRadio::setBitrate</a>(<span class="keywordtype">double</span> bitrate)
<a name="l00621"></a>00621 {
<a name="l00622"></a>00622     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a2f127045c28c2a709aa1212ba098b9b4">getBitrate</a>() == bitrate)
<a name="l00623"></a>00623         <span class="keywordflow">return</span>;
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (bitrate &lt; 0)
<a name="l00625"></a>00625         error(<span class="stringliteral">&quot;setBitrate(): bitrate cannot be negative (%g)&quot;</span>, bitrate);
<a name="l00626"></a>00626     <span class="keywordflow">if</span> (<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ab714f16be9aaf5b6789801854f859883">getState</a>() == <a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449aedb2522a6da55abd014a306192411a11">RadioState::TRANSMIT</a>)
<a name="l00627"></a>00627         error(<span class="stringliteral">&quot;changing the bitrate while transmitting is not allowed&quot;</span>);
<a name="l00628"></a>00628 
<a name="l00629"></a>00629     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Setting bitrate to &quot;</span> &lt;&lt; (bitrate/1e6) &lt;&lt; <span class="stringliteral">&quot;Mbps\n&quot;</span>;
<a name="l00630"></a>00630     <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#a789f5ce6d79f31a60e9473cbc07a5d49">setBitrate</a>(bitrate);
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="comment">//XXX fire some notification?</span>
<a name="l00633"></a>00633 }
<a name="l00634"></a>00634 
<a name="l00635"></a><a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">00635</a> <span class="keywordtype">void</span> <a class="code" href="class_abstract_radio.html#a0d0a613aba5a78acd1b4eb8fdb31f112">AbstractRadio::setRadioState</a>(<a class="code" href="class_radio_state.html#a9b2ff8c4d3f1cdb73af0a9fcea0d5449">RadioState::State</a> newState)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637     <a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>.<a class="code" href="class_radio_state.html#ae524aa6442043b5cdecb052a84ca57aa">setState</a>(newState);
<a name="l00638"></a>00638     <a class="code" href="class_basic_module.html#addff3486601f037d673200507e1fbf12" title="Cached pointer to the NotificationBoard module.">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55baa6e69ccdaad903262ac00b89b6208a69">NF_RADIOSTATE_CHANGED</a>, &amp;<a class="code" href="class_abstract_radio.html#a12a4fe65c7da402fde1d86d87e685d58">rs</a>);
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Mar 23 17:08:27 2010 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
