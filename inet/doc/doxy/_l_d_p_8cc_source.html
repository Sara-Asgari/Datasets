<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>INET Framework for OMNeT++/OMNEST: LDP.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_493eba74639f722aa88bd3d010f621b5.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_10b2eb36c3bc5c55e7882141837be45a.html">networklayer</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_ebccddb51127b1c2d68a45c59180f3a8.html">ldp</a>
  </div>
</div>
<div class="contents">
<h1>LDP.cc</h1><a href="_l_d_p_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// (C) 2005 Vojtech Janota</span>
<a name="l00003"></a>00003 <span class="comment">// (C) 2004 Andras Varga</span>
<a name="l00004"></a>00004 <span class="comment">//</span>
<a name="l00005"></a>00005 <span class="comment">// This library is free software, you can redistribute it</span>
<a name="l00006"></a>00006 <span class="comment">// and/or modify</span>
<a name="l00007"></a>00007 <span class="comment">// it under  the terms of the GNU Lesser General Public License</span>
<a name="l00008"></a>00008 <span class="comment">// as published by the Free Software Foundation;</span>
<a name="l00009"></a>00009 <span class="comment">// either version 2 of the License, or any later version.</span>
<a name="l00010"></a>00010 <span class="comment">// The library is distributed in the hope that it will be useful,</span>
<a name="l00011"></a>00011 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00012"></a>00012 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<a name="l00013"></a>00013 <span class="comment">// See the GNU Lesser General Public License for more details.</span>
<a name="l00014"></a>00014 <span class="comment">//</span>
<a name="l00015"></a>00015 
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;omnetpp.h&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_const_type_8h.html">ConstType.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_l_d_p_8h.html">LDP.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_l_i_b_table_8h.html">LIBTable.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_interface_table_access_8h.html">InterfaceTableAccess.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="_i_pv4_interface_data_8h.html">IPv4InterfaceData.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_routing_table_access_8h.html">RoutingTableAccess.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_l_i_b_table_access_8h.html">LIBTableAccess.h</a>&quot;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &quot;<a class="code" href="_t_e_d_access_8h.html">TEDAccess.h</a>&quot;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="_notifier_consts_8h.html">NotifierConsts.h</a>&quot;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="_u_d_p_packet_8h.html">UDPPacket.h</a>&quot;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_segment_8h.html">TCPSegment.h</a>&quot;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <a class="code" href="_ether_app_cli_8cc.html#abf346c028a3c694e3a78e998c663a6c7">Define_Module</a>(<a class="code" href="class_l_d_p.html">LDP</a>);
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 
<a name="l00036"></a><a class="code" href="_l_d_p_8cc.html#ab86a09c61fe77a635b7ab9ad92b978c8">00036</a> std::ostream&amp; <a class="code" href="_u_d_p_video_stream_svr_8cc.html#a635f24433df826fed0b3245212fac075">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1fec__bind__t.html">LDP::fec_bind_t</a>&amp; f)
<a name="l00037"></a>00037 {
<a name="l00038"></a>00038     os &lt;&lt; <span class="stringliteral">&quot;fecid=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a641b231f6ae1b8ad59c76872031fe86c">fecid</a> &lt;&lt; <span class="stringliteral">&quot;  peer=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a50a515dc50f5f76e99efccaa2145a14b">peer</a> &lt;&lt; <span class="stringliteral">&quot; label=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a539f7f3b600b0ab7184622a5f1361f77">label</a>;
<a name="l00039"></a>00039     <span class="keywordflow">return</span> os;
<a name="l00040"></a>00040 }
<a name="l00041"></a>00041 
<a name="l00042"></a><a class="code" href="_l_d_p_8cc.html#a1e6892349ebc14dde68f926f1b8d87cd">00042</a> <span class="keywordtype">bool</span> <a class="code" href="_l_d_p_8cc.html#a1e6892349ebc14dde68f926f1b8d87cd">fecPrefixCompare</a>(<span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1fec__t.html">LDP::fec_t</a>&amp; a, <span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1fec__t.html">LDP::fec_t</a>&amp; b)
<a name="l00043"></a>00043 {
<a name="l00044"></a>00044     <span class="keywordflow">return</span> a.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a> &gt; b.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a>;
<a name="l00045"></a>00045 }
<a name="l00046"></a>00046 
<a name="l00047"></a><a class="code" href="_l_d_p_8cc.html#acab2d77eecec636a7fdc2260a20908e3">00047</a> std::ostream&amp; <a class="code" href="_u_d_p_video_stream_svr_8cc.html#a635f24433df826fed0b3245212fac075">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1fec__t.html">LDP::fec_t</a>&amp; f)
<a name="l00048"></a>00048 {
<a name="l00049"></a>00049     os &lt;&lt; <span class="stringliteral">&quot;fecid=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__t.html#afc947259edf916031b6a940e0cd64ae5">fecid</a> &lt;&lt; <span class="stringliteral">&quot;  addr=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__t.html#a56c9f3a1e36f0a59c7e624cf5c3592dc">addr</a> &lt;&lt; <span class="stringliteral">&quot;  length=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a> &lt;&lt; <span class="stringliteral">&quot;  nextHop=&quot;</span> &lt;&lt; f.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a>;
<a name="l00050"></a>00050     <span class="keywordflow">return</span> os;
<a name="l00051"></a>00051 }
<a name="l00052"></a>00052 
<a name="l00053"></a><a class="code" href="_l_d_p_8cc.html#ace3331ce7dcda555f18001ed0cc1359f">00053</a> std::ostream&amp; <a class="code" href="_u_d_p_video_stream_svr_8cc.html#a635f24433df826fed0b3245212fac075">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1pending__req__t.html">LDP::pending_req_t</a>&amp; r)
<a name="l00054"></a>00054 {
<a name="l00055"></a>00055     os &lt;&lt; <span class="stringliteral">&quot;fecid=&quot;</span> &lt;&lt; r.<a class="code" href="struct_l_d_p_1_1pending__req__t.html#ac9e70bc554d3e6126af229f19a097db6">fecid</a> &lt;&lt; <span class="stringliteral">&quot;  peer=&quot;</span> &lt;&lt; r.<a class="code" href="struct_l_d_p_1_1pending__req__t.html#a25aacccb518de6def2bce4ca8c01d930">peer</a>;
<a name="l00056"></a>00056     <span class="keywordflow">return</span> os;
<a name="l00057"></a>00057 }
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="_l_d_p_8cc.html#a829e171daaf17b651bb2929c6daca734">00059</a> std::ostream&amp; <a class="code" href="_u_d_p_video_stream_svr_8cc.html#a635f24433df826fed0b3245212fac075">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="struct_l_d_p_1_1peer__info.html">LDP::peer_info</a>&amp; p)
<a name="l00060"></a>00060 {
<a name="l00061"></a>00061     os &lt;&lt; <span class="stringliteral">&quot;peerIP=&quot;</span> &lt;&lt; p.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot;  interface=&quot;</span> &lt;&lt; p.<a class="code" href="struct_l_d_p_1_1peer__info.html#abff497458c90c3d73c3080622c6b5adf">linkInterface</a> &lt;&lt;
<a name="l00062"></a>00062           <span class="stringliteral">&quot;  activeRole=&quot;</span> &lt;&lt; (p.<a class="code" href="struct_l_d_p_1_1peer__info.html#a4606158df7b7582064c78e9372bdc353">activeRole</a> ? <span class="stringliteral">&quot;true&quot;</span> : <span class="stringliteral">&quot;false&quot;</span>) &lt;&lt;
<a name="l00063"></a>00063           <span class="stringliteral">&quot;  socket=&quot;</span> &lt;&lt; (p.<a class="code" href="struct_l_d_p_1_1peer__info.html#a52a748a6dc9b4d6ab9262305b8a60964">socket</a> ? <a class="code" href="class_t_c_p_socket.html#af106166df336536cb233a6e239c1c04b">TCPSocket::stateName</a>(p.<a class="code" href="struct_l_d_p_1_1peer__info.html#a52a748a6dc9b4d6ab9262305b8a60964">socket</a>-&gt;<a class="code" href="class_t_c_p_socket.html#a30566319602bc7f14e3a47c85f344864">getState</a>()) : <span class="stringliteral">&quot;NULL&quot;</span>);
<a name="l00064"></a>00064     <span class="keywordflow">return</span> os;
<a name="l00065"></a>00065 }
<a name="l00066"></a>00066 
<a name="l00067"></a><a class="code" href="_l_d_p_8cc.html#aec4fce57ab67052a78eec3f7b66f2dc5">00067</a> <span class="keywordtype">bool</span> <a class="code" href="_l_d_p_8cc.html#aec4fce57ab67052a78eec3f7b66f2dc5">operator==</a>(<span class="keyword">const</span> <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a>&amp; a, <span class="keyword">const</span> <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a>&amp; b)
<a name="l00068"></a>00068 {
<a name="l00069"></a>00069     <span class="keywordflow">return</span> a.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a> == b.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a> &amp;&amp; a.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a> == b.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>;
<a name="l00070"></a>00070 }
<a name="l00071"></a>00071 
<a name="l00072"></a><a class="code" href="_l_d_p_8cc.html#a453bead0b02b301046f21ce92c007d6e">00072</a> <span class="keywordtype">bool</span> <a class="code" href="_l_d_p_8cc.html#a453bead0b02b301046f21ce92c007d6e">operator!=</a>(<span class="keyword">const</span> <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a>&amp; a, <span class="keyword">const</span> <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a>&amp; b)
<a name="l00073"></a>00073 {
<a name="l00074"></a>00074     <span class="keywordflow">return</span> !<a class="code" href="_l_d_p_8cc.html#aec4fce57ab67052a78eec3f7b66f2dc5">operator==</a>(a, b);
<a name="l00075"></a>00075 }
<a name="l00076"></a>00076 
<a name="l00077"></a><a class="code" href="_l_d_p_8cc.html#a846c4a9fc90261231b33d0a7a2affb1f">00077</a> std::ostream&amp; <a class="code" href="_u_d_p_video_stream_svr_8cc.html#a635f24433df826fed0b3245212fac075">operator&lt;&lt;</a>(std::ostream&amp; os, <span class="keyword">const</span> <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a>&amp; a)
<a name="l00078"></a>00078 {
<a name="l00079"></a>00079     os &lt;&lt; <span class="stringliteral">&quot;addr=&quot;</span> &lt;&lt; a.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a> &lt;&lt; <span class="stringliteral">&quot;  length=&quot;</span> &lt;&lt; a.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>;
<a name="l00080"></a>00080     <span class="keywordflow">return</span> os;
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="class_l_d_p.html#adbf35af62eaaade603f94900fda0b1a5">00084</a> <a class="code" href="class_l_d_p.html#adbf35af62eaaade603f94900fda0b1a5">LDP::LDP</a>()
<a name="l00085"></a>00085 {
<a name="l00086"></a>00086     <a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a> = NULL;
<a name="l00087"></a>00087 }
<a name="l00088"></a>00088 
<a name="l00089"></a><a class="code" href="class_l_d_p.html#ab28df2db356d20638408f1021df8b410">00089</a> <a class="code" href="class_l_d_p.html#ab28df2db356d20638408f1021df8b410">LDP::~LDP</a>()
<a name="l00090"></a>00090 {
<a name="l00091"></a>00091     <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i&lt;<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size(); i++)
<a name="l00092"></a>00092         cancelAndDelete(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout);
<a name="l00093"></a>00093 
<a name="l00094"></a>00094     cancelAndDelete(<a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a>);
<a name="l00095"></a>00095     <span class="comment">//this causes segfault at the end of simulation       -- Vojta</span>
<a name="l00096"></a>00096     <span class="comment">//socketMap.deleteSockets();</span>
<a name="l00097"></a>00097 }
<a name="l00098"></a>00098 
<a name="l00099"></a><a class="code" href="class_l_d_p.html#a62dffe5f68da37887959520d2d9c8aa9">00099</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a62dffe5f68da37887959520d2d9c8aa9">LDP::initialize</a>(<span class="keywordtype">int</span> stage)
<a name="l00100"></a>00100 {
<a name="l00101"></a>00101     <span class="keywordflow">if</span> (stage != 3)
<a name="l00102"></a>00102         <span class="keywordflow">return</span>; <span class="comment">// wait for routing table to initialize first</span>
<a name="l00103"></a>00103 
<a name="l00104"></a>00104     <a class="code" href="class_l_d_p.html#adc72dc310e10bc94348b8ba0441730bd">holdTime</a> = par(<span class="stringliteral">&quot;holdTime&quot;</span>).doubleValue();
<a name="l00105"></a>00105     <a class="code" href="class_l_d_p.html#a64dabef28e6cf564b2cdfa47f11e31d5">helloInterval</a> = par(<span class="stringliteral">&quot;helloInterval&quot;</span>).doubleValue();
<a name="l00106"></a>00106 
<a name="l00107"></a>00107     <a class="code" href="class_l_d_p.html#ae0de7c03b5ac9168386ed3cd6f920c3e">ift</a> = <a class="code" href="class_interface_table_access.html">InterfaceTableAccess</a>().get();
<a name="l00108"></a>00108     <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a> = <a class="code" href="class_routing_table_access.html">RoutingTableAccess</a>().get();
<a name="l00109"></a>00109     <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a> = <a class="code" href="class_l_i_b_table_access.html">LIBTableAccess</a>().get();
<a name="l00110"></a>00110     <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a> = <a class="code" href="class_t_e_d_access.html">TEDAccess</a>().get();
<a name="l00111"></a>00111     <a class="code" href="class_l_d_p.html#a6cd3cdeb303dcbcd51acecae0615ffbd">nb</a> = <a class="code" href="class_notification_board_access.html">NotificationBoardAccess</a>().get();
<a name="l00112"></a>00112 
<a name="l00113"></a>00113     WATCH_VECTOR(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>);
<a name="l00114"></a>00114     WATCH_VECTOR(<a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>);
<a name="l00115"></a>00115     WATCH_VECTOR(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>);
<a name="l00116"></a>00116     WATCH_VECTOR(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>);
<a name="l00117"></a>00117     WATCH_VECTOR(<a class="code" href="class_l_d_p.html#a057aa332bfc1ddcbc2d66e73de161af9">pending</a>);
<a name="l00118"></a>00118 
<a name="l00119"></a>00119     <a class="code" href="class_l_d_p.html#aa95d15f32ce708d1cc9817586ad05857">maxFecid</a> = 0;
<a name="l00120"></a>00120 
<a name="l00121"></a>00121     <span class="comment">// schedule first hello</span>
<a name="l00122"></a>00122     <a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;LDPSendHello&quot;</span>);
<a name="l00123"></a>00123     scheduleAt(simTime() + exponential(0.1), <a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a>);
<a name="l00124"></a>00124 
<a name="l00125"></a>00125     <span class="comment">// bind UDP socket</span>
<a name="l00126"></a>00126     <a class="code" href="class_l_d_p.html#a70faa45ced5c6b6f18c5015bae134956">udpSocket</a>.<a class="code" href="class_u_d_p_socket.html#a606e9a6e14bcd2e68bb2906b0dc5a6b7">setOutputGate</a>(gate(<span class="stringliteral">&quot;udpOut&quot;</span>));
<a name="l00127"></a>00127     <a class="code" href="class_l_d_p.html#a70faa45ced5c6b6f18c5015bae134956">udpSocket</a>.<a class="code" href="class_u_d_p_socket.html#a4f85cea0efe5b7963fbc4103bad665c3">bind</a>(<a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="comment">// start listening for incoming TCP conns</span>
<a name="l00130"></a>00130     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Starting to listen on port &quot;</span> &lt;&lt; <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a> &lt;&lt; <span class="stringliteral">&quot; for incoming LDP sessions\n&quot;</span>;
<a name="l00131"></a>00131     <a class="code" href="class_l_d_p.html#ae42af8d69e1e21c9dc7ac7f6fe7a35bc">serverSocket</a>.<a class="code" href="class_t_c_p_socket.html#ab6563d5ef32687b2072e5c08317ba519">setOutputGate</a>(gate(<span class="stringliteral">&quot;tcpOut&quot;</span>));
<a name="l00132"></a>00132     <a class="code" href="class_l_d_p.html#ae42af8d69e1e21c9dc7ac7f6fe7a35bc">serverSocket</a>.<a class="code" href="class_t_c_p_socket.html#a2c4f6131103b0c9773728d706140aa0d">bind</a>(LDP_PORT);
<a name="l00133"></a>00133     <a class="code" href="class_l_d_p.html#ae42af8d69e1e21c9dc7ac7f6fe7a35bc">serverSocket</a>.<a class="code" href="class_t_c_p_socket.html#abfd870650b679461fa75fbe473c89d30">listen</a>();
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="comment">// build list of recognized FECs</span>
<a name="l00136"></a>00136     <a class="code" href="class_l_d_p.html#a4f61fee380b47683aef8f450b4704940">rebuildFecList</a>();
<a name="l00137"></a>00137 
<a name="l00138"></a>00138     <span class="comment">// listen for routing table modifications</span>
<a name="l00139"></a>00139     <a class="code" href="class_l_d_p.html#a6cd3cdeb303dcbcd51acecae0615ffbd">nb</a>-&gt;<a class="code" href="class_notification_board.html#aeb02a282e6c807c1cb064a28e8409ff2">subscribe</a>(<span class="keyword">this</span>, <a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba38a4632902da5c126d1b1bc992799303">NF_IPv4_ROUTE_ADDED</a>);
<a name="l00140"></a>00140     <a class="code" href="class_l_d_p.html#a6cd3cdeb303dcbcd51acecae0615ffbd">nb</a>-&gt;<a class="code" href="class_notification_board.html#aeb02a282e6c807c1cb064a28e8409ff2">subscribe</a>(<span class="keyword">this</span>, <a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba250243f132a5001e082e2c58b25eb0f1">NF_IPv4_ROUTE_DELETED</a>);
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 
<a name="l00143"></a><a class="code" href="class_l_d_p.html#a68767ac9540ebd2165892d2a2a7c7fbb">00143</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a68767ac9540ebd2165892d2a2a7c7fbb">LDP::handleMessage</a>(cMessage *msg)
<a name="l00144"></a>00144 {
<a name="l00145"></a>00145     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Received: (&quot;</span> &lt;&lt; msg-&gt;getClassName() &lt;&lt; <span class="stringliteral">&quot;)&quot;</span> &lt;&lt; msg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00146"></a>00146     <span class="keywordflow">if</span> (msg==<a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a>)
<a name="l00147"></a>00147     {
<a name="l00148"></a>00148         <span class="comment">// every LDP capable router periodically sends HELLO messages to the</span>
<a name="l00149"></a>00149         <span class="comment">// &quot;all routers in the sub-network&quot; multicast address</span>
<a name="l00150"></a>00150         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Multicasting LDP Hello to neighboring routers\n&quot;</span>;
<a name="l00151"></a>00151         <a class="code" href="class_l_d_p.html#af8f8d5cf6344ca5fa0c0ee4656f60f89">sendHelloTo</a>(<a class="code" href="class_i_p_address.html#a06a37c2c04f547c86017875d353ea3eb" title="224.0.0.2 All routers on a subnet">IPAddress::ALL_ROUTERS_MCAST</a>);
<a name="l00152"></a>00152 
<a name="l00153"></a>00153         <span class="comment">// schedule next hello</span>
<a name="l00154"></a>00154         scheduleAt(simTime() + <a class="code" href="class_l_d_p.html#a64dabef28e6cf564b2cdfa47f11e31d5">helloInterval</a>, <a class="code" href="class_l_d_p.html#a326553c22a6176ba6ee7afcb4647815e">sendHelloMsg</a>);
<a name="l00155"></a>00155     }
<a name="l00156"></a>00156     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msg-&gt;isSelfMessage())
<a name="l00157"></a>00157     {
<a name="l00158"></a>00158         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Timer &quot;</span> &lt;&lt; msg-&gt;getName() &lt;&lt; <span class="stringliteral">&quot; expired\n&quot;</span>;
<a name="l00159"></a>00159         <span class="keywordflow">if</span> (!strcmp(msg-&gt;getName(), <span class="stringliteral">&quot;HelloTimeout&quot;</span>))
<a name="l00160"></a>00160         {
<a name="l00161"></a>00161             <a class="code" href="class_l_d_p.html#aa11dcfcdebea0304d26343746d28eb6c">processHelloTimeout</a>(msg);
<a name="l00162"></a>00162         }
<a name="l00163"></a>00163         <span class="keywordflow">else</span>
<a name="l00164"></a>00164         {
<a name="l00165"></a>00165             <a class="code" href="class_l_d_p.html#aba440f5b0dc9e2ee2a8360388a8503bc">processNOTIFICATION</a>(check_and_cast&lt;LDPNotify*&gt;(msg));
<a name="l00166"></a>00166         }
<a name="l00167"></a>00167     }
<a name="l00168"></a>00168     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(msg-&gt;getArrivalGate()-&gt;getName(), <span class="stringliteral">&quot;udpIn&quot;</span>))
<a name="l00169"></a>00169     {
<a name="l00170"></a>00170         <span class="comment">// we can only receive LDP Hello from UDP (everything else goes over TCP)</span>
<a name="l00171"></a>00171         <a class="code" href="class_l_d_p.html#a129493952b252d5c5d426c4056197a4f">processLDPHello</a>(check_and_cast&lt;LDPHello *&gt;(msg));
<a name="l00172"></a>00172     }
<a name="l00173"></a>00173     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(msg-&gt;getArrivalGate()-&gt;getName(), <span class="stringliteral">&quot;tcpIn&quot;</span>))
<a name="l00174"></a>00174     {
<a name="l00175"></a>00175         <a class="code" href="class_l_d_p.html#ae2a3dbb01c3f0c5b317271bb50abd98f">processMessageFromTCP</a>(msg);
<a name="l00176"></a>00176     }
<a name="l00177"></a>00177 }
<a name="l00178"></a>00178 
<a name="l00179"></a><a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">00179</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">LDP::sendToPeer</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> dest, cMessage *msg)
<a name="l00180"></a>00180 {
<a name="l00181"></a>00181     <a class="code" href="class_l_d_p.html#a37df6239993d84988793c63eaf8f1940">getPeerSocket</a>(dest)-&gt;<a class="code" href="class_t_c_p_socket.html#a5bd53af740d4cde0d5460fdf481e7a7a">send</a>(msg);
<a name="l00182"></a>00182 }
<a name="l00183"></a>00183 
<a name="l00184"></a><a class="code" href="class_l_d_p.html#a27a71323af2adb9a34afc88393757312">00184</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a27a71323af2adb9a34afc88393757312">LDP::sendMappingRequest</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> dest, <a class="code" href="class_i_p_address.html">IPAddress</a> addr, <span class="keywordtype">int</span> length)
<a name="l00185"></a>00185 {
<a name="l00186"></a>00186     <a class="code" href="class_l_d_p_label_request.html">LDPLabelRequest</a> *requestMsg = <span class="keyword">new</span> <a class="code" href="class_l_d_p_label_request.html">LDPLabelRequest</a>(<span class="stringliteral">&quot;Lb-Req&quot;</span>);
<a name="l00187"></a>00187     requestMsg-&gt;setByteLength(<a class="code" href="_l_d_p_packet__m_8h.html#ae5cdb34a890024cf1fb6cc148a76adfa">LDP_HEADER_BYTES</a>); <span class="comment">// FIXME find out actual length</span>
<a name="l00188"></a>00188     requestMsg-&gt;<a class="code" href="class_l_d_p_packet.html#a484a59e3cb14cb70dac6cbdf22f1fb9d">setType</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a13f9e4988522509bb13178c320a7f5c3">LABEL_REQUEST</a>);
<a name="l00189"></a>00189 
<a name="l00190"></a>00190     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec;
<a name="l00191"></a>00191     fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a> = addr;
<a name="l00192"></a>00192     fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a> = length;
<a name="l00193"></a>00193     requestMsg-&gt;<a class="code" href="class_l_d_p_label_request.html#ac96bd58a753d16999dcd22152ced455a">setFec</a>(fec);
<a name="l00194"></a>00194 
<a name="l00195"></a>00195     requestMsg-&gt;<a class="code" href="class_l_d_p_packet.html#a4d67b67f693a22a8bdfa4ffdd6f0f07d">setReceiverAddress</a>(dest);
<a name="l00196"></a>00196     requestMsg-&gt;<a class="code" href="class_l_d_p_packet.html#ada5cc01f46a8d1285399bc4b84fb1006">setSenderAddress</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>());
<a name="l00197"></a>00197 
<a name="l00198"></a>00198     <a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">sendToPeer</a>(dest, requestMsg);
<a name="l00199"></a>00199 }
<a name="l00200"></a>00200 
<a name="l00201"></a><a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">00201</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">LDP::updateFecListEntry</a>(<a class="code" href="struct_l_d_p_1_1fec__t.html">LDP::fec_t</a> oldItem)
<a name="l00202"></a>00202 {
<a name="l00203"></a>00203     <span class="comment">// do we have mapping from downstream?</span>
<a name="l00204"></a>00204     FecBindVector::iterator dit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#afc947259edf916031b6a940e0cd64ae5">fecid</a>, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a>);
<a name="l00205"></a>00205 
<a name="l00206"></a>00206     <span class="comment">// is next hop our LDP peer?</span>
<a name="l00207"></a>00207     <span class="keywordtype">bool</span> ER = <a class="code" href="class_l_d_p.html#a43170c3c37870c56f321b8a2e24ec420">findPeerSocket</a>(oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a>)==NULL;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     ASSERT(!(ER &amp;&amp; dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())); <span class="comment">// can&apos;t be egress and have mapping at the same time</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211     <span class="comment">// adjust upstream mappings</span>
<a name="l00212"></a>00212     FecBindVector::iterator uit;
<a name="l00213"></a>00213     <span class="keywordflow">for</span> (uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.begin(); uit != <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end();)
<a name="l00214"></a>00214     {
<a name="l00215"></a>00215         <span class="keywordflow">if</span> (uit-&gt;fecid != oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#afc947259edf916031b6a940e0cd64ae5">fecid</a>)
<a name="l00216"></a>00216         {
<a name="l00217"></a>00217                 uit++;
<a name="l00218"></a>00218             <span class="keywordflow">continue</span>;
<a name="l00219"></a>00219         }
<a name="l00220"></a>00220 
<a name="l00221"></a>00221         std::string inInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(uit-&gt;peer);
<a name="l00222"></a>00222         std::string outInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a>);
<a name="l00223"></a>00223         <span class="keywordflow">if</span> (ER)
<a name="l00224"></a>00224         {
<a name="l00225"></a>00225             <span class="comment">// we are egress, that&apos;s easy:</span>
<a name="l00226"></a>00226             <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a> outLabel = <a class="code" href="class_l_i_b_table.html#ad7eebe93833f85b136e60bc6ac30941e">LIBTable::popLabel</a>();
<a name="l00227"></a>00227             uit-&gt;label = <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a6599a694b9035a18dbc01bd0c52b54f7">installLibEntry</a>(uit-&gt;label, inInterface, outLabel, outInterface, <a class="code" href="_l_d_p_8h.html#a819e3794dd985814c77459acdb71042f">LDP_USER_TRAFFIC</a>);
<a name="l00228"></a>00228 
<a name="l00229"></a>00229             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;installed (egress) LIB entry inLabel=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; inInterface=&quot;</span> &lt;&lt; inInterface &lt;&lt;
<a name="l00230"></a>00230                     <span class="stringliteral">&quot; outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot; outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l00231"></a>00231             uit++;
<a name="l00232"></a>00232         }
<a name="l00233"></a>00233         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())
<a name="l00234"></a>00234         {
<a name="l00235"></a>00235             <span class="comment">// we have mapping from DS, that&apos;s easy</span>
<a name="l00236"></a>00236             <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a> outLabel = <a class="code" href="class_l_i_b_table.html#adc5fdcd5d807e663b467ff91e719873f">LIBTable::swapLabel</a>(dit-&gt;label);
<a name="l00237"></a>00237             uit-&gt;label = <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a6599a694b9035a18dbc01bd0c52b54f7">installLibEntry</a>(uit-&gt;label, inInterface, outLabel, outInterface, <a class="code" href="_l_d_p_8h.html#a819e3794dd985814c77459acdb71042f">LDP_USER_TRAFFIC</a>);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;installed LIB entry inLabel=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; inInterface=&quot;</span> &lt;&lt; inInterface &lt;&lt;
<a name="l00240"></a>00240                     <span class="stringliteral">&quot; outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot; outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l00241"></a>00241             uit++;
<a name="l00242"></a>00242         }
<a name="l00243"></a>00243         <span class="keywordflow">else</span>
<a name="l00244"></a>00244         {
<a name="l00245"></a>00245             <span class="comment">// no mapping from DS, withdraw mapping US</span>
<a name="l00246"></a>00246             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending withdraw message upstream&quot;</span> &lt;&lt; endl;
<a name="l00247"></a>00247             <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a7fd292325bd8d0d4a4d466f1e969c494">LABEL_WITHDRAW</a>, uit-&gt;peer, uit-&gt;label, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a56c9f3a1e36f0a59c7e624cf5c3592dc">addr</a>, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249             <span class="comment">// remove from US mappings</span>
<a name="l00250"></a>00250             uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.erase(uit);
<a name="l00251"></a>00251         }
<a name="l00252"></a>00252     }
<a name="l00253"></a>00253 
<a name="l00254"></a>00254     <span class="keywordflow">if</span> (!ER &amp;&amp; dit == <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())
<a name="l00255"></a>00255     {
<a name="l00256"></a>00256         <span class="comment">// and ask DS for mapping</span>
<a name="l00257"></a>00257         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending request message downstream&quot;</span> &lt;&lt; endl;
<a name="l00258"></a>00258         <a class="code" href="class_l_d_p.html#a27a71323af2adb9a34afc88393757312">sendMappingRequest</a>(oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a>, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a56c9f3a1e36f0a59c7e624cf5c3592dc">addr</a>, oldItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a>);
<a name="l00259"></a>00259     }
<a name="l00260"></a>00260 }
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="class_l_d_p.html#a4f61fee380b47683aef8f450b4704940">00262</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a4f61fee380b47683aef8f450b4704940">LDP::rebuildFecList</a>()
<a name="l00263"></a>00263 {
<a name="l00264"></a>00264     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;make list of recognized FECs&quot;</span> &lt;&lt; endl;
<a name="l00265"></a>00265 
<a name="l00266"></a>00266     <a class="code" href="class_l_d_p.html#a8885142cabdbcdfb12cb843004e106b9">FecVector</a> oldList = <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>;
<a name="l00267"></a>00267     <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.clear();
<a name="l00268"></a>00268 
<a name="l00269"></a>00269     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#ada2fac98d1d1c80c291be239b075c63b">getNumRoutes</a>(); i++)
<a name="l00270"></a>00270     {
<a name="l00271"></a>00271         <span class="comment">// every entry in the routing table</span>
<a name="l00272"></a>00272 
<a name="l00273"></a>00273         <span class="keyword">const</span> <a class="code" href="class_i_p_route.html">IPRoute</a> *re = <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a89f3eb433e309043cde517238eef5214">getRoute</a>(i);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <span class="comment">// ignore multicast routes</span>
<a name="l00276"></a>00276         <span class="keywordflow">if</span> (re-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>().<a class="code" href="class_i_p_address.html#a9b6b5a118e8e1f6f83f2ccffd5a72125">isMulticast</a>())
<a name="l00277"></a>00277             <span class="keywordflow">continue</span>;
<a name="l00278"></a>00278 
<a name="l00279"></a>00279         <span class="comment">// find out current next hop according to routing table</span>
<a name="l00280"></a>00280         <a class="code" href="class_i_p_address.html">IPAddress</a> nextHop = (re-&gt;<a class="code" href="class_i_p_route.html#ae1e091d2b6a8492e36c3b7bac483e7af">getType</a>() == <a class="code" href="class_i_p_route.html#affdd22b24049e9d8d991b955a973d32eab46216a10952298ab9565997122d7225" title="Directly attached to the router.">IPRoute::DIRECT</a>) ? re-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>() : re-&gt;<a class="code" href="class_i_p_route.html#aa1aa349eb850c0d9acb3f01ba0ee61d5">getGateway</a>();
<a name="l00281"></a>00281         ASSERT(!nextHop.<a class="code" href="class_i_p_address.html#a7fb3c274d7a8600be890f83c028d5f96">isUnspecified</a>());
<a name="l00282"></a>00282 
<a name="l00283"></a>00283         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;nextHop &lt;-- &quot;</span> &lt;&lt; nextHop &lt;&lt; endl;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285         FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(oldList, re-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>(), re-&gt;<a class="code" href="class_i_p_route.html#ad69bc8024a13bf6ec528e9afdf1aa7e1">getNetmask</a>().<a class="code" href="class_i_p_address.html#abf9da0dfc5c11a7b09260060207b0fc9">getNetmaskLength</a>());
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (it == oldList.end())
<a name="l00288"></a>00288         {
<a name="l00289"></a>00289             <span class="comment">// fec didn&apos;t exist, it was just created</span>
<a name="l00290"></a>00290             <a class="code" href="struct_l_d_p_1_1fec__t.html">fec_t</a> newItem;
<a name="l00291"></a>00291             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#afc947259edf916031b6a940e0cd64ae5">fecid</a> = ++<a class="code" href="class_l_d_p.html#aa95d15f32ce708d1cc9817586ad05857">maxFecid</a>;
<a name="l00292"></a>00292             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a56c9f3a1e36f0a59c7e624cf5c3592dc">addr</a> = re-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>();
<a name="l00293"></a>00293             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a> = re-&gt;<a class="code" href="class_i_p_route.html#ad69bc8024a13bf6ec528e9afdf1aa7e1">getNetmask</a>().<a class="code" href="class_i_p_address.html#abf9da0dfc5c11a7b09260060207b0fc9">getNetmaskLength</a>();
<a name="l00294"></a>00294             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a> = nextHop;
<a name="l00295"></a>00295             <a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">updateFecListEntry</a>(newItem);
<a name="l00296"></a>00296             <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.push_back(newItem);
<a name="l00297"></a>00297         }
<a name="l00298"></a>00298         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (it-&gt;nextHop != nextHop)
<a name="l00299"></a>00299         {
<a name="l00300"></a>00300             <span class="comment">// next hop for this FEC changed,</span>
<a name="l00301"></a>00301             it-&gt;nextHop = nextHop;
<a name="l00302"></a>00302             <a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">updateFecListEntry</a>(*it);
<a name="l00303"></a>00303             <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.push_back(*it);
<a name="l00304"></a>00304             oldList.erase(it);
<a name="l00305"></a>00305         }
<a name="l00306"></a>00306         <span class="keywordflow">else</span>
<a name="l00307"></a>00307         {
<a name="l00308"></a>00308             <span class="comment">// FEC didn&apos;t change, reusing old values</span>
<a name="l00309"></a>00309             <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.push_back(*it);
<a name="l00310"></a>00310             oldList.erase(it);
<a name="l00311"></a>00311             <span class="keywordflow">continue</span>;
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313     }
<a name="l00314"></a>00314 
<a name="l00315"></a>00315 
<a name="l00316"></a>00316     <span class="comment">// our own addresses (XXX is it needed?)</span>
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i&lt; <a class="code" href="class_l_d_p.html#ae0de7c03b5ac9168386ed3cd6f920c3e">ift</a>-&gt;<a class="code" href="class_i_interface_table.html#a2b0ce46cd92da6f64fc363410dc71904">getNumInterfaces</a>(); ++i)
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320         <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *ie = <a class="code" href="class_l_d_p.html#ae0de7c03b5ac9168386ed3cd6f920c3e">ift</a>-&gt;<a class="code" href="class_i_interface_table.html#a19ce4ca3b47b52b8e2b67c25806c4b49">getInterface</a>(i);
<a name="l00321"></a>00321         <span class="keywordflow">if</span> (ie-&gt;<a class="code" href="class_interface_entry.html#a315657b6b5281241a69bed8e1171ef6f">getNetworkLayerGateIndex</a>() &lt; 0)
<a name="l00322"></a>00322             <span class="keywordflow">continue</span>;
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(oldList, ie-&gt;<a class="code" href="class_interface_entry.html#ad47857e772397cc2d00de3a8cf464993">ipv4Data</a>()-&gt;<a class="code" href="class_i_pv4_interface_data.html#aec8ebefd03acad479ac89d31d7228331">getIPAddress</a>(), 32);
<a name="l00325"></a>00325         <span class="keywordflow">if</span> (it == oldList.end())
<a name="l00326"></a>00326         {
<a name="l00327"></a>00327             <a class="code" href="struct_l_d_p_1_1fec__t.html">fec_t</a> newItem;
<a name="l00328"></a>00328             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#afc947259edf916031b6a940e0cd64ae5">fecid</a> = ++<a class="code" href="class_l_d_p.html#aa95d15f32ce708d1cc9817586ad05857">maxFecid</a>;
<a name="l00329"></a>00329             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a56c9f3a1e36f0a59c7e624cf5c3592dc">addr</a> = ie-&gt;<a class="code" href="class_interface_entry.html#ad47857e772397cc2d00de3a8cf464993">ipv4Data</a>()-&gt;<a class="code" href="class_i_pv4_interface_data.html#aec8ebefd03acad479ac89d31d7228331">getIPAddress</a>();
<a name="l00330"></a>00330             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a61ca593ecfffd6a5a13466623d3f8ea8">length</a> = 32;
<a name="l00331"></a>00331             newItem.<a class="code" href="struct_l_d_p_1_1fec__t.html#a1a70d4a30cc8629549ffe3948c90f750">nextHop</a> = ie-&gt;<a class="code" href="class_interface_entry.html#ad47857e772397cc2d00de3a8cf464993">ipv4Data</a>()-&gt;<a class="code" href="class_i_pv4_interface_data.html#aec8ebefd03acad479ac89d31d7228331">getIPAddress</a>();
<a name="l00332"></a>00332             <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.push_back(newItem);
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334         <span class="keywordflow">else</span>
<a name="l00335"></a>00335         {
<a name="l00336"></a>00336             <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.push_back(*it);
<a name="l00337"></a>00337             oldList.erase(it);
<a name="l00338"></a>00338         }
<a name="l00339"></a>00339     }
<a name="l00340"></a>00340 
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (oldList.size() &gt; 0)
<a name="l00342"></a>00342     {
<a name="l00343"></a>00343         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;there are &quot;</span> &lt;&lt; oldList.size() &lt;&lt; <span class="stringliteral">&quot; deprecated FECs, removing them&quot;</span> &lt;&lt; endl;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         FecVector::iterator it;
<a name="l00346"></a>00346         <span class="keywordflow">for</span> (it = oldList.begin(); it != oldList.end(); it++)
<a name="l00347"></a>00347         {
<a name="l00348"></a>00348             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing FEC= &quot;</span> &lt;&lt; *it &lt;&lt; endl;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350             FecBindVector::iterator dit;
<a name="l00351"></a>00351             <span class="keywordflow">for</span> (dit = <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.begin(); dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end(); dit++)
<a name="l00352"></a>00352             {
<a name="l00353"></a>00353                 <span class="keywordflow">if</span> (dit-&gt;fecid != it-&gt;fecid)
<a name="l00354"></a>00354                     <span class="keywordflow">continue</span>;
<a name="l00355"></a>00355 
<a name="l00356"></a>00356                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending release label=&quot;</span> &lt;&lt; dit-&gt;label &lt;&lt; <span class="stringliteral">&quot; downstream to &quot;</span> &lt;&lt; dit-&gt;peer &lt;&lt; endl;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358                 <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3ad4cdfab707c90f09c9bd6481e3c2406d">LABEL_RELEASE</a>, dit-&gt;peer, dit-&gt;label, it-&gt;addr, it-&gt;length);
<a name="l00359"></a>00359             }
<a name="l00360"></a>00360 
<a name="l00361"></a>00361             FecBindVector::iterator uit;
<a name="l00362"></a>00362             <span class="keywordflow">for</span> (uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.begin(); uit != <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end(); uit++)
<a name="l00363"></a>00363             {
<a name="l00364"></a>00364                 <span class="keywordflow">if</span> (uit-&gt;fecid != it-&gt;fecid)
<a name="l00365"></a>00365                     <span class="keywordflow">continue</span>;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending withdraw label=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; upstream to &quot;</span> &lt;&lt; uit-&gt;peer &lt;&lt; endl;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369                 <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a7fd292325bd8d0d4a4d466f1e969c494">LABEL_WITHDRAW</a>, uit-&gt;peer, uit-&gt;label, it-&gt;addr, it-&gt;length);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing entry inLabel=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; from LIB&quot;</span> &lt;&lt; endl;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373                 <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#aeaf750f1e663ddd1a5a6e76406ad8a14">removeLibEntry</a>(uit-&gt;label);
<a name="l00374"></a>00374             }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376         }
<a name="l00377"></a>00377     }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379     <span class="comment">// we must keep this list sorted for matching to work correctly</span>
<a name="l00380"></a>00380     <span class="comment">// this is probably slower than it must be</span>
<a name="l00381"></a>00381     std::sort(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.begin(), <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end(), <a class="code" href="_l_d_p_8cc.html#a1e6892349ebc14dde68f926f1b8d87cd">fecPrefixCompare</a>);
<a name="l00382"></a>00382 }
<a name="l00383"></a>00383 
<a name="l00384"></a><a class="code" href="class_l_d_p.html#a33bd46c81cf3f06f6f082c9d67ff58c5">00384</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a33bd46c81cf3f06f6f082c9d67ff58c5">LDP::updateFecList</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> nextHop)
<a name="l00385"></a>00385 {
<a name="l00386"></a>00386     FecVector::iterator it;
<a name="l00387"></a>00387     <span class="keywordflow">for</span> (it = <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.begin(); it != <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end(); it++)
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="keywordflow">if</span> (it-&gt;nextHop != nextHop)
<a name="l00390"></a>00390             <span class="keywordflow">continue</span>;
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">updateFecListEntry</a>(*it);
<a name="l00393"></a>00393     }
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 
<a name="l00396"></a><a class="code" href="class_l_d_p.html#af8f8d5cf6344ca5fa0c0ee4656f60f89">00396</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#af8f8d5cf6344ca5fa0c0ee4656f60f89">LDP::sendHelloTo</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> dest)
<a name="l00397"></a>00397 {
<a name="l00398"></a>00398     <a class="code" href="class_l_d_p_hello.html">LDPHello</a> *hello = <span class="keyword">new</span> <a class="code" href="class_l_d_p_hello.html">LDPHello</a>(<span class="stringliteral">&quot;LDP-Hello&quot;</span>);
<a name="l00399"></a>00399     hello-&gt;setByteLength(<a class="code" href="_l_d_p_packet__m_8h.html#ae5cdb34a890024cf1fb6cc148a76adfa">LDP_HEADER_BYTES</a>);
<a name="l00400"></a>00400     hello-&gt;<a class="code" href="class_l_d_p_packet.html#a484a59e3cb14cb70dac6cbdf22f1fb9d">setType</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a572e2128aeb8cc392386eb1610a1fada">HELLO</a>);
<a name="l00401"></a>00401     hello-&gt;<a class="code" href="class_l_d_p_packet.html#ada5cc01f46a8d1285399bc4b84fb1006">setSenderAddress</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>());
<a name="l00402"></a>00402     <span class="comment">//hello-&gt;setReceiverAddress(...);</span>
<a name="l00403"></a>00403     hello-&gt;<a class="code" href="class_l_d_p_hello.html#afb78fc31757757eca4fe225c2ff59650">setHoldTime</a>(SIMTIME_DBL(<a class="code" href="class_l_d_p.html#adc72dc310e10bc94348b8ba0441730bd">holdTime</a>));
<a name="l00404"></a>00404     <span class="comment">//hello-&gt;setRbit(...);</span>
<a name="l00405"></a>00405     <span class="comment">//hello-&gt;setTbit(...);</span>
<a name="l00406"></a>00406     hello-&gt;addPar(<span class="stringliteral">&quot;color&quot;</span>) = <a class="code" href="_l_d_p_8h.html#ac61edad3b726cd30ff860a571266ff50">LDP_HELLO_TRAFFIC</a>;
<a name="l00407"></a>00407 
<a name="l00408"></a>00408     <a class="code" href="class_l_d_p.html#a70faa45ced5c6b6f18c5015bae134956">udpSocket</a>.<a class="code" href="class_u_d_p_socket.html#ae24c4132eb222af55be418025c6b20e9">sendTo</a>(hello, dest, <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>);
<a name="l00409"></a>00409 }
<a name="l00410"></a>00410 
<a name="l00411"></a><a class="code" href="class_l_d_p.html#aa11dcfcdebea0304d26343746d28eb6c">00411</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#aa11dcfcdebea0304d26343746d28eb6c">LDP::processHelloTimeout</a>(cMessage *msg)
<a name="l00412"></a>00412 {
<a name="l00413"></a>00413     <span class="comment">// peer is gone</span>
<a name="l00414"></a>00414 
<a name="l00415"></a>00415     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l00416"></a>00416     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size(); i++)
<a name="l00417"></a>00417         <span class="keywordflow">if</span> (<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout == msg)
<a name="l00418"></a>00418             <span class="keywordflow">break</span>;
<a name="l00419"></a>00419     ASSERT(i &lt; <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size());
<a name="l00420"></a>00420 
<a name="l00421"></a>00421     <a class="code" href="class_i_p_address.html">IPAddress</a> peerIP = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].peerIP;
<a name="l00422"></a>00422 
<a name="l00423"></a>00423     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;peer=&quot;</span> &lt;&lt; peerIP &lt;&lt; <span class="stringliteral">&quot; is gone, removing adjacency&quot;</span> &lt;&lt; endl;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425     ASSERT(!<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout-&gt;isScheduled());
<a name="l00426"></a>00426     <span class="keyword">delete</span> <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout;
<a name="l00427"></a>00427     ASSERT(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket);
<a name="l00428"></a>00428     <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket-&gt;abort(); <span class="comment">// should we only close?</span>
<a name="l00429"></a>00429     <span class="keyword">delete</span> <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket;
<a name="l00430"></a>00430     <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.erase(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.begin() + i);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing (stale) bindings from fecDown for peer=&quot;</span> &lt;&lt; peerIP &lt;&lt; endl;
<a name="l00433"></a>00433 
<a name="l00434"></a>00434     FecBindVector::iterator dit;
<a name="l00435"></a>00435     <span class="keywordflow">for</span> (dit = <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.begin(); dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end();)
<a name="l00436"></a>00436     {
<a name="l00437"></a>00437         <span class="keywordflow">if</span> (dit-&gt;peer != peerIP)
<a name="l00438"></a>00438         {
<a name="l00439"></a>00439                 dit++;
<a name="l00440"></a>00440             <span class="keywordflow">continue</span>;
<a name="l00441"></a>00441         }
<a name="l00442"></a>00442 
<a name="l00443"></a>00443         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;label=&quot;</span> &lt;&lt; dit-&gt;label &lt;&lt; endl;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445         <span class="comment">// send release message just in case (?)</span>
<a name="l00446"></a>00446         <span class="comment">// what happens if peer is not really down and</span>
<a name="l00447"></a>00447         <span class="comment">// hello messages just disappeared?</span>
<a name="l00448"></a>00448         <span class="comment">// does the protocol recover on its own (XXX check this)</span>
<a name="l00449"></a>00449 
<a name="l00450"></a>00450         dit = <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.erase(dit);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing bindings from sent to peer=&quot;</span> &lt;&lt; peerIP &lt;&lt; <span class="stringliteral">&quot; from fecUp&quot;</span> &lt;&lt; endl;
<a name="l00454"></a>00454 
<a name="l00455"></a>00455     FecBindVector::iterator uit;
<a name="l00456"></a>00456     <span class="keywordflow">for</span> (uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.begin(); uit != <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end();)
<a name="l00457"></a>00457     {
<a name="l00458"></a>00458         <span class="keywordflow">if</span> (uit-&gt;peer != peerIP)
<a name="l00459"></a>00459         {
<a name="l00460"></a>00460                 uit++;
<a name="l00461"></a>00461             <span class="keywordflow">continue</span>;
<a name="l00462"></a>00462         }
<a name="l00463"></a>00463 
<a name="l00464"></a>00464         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;label=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; endl;
<a name="l00465"></a>00465 
<a name="l00466"></a>00466         <span class="comment">// send withdraw message just in case (?)</span>
<a name="l00467"></a>00467         <span class="comment">// see comment above...</span>
<a name="l00468"></a>00468 
<a name="l00469"></a>00469         uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.erase(uit);
<a name="l00470"></a>00470     }
<a name="l00471"></a>00471 
<a name="l00472"></a>00472     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;updating fecList&quot;</span> &lt;&lt; endl;
<a name="l00473"></a>00473 
<a name="l00474"></a>00474     <a class="code" href="class_l_d_p.html#a33bd46c81cf3f06f6f082c9d67ff58c5">updateFecList</a>(peerIP);
<a name="l00475"></a>00475 
<a name="l00476"></a>00476     <span class="comment">// update TED and routing table</span>
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index = <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#aff4add6e86b7bc9ea84079aae0bb3e51">linkIndex</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>(), peerIP);
<a name="l00479"></a>00479     <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#a8ab5c356644784262be0ae484395441e">ted</a>[index].state = <span class="keyword">false</span>;
<a name="l00480"></a>00480     <a class="code" href="class_l_d_p.html#a62f103f31701a61dd42b6814770245fe">announceLinkChange</a>(index);
<a name="l00481"></a>00481     <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#a20dbae0b12fb78bc9771eba4e11f0edc">rebuildRoutingTable</a>();
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="class_l_d_p.html#a129493952b252d5c5d426c4056197a4f">00484</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a129493952b252d5c5d426c4056197a4f">LDP::processLDPHello</a>(<a class="code" href="class_l_d_p_hello.html">LDPHello</a> *msg)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486     <a class="code" href="class_u_d_p_control_info.html">UDPControlInfo</a> *controlInfo = check_and_cast&lt;<a class="code" href="class_u_d_p_control_info.html">UDPControlInfo</a> *&gt;(msg-&gt;getControlInfo());
<a name="l00487"></a>00487     <span class="comment">//IPAddress peerAddr = controlInfo-&gt;getSrcAddr().get4();</span>
<a name="l00488"></a>00488     <a class="code" href="class_i_p_address.html">IPAddress</a> peerAddr = msg-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l00489"></a>00489     <span class="keywordtype">int</span> interfaceId = controlInfo-&gt;<a class="code" href="class_u_d_p_control_info.html#a371cfc0b09b71bf2cb851dfcfdc37583">getInterfaceId</a>();
<a name="l00490"></a>00490     <span class="keyword">delete</span> msg;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Received LDP Hello from &quot;</span> &lt;&lt; peerAddr &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordflow">if</span> (peerAddr.isUnspecified() || peerAddr==<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>())
<a name="l00495"></a>00495     {
<a name="l00496"></a>00496         <span class="comment">// must be ourselves (we&apos;re also in the all-routers multicast group), ignore</span>
<a name="l00497"></a>00497         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;that&apos;s myself, ignore\n&quot;</span>;
<a name="l00498"></a>00498         <span class="keywordflow">return</span>;
<a name="l00499"></a>00499     }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501     <span class="comment">// mark link as working if it was failed, and rebuild table</span>
<a name="l00502"></a>00502     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> index = <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#aff4add6e86b7bc9ea84079aae0bb3e51">linkIndex</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>(), peerAddr);
<a name="l00503"></a>00503     <span class="keywordflow">if</span> (!<a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#a8ab5c356644784262be0ae484395441e">ted</a>[index].state)
<a name="l00504"></a>00504     {
<a name="l00505"></a>00505         <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#a8ab5c356644784262be0ae484395441e">ted</a>[index].state = <span class="keyword">true</span>;
<a name="l00506"></a>00506         <a class="code" href="class_l_d_p.html#a0acc2a4c56957b0b30f0e8a6b2c2075f">tedmod</a>-&gt;<a class="code" href="class_t_e_d.html#a20dbae0b12fb78bc9771eba4e11f0edc">rebuildRoutingTable</a>();
<a name="l00507"></a>00507         <a class="code" href="class_l_d_p.html#a62f103f31701a61dd42b6814770245fe">announceLinkChange</a>(index);
<a name="l00508"></a>00508     }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510     <span class="comment">// peer already in table?</span>
<a name="l00511"></a>00511     <span class="keywordtype">int</span> i = <a class="code" href="class_l_d_p.html#aaf2b4ec7ae7b2006fccd8d208dfbb471">findPeer</a>(peerAddr);
<a name="l00512"></a>00512     <span class="keywordflow">if</span> (i!=-1)
<a name="l00513"></a>00513     {
<a name="l00514"></a>00514         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;already in my peer table, rescheduling timeout&quot;</span> &lt;&lt; endl;
<a name="l00515"></a>00515         ASSERT(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout);
<a name="l00516"></a>00516         cancelEvent(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout);
<a name="l00517"></a>00517         scheduleAt(simTime() + <a class="code" href="class_l_d_p.html#adc72dc310e10bc94348b8ba0441730bd">holdTime</a>, <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].timeout);
<a name="l00518"></a>00518         <span class="keywordflow">return</span>;
<a name="l00519"></a>00519     }
<a name="l00520"></a>00520 
<a name="l00521"></a>00521     <span class="comment">// not in table, add it</span>
<a name="l00522"></a>00522     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a> info;
<a name="l00523"></a>00523     info.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> = peerAddr;
<a name="l00524"></a>00524     info.<a class="code" href="struct_l_d_p_1_1peer__info.html#abff497458c90c3d73c3080622c6b5adf">linkInterface</a> = <a class="code" href="class_l_d_p.html#ae0de7c03b5ac9168386ed3cd6f920c3e">ift</a>-&gt;<a class="code" href="class_i_interface_table.html#a92764d620c345b7261de20e9ee5247d7">getInterfaceById</a>(interfaceId)-&gt;getName();
<a name="l00525"></a>00525     info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a4606158df7b7582064c78e9372bdc353">activeRole</a> = peerAddr.getInt() &gt; <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>().<a class="code" href="class_i_p_address.html#a807ca46964a8403cf0c70f0772179524">getInt</a>();
<a name="l00526"></a>00526     info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a52a748a6dc9b4d6ab9262305b8a60964">socket</a> = NULL;
<a name="l00527"></a>00527     info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a62967702478b92e023d7878be08c1208">timeout</a> = <span class="keyword">new</span> cMessage(<span class="stringliteral">&quot;HelloTimeout&quot;</span>);
<a name="l00528"></a>00528     scheduleAt(simTime() + <a class="code" href="class_l_d_p.html#adc72dc310e10bc94348b8ba0441730bd">holdTime</a>, info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a62967702478b92e023d7878be08c1208">timeout</a>);
<a name="l00529"></a>00529     <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.push_back(info);
<a name="l00530"></a>00530     <span class="keywordtype">int</span> peerIndex = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size()-1;
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;added to peer table\n&quot;</span>;
<a name="l00533"></a>00533     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;We&apos;ll be &quot;</span> &lt;&lt; (info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a4606158df7b7582064c78e9372bdc353">activeRole</a> ? <span class="stringliteral">&quot;ACTIVE&quot;</span> : <span class="stringliteral">&quot;PASSIVE&quot;</span>) &lt;&lt; <span class="stringliteral">&quot; in this session\n&quot;</span>;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535     <span class="comment">// introduce ourselves with a Hello, then connect if we&apos;re in ACTIVE role</span>
<a name="l00536"></a>00536     <a class="code" href="class_l_d_p.html#af8f8d5cf6344ca5fa0c0ee4656f60f89">sendHelloTo</a>(peerAddr);
<a name="l00537"></a>00537     <span class="keywordflow">if</span> (info.<a class="code" href="struct_l_d_p_1_1peer__info.html#a4606158df7b7582064c78e9372bdc353">activeRole</a>)
<a name="l00538"></a>00538     {
<a name="l00539"></a>00539         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Establishing session with it\n&quot;</span>;
<a name="l00540"></a>00540         <a class="code" href="class_l_d_p.html#a3a85856691c0af7af8d927f80a4e3eca">openTCPConnectionToPeer</a>(peerIndex);
<a name="l00541"></a>00541     }
<a name="l00542"></a>00542 }
<a name="l00543"></a>00543 
<a name="l00544"></a><a class="code" href="class_l_d_p.html#a3a85856691c0af7af8d927f80a4e3eca">00544</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a3a85856691c0af7af8d927f80a4e3eca">LDP::openTCPConnectionToPeer</a>(<span class="keywordtype">int</span> peerIndex)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546     <a class="code" href="class_t_c_p_socket.html">TCPSocket</a> *socket = <span class="keyword">new</span> <a class="code" href="class_t_c_p_socket.html">TCPSocket</a>();
<a name="l00547"></a>00547     socket-&gt;<a class="code" href="class_t_c_p_socket.html#ab6563d5ef32687b2072e5c08317ba519">setOutputGate</a>(gate(<span class="stringliteral">&quot;tcpOut&quot;</span>));
<a name="l00548"></a>00548     socket-&gt;<a class="code" href="class_t_c_p_socket.html#a5aa6b7b21ebe1f98801eade44e0de8eb">setCallbackObject</a>(<span class="keyword">this</span>, (<span class="keywordtype">void</span>*)peerIndex);
<a name="l00549"></a>00549     socket-&gt;<a class="code" href="class_t_c_p_socket.html#a2c4f6131103b0c9773728d706140aa0d">bind</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>(), 0);
<a name="l00550"></a>00550     <a class="code" href="class_l_d_p.html#a168d3444b4455a308d211a24b089b5a4">socketMap</a>.<a class="code" href="class_t_c_p_socket_map.html#ac19937a0e8bd2dfcda6e7f831b835fd8">addSocket</a>(socket);
<a name="l00551"></a>00551     <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[peerIndex].socket = socket;
<a name="l00552"></a>00552 
<a name="l00553"></a>00553     socket-&gt;<a class="code" href="class_t_c_p_socket.html#a7223e3a9189b0b156516d84c188cea6d">connect</a>(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[peerIndex].peerIP, <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>);
<a name="l00554"></a>00554 }
<a name="l00555"></a>00555 
<a name="l00556"></a><a class="code" href="class_l_d_p.html#ae2a3dbb01c3f0c5b317271bb50abd98f">00556</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#ae2a3dbb01c3f0c5b317271bb50abd98f">LDP::processMessageFromTCP</a>(cMessage *msg)
<a name="l00557"></a>00557 {
<a name="l00558"></a>00558     <a class="code" href="class_t_c_p_socket.html">TCPSocket</a> *socket = <a class="code" href="class_l_d_p.html#a168d3444b4455a308d211a24b089b5a4">socketMap</a>.<a class="code" href="class_t_c_p_socket_map.html#ad96c686c0e0536b8b8e279728a53b17e">findSocketFor</a>(msg);
<a name="l00559"></a>00559     <span class="keywordflow">if</span> (!socket)
<a name="l00560"></a>00560     {
<a name="l00561"></a>00561         <span class="comment">// not yet in socketMap, must be new incoming connection.</span>
<a name="l00562"></a>00562         <span class="comment">// find which peer it is and register connection</span>
<a name="l00563"></a>00563         socket = <span class="keyword">new</span> <a class="code" href="class_t_c_p_socket.html">TCPSocket</a>(msg);
<a name="l00564"></a>00564         socket-&gt;<a class="code" href="class_t_c_p_socket.html#ab6563d5ef32687b2072e5c08317ba519">setOutputGate</a>(gate(<span class="stringliteral">&quot;tcpOut&quot;</span>));
<a name="l00565"></a>00565 
<a name="l00566"></a>00566         <span class="comment">// FIXME there seems to be some confusion here. Is it sure that</span>
<a name="l00567"></a>00567         <span class="comment">// routerIds we use as peerAddrs are the same as IP addresses</span>
<a name="l00568"></a>00568         <span class="comment">// the routing is based on? --Andras</span>
<a name="l00569"></a>00569         <a class="code" href="class_i_p_address.html">IPAddress</a> peerAddr = socket-&gt;<a class="code" href="class_t_c_p_socket.html#a0ac232127ecca9558ca205db643cf347">getRemoteAddress</a>().<a class="code" href="class_i_pv_x_address.html#a00acd2be0fc0f254afb2eb7540a4ea6e">get4</a>();
<a name="l00570"></a>00570 
<a name="l00571"></a>00571         <span class="keywordtype">int</span> i = <a class="code" href="class_l_d_p.html#aaf2b4ec7ae7b2006fccd8d208dfbb471">findPeer</a>(peerAddr);
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (i==-1 || <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket)
<a name="l00573"></a>00573         {
<a name="l00574"></a>00574             <span class="comment">// nothing known about this guy, or already connected: refuse</span>
<a name="l00575"></a>00575             socket-&gt;close(); <span class="comment">// reset()?</span>
<a name="l00576"></a>00576             <span class="keyword">delete</span> socket;
<a name="l00577"></a>00577             <span class="keyword">delete</span> msg;
<a name="l00578"></a>00578             <span class="keywordflow">return</span>;
<a name="l00579"></a>00579         }
<a name="l00580"></a>00580         <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket = socket;
<a name="l00581"></a>00581         socket-&gt;setCallbackObject(<span class="keyword">this</span>, (<span class="keywordtype">void</span> *)i);
<a name="l00582"></a>00582         <a class="code" href="class_l_d_p.html#a168d3444b4455a308d211a24b089b5a4">socketMap</a>.<a class="code" href="class_t_c_p_socket_map.html#ac19937a0e8bd2dfcda6e7f831b835fd8">addSocket</a>(socket);
<a name="l00583"></a>00583     }
<a name="l00584"></a>00584 
<a name="l00585"></a>00585     <span class="comment">// dispatch to socketEstablished(), socketDataArrived(), socketPeerClosed()</span>
<a name="l00586"></a>00586     <span class="comment">// or socketFailure()</span>
<a name="l00587"></a>00587     socket-&gt;<a class="code" href="class_t_c_p_socket.html#a5a4c2dd02c72e3cb0115a0490f408f07">processMessage</a>(msg);
<a name="l00588"></a>00588 }
<a name="l00589"></a>00589 
<a name="l00590"></a><a class="code" href="class_l_d_p.html#a014504d9ed3ccbb4a0366e95870eea56">00590</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a014504d9ed3ccbb4a0366e95870eea56">LDP::socketEstablished</a>(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *yourPtr)
<a name="l00591"></a>00591 {
<a name="l00592"></a>00592     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a>&amp; peer = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[(long)yourPtr];
<a name="l00593"></a>00593     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;TCP connection established with peer &quot;</span> &lt;&lt; peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <span class="comment">// we must update all entries with nextHop == peerIP</span>
<a name="l00596"></a>00596     <a class="code" href="class_l_d_p.html#a33bd46c81cf3f06f6f082c9d67ff58c5">updateFecList</a>(peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a>);
<a name="l00597"></a>00597 
<a name="l00598"></a>00598     <span class="comment">// FIXME start LDP session setup (if we&apos;re on the active side?)</span>
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 
<a name="l00601"></a><a class="code" href="class_l_d_p.html#a7a960a6e6fdddbf58e4978ed432e63de">00601</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a7a960a6e6fdddbf58e4978ed432e63de">LDP::socketDataArrived</a>(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *yourPtr, cPacket *msg, <span class="keywordtype">bool</span>)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a>&amp; peer = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[(long)yourPtr];
<a name="l00604"></a>00604     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Message arrived over TCP from peer &quot;</span> &lt;&lt; peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00605"></a>00605 
<a name="l00606"></a>00606     <span class="keyword">delete</span> msg-&gt;removeControlInfo();
<a name="l00607"></a>00607     <a class="code" href="class_l_d_p.html#ac330a2d78f69dddd1eb1f9479cb16709">processLDPPacketFromTCP</a>(check_and_cast&lt;LDPPacket *&gt;(msg));
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a><a class="code" href="class_l_d_p.html#a8b0190937343b4847d6cbc830f15b2ca">00610</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a8b0190937343b4847d6cbc830f15b2ca">LDP::socketPeerClosed</a>(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *yourPtr)
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a>&amp; peer = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[(long)yourPtr];
<a name="l00613"></a>00613     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Peer &quot;</span> &lt;&lt; peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot; closed TCP connection\n&quot;</span>;
<a name="l00614"></a>00614 
<a name="l00615"></a>00615     ASSERT(<span class="keyword">false</span>);
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="comment">/*</span>
<a name="l00618"></a>00618 <span class="comment">    // close the connection (if not already closed)</span>
<a name="l00619"></a>00619 <span class="comment">    if (socket.getState()==TCPSocket::PEER_CLOSED)</span>
<a name="l00620"></a>00620 <span class="comment">    {</span>
<a name="l00621"></a>00621 <span class="comment">        EV &lt;&lt; &quot;remote TCP closed, closing here as well\n&quot;;</span>
<a name="l00622"></a>00622 <span class="comment">        close();</span>
<a name="l00623"></a>00623 <span class="comment">    }</span>
<a name="l00624"></a>00624 <span class="comment">*/</span>
<a name="l00625"></a>00625 }
<a name="l00626"></a>00626 
<a name="l00627"></a><a class="code" href="class_l_d_p.html#a11b3f4de91cc4a962ec28a94c4c7c6cb">00627</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a11b3f4de91cc4a962ec28a94c4c7c6cb">LDP::socketClosed</a>(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *yourPtr)
<a name="l00628"></a>00628 {
<a name="l00629"></a>00629     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a>&amp; peer = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[(long)yourPtr];
<a name="l00630"></a>00630     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;TCP connection to peer &quot;</span> &lt;&lt; peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot; closed\n&quot;</span>;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     ASSERT(<span class="keyword">false</span>);
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="comment">// FIXME what now? reconnect after a delay?</span>
<a name="l00635"></a>00635 }
<a name="l00636"></a>00636 
<a name="l00637"></a><a class="code" href="class_l_d_p.html#a9e552b940ba57ad9e27d5cbeb31befa2">00637</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a9e552b940ba57ad9e27d5cbeb31befa2">LDP::socketFailure</a>(<span class="keywordtype">int</span>, <span class="keywordtype">void</span> *yourPtr, <span class="keywordtype">int</span> code)
<a name="l00638"></a>00638 {
<a name="l00639"></a>00639     <a class="code" href="struct_l_d_p_1_1peer__info.html">peer_info</a>&amp; peer = <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[(long)yourPtr];
<a name="l00640"></a>00640     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;TCP connection to peer &quot;</span> &lt;&lt; peer.<a class="code" href="struct_l_d_p_1_1peer__info.html#adf670ca2b190150e7b557fd830c74054">peerIP</a> &lt;&lt; <span class="stringliteral">&quot; broken\n&quot;</span>;
<a name="l00641"></a>00641 
<a name="l00642"></a>00642     ASSERT(<span class="keyword">false</span>);
<a name="l00643"></a>00643 
<a name="l00644"></a>00644     <span class="comment">// FIXME what now? reconnect after a delay?</span>
<a name="l00645"></a>00645 }
<a name="l00646"></a>00646 
<a name="l00647"></a><a class="code" href="class_l_d_p.html#ac330a2d78f69dddd1eb1f9479cb16709">00647</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#ac330a2d78f69dddd1eb1f9479cb16709">LDP::processLDPPacketFromTCP</a>(<a class="code" href="class_l_d_p_packet.html">LDPPacket</a> *ldpPacket)
<a name="l00648"></a>00648 {
<a name="l00649"></a>00649     <span class="keywordflow">switch</span> (ldpPacket-&gt;<a class="code" href="class_l_d_p_packet.html#ace0e4e87ace7cdcbfc4468e464db4f69">getType</a>())
<a name="l00650"></a>00650     {
<a name="l00651"></a>00651     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a572e2128aeb8cc392386eb1610a1fada">HELLO</a>:
<a name="l00652"></a>00652         error(<span class="stringliteral">&quot;Received LDP HELLO over TCP (should arrive over UDP)&quot;</span>);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a4fabbaac7b5e57d7b8b019a0f79ce492">ADDRESS</a>:
<a name="l00655"></a>00655         <span class="comment">// processADDRESS(ldpPacket);</span>
<a name="l00656"></a>00656         error(<span class="stringliteral">&quot;Received LDP ADDRESS message, unsupported in this version&quot;</span>);
<a name="l00657"></a>00657         <span class="keywordflow">break</span>;
<a name="l00658"></a>00658 
<a name="l00659"></a>00659     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a0dee6cb4ef910becd493a70e655b8768">ADDRESS_WITHDRAW</a>:
<a name="l00660"></a>00660         <span class="comment">// processADDRESS_WITHDRAW(ldpPacket);</span>
<a name="l00661"></a>00661         error(<span class="stringliteral">&quot;LDP PROC DEBUG: Received LDP ADDRESS_WITHDRAW message, unsupported in this version&quot;</span>);
<a name="l00662"></a>00662         <span class="keywordflow">break</span>;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a21684054f4791ac4ad3ecd4cffd4c8f4">LABEL_MAPPING</a>:
<a name="l00665"></a>00665         <a class="code" href="class_l_d_p.html#ad4960396a93e0b4b3b71f9cd16c2a9b7">processLABEL_MAPPING</a>(check_and_cast&lt;LDPLabelMapping *&gt;(ldpPacket));
<a name="l00666"></a>00666         <span class="keywordflow">break</span>;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a13f9e4988522509bb13178c320a7f5c3">LABEL_REQUEST</a>:
<a name="l00669"></a>00669         <a class="code" href="class_l_d_p.html#a8bbf321fe7b9eb4c2ebbc06a2a12c8d4">processLABEL_REQUEST</a>(check_and_cast&lt;LDPLabelRequest *&gt;(ldpPacket));
<a name="l00670"></a>00670         <span class="keywordflow">break</span>;
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a7fd292325bd8d0d4a4d466f1e969c494">LABEL_WITHDRAW</a>:
<a name="l00673"></a>00673         <a class="code" href="class_l_d_p.html#a615dc36ac669f35619acc9d4a7f35d2b">processLABEL_WITHDRAW</a>(check_and_cast&lt;LDPLabelMapping *&gt;(ldpPacket));
<a name="l00674"></a>00674         <span class="keywordflow">break</span>;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3ad4cdfab707c90f09c9bd6481e3c2406d">LABEL_RELEASE</a>:
<a name="l00677"></a>00677         <a class="code" href="class_l_d_p.html#a266cf0a6e2fe508f383e88a640697afd">processLABEL_RELEASE</a>(check_and_cast&lt;LDPLabelMapping *&gt;(ldpPacket));
<a name="l00678"></a>00678         <span class="keywordflow">break</span>;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680     <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3ac471f802051d229d2e12947bbf886f96">NOTIFICATION</a>:
<a name="l00681"></a>00681         <a class="code" href="class_l_d_p.html#aba440f5b0dc9e2ee2a8360388a8503bc">processNOTIFICATION</a>(check_and_cast&lt;LDPNotify*&gt;(ldpPacket));
<a name="l00682"></a>00682         <span class="keywordflow">break</span>;
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">default</span>:
<a name="l00685"></a>00685         error(<span class="stringliteral">&quot;LDP PROC DEBUG: Unrecognized LDP Message Type, type is %d&quot;</span>, ldpPacket-&gt;<a class="code" href="class_l_d_p_packet.html#ace0e4e87ace7cdcbfc4468e464db4f69">getType</a>());
<a name="l00686"></a>00686     }
<a name="l00687"></a>00687 }
<a name="l00688"></a>00688 
<a name="l00689"></a><a class="code" href="class_l_d_p.html#adc10a0f7fdde1daef9a2b236fdd5de00">00689</a> <a class="code" href="class_i_p_address.html">IPAddress</a> <a class="code" href="class_l_d_p.html#adc10a0f7fdde1daef9a2b236fdd5de00">LDP::locateNextHop</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> dest)
<a name="l00690"></a>00690 {
<a name="l00691"></a>00691     <span class="comment">// Mapping L3 IP-host of next hop to L2 peer address.</span>
<a name="l00692"></a>00692 
<a name="l00693"></a>00693     <span class="comment">// Lookup the routing table, rfc3036</span>
<a name="l00694"></a>00694     <span class="comment">// &quot;When the FEC for which a label is requested is a Prefix FEC Element or</span>
<a name="l00695"></a>00695     <span class="comment">//  a Host Address FEC Element, the receiving LSR uses its routing table to determine</span>
<a name="l00696"></a>00696     <span class="comment">//  its response. Unless its routing table includes an entry that exactly matches</span>
<a name="l00697"></a>00697     <span class="comment">//  the requested Prefix or Host Address, the LSR must respond with a</span>
<a name="l00698"></a>00698     <span class="comment">//  No Route Notification message.&quot;</span>
<a name="l00699"></a>00699     <span class="comment">//</span>
<a name="l00700"></a>00700     <span class="comment">// FIXME the code below (though seems like that&apos;s what the RFC refers to) doesn&apos;t work</span>
<a name="l00701"></a>00701     <span class="comment">// -- we can&apos;t reasonably expect the destination host to be exaplicitly in an</span>
<a name="l00702"></a>00702     <span class="comment">// LSR&apos;s routing table!!! Use simple IP routing instead. --Andras</span>
<a name="l00703"></a>00703     <span class="comment">//</span>
<a name="l00704"></a>00704     <span class="comment">// Wrong code:</span>
<a name="l00705"></a>00705     <span class="comment">//int i;</span>
<a name="l00706"></a>00706     <span class="comment">//for (i=0; i &lt; rt-&gt;getNumRoutes(); i++)</span>
<a name="l00707"></a>00707     <span class="comment">//    if (rt-&gt;getRoute(i)-&gt;host == dest)</span>
<a name="l00708"></a>00708     <span class="comment">//        break;</span>
<a name="l00709"></a>00709     <span class="comment">//</span>
<a name="l00710"></a>00710     <span class="comment">//if (i == rt-&gt;getNumRoutes())</span>
<a name="l00711"></a>00711     <span class="comment">//    return IPAddress();  // Signal an NOTIFICATION of NO ROUTE</span>
<a name="l00712"></a>00712     <span class="comment">//</span>
<a name="l00713"></a>00713     <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *ie = <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a0dda4a87779a949284ccead75001fa30">getInterfaceForDestAddr</a>(dest);
<a name="l00714"></a>00714     <span class="keywordflow">if</span> (!ie)
<a name="l00715"></a>00715         <span class="keywordflow">return</span> <a class="code" href="class_i_p_address.html">IPAddress</a>();  <span class="comment">// no route</span>
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     std::string iName = ie-&gt;getName(); <span class="comment">// FIXME why use name for lookup?</span>
<a name="l00718"></a>00718     <span class="keywordflow">return</span> <a class="code" href="class_l_d_p.html#a057c06f71b085683639b467bd47b4abd">findPeerAddrFromInterface</a>(iName);
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a>00721 <span class="comment">// FIXME To allow this to work, make sure there are entries of hosts for all peers</span>
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="class_l_d_p.html#a057c06f71b085683639b467bd47b4abd">00723</a> <a class="code" href="class_i_p_address.html">IPAddress</a> <a class="code" href="class_l_d_p.html#a057c06f71b085683639b467bd47b4abd">LDP::findPeerAddrFromInterface</a>(std::string interfaceName)
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725     <span class="keywordtype">int</span> i = 0;
<a name="l00726"></a>00726     <span class="keywordtype">int</span> k = 0;
<a name="l00727"></a>00727     <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *ie = <a class="code" href="class_l_d_p.html#ae0de7c03b5ac9168386ed3cd6f920c3e">ift</a>-&gt;<a class="code" href="class_i_interface_table.html#a8ad86ee823d6200b4f558383b39af658">getInterfaceByName</a>(interfaceName.c_str());
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="keyword">const</span> <a class="code" href="class_i_p_route.html">IPRoute</a> *anEntry;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#ada2fac98d1d1c80c291be239b075c63b">getNumRoutes</a>(); i++)
<a name="l00732"></a>00732     {
<a name="l00733"></a>00733         <span class="keywordflow">for</span> (k = 0; k &lt; (int)<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size(); k++)
<a name="l00734"></a>00734         {
<a name="l00735"></a>00735             anEntry = <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a89f3eb433e309043cde517238eef5214">getRoute</a>(i);
<a name="l00736"></a>00736             <span class="keywordflow">if</span> (anEntry-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>()==<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[k].peerIP &amp;&amp; anEntry-&gt;<a class="code" href="class_i_p_route.html#a1b01dfecb70fc9384695ce312dcab0a4">getInterface</a>()==ie)
<a name="l00737"></a>00737             {
<a name="l00738"></a>00738                 <span class="keywordflow">return</span> <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[k].peerIP;
<a name="l00739"></a>00739             }
<a name="l00740"></a>00740             <span class="comment">// addresses-&gt;push_back(peerIP[k]);</span>
<a name="l00741"></a>00741         }
<a name="l00742"></a>00742     }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744     <span class="comment">// Return any IP which has default route - not in routing table entries</span>
<a name="l00745"></a>00745     <span class="keywordflow">for</span> (i = 0; i &lt; (int)<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size(); i++)
<a name="l00746"></a>00746     {
<a name="l00747"></a>00747         <span class="keywordflow">for</span> (k = 0; k &lt; <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#ada2fac98d1d1c80c291be239b075c63b">getNumRoutes</a>(); k++)
<a name="l00748"></a>00748         {
<a name="l00749"></a>00749             anEntry = <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a89f3eb433e309043cde517238eef5214">getRoute</a>(i);
<a name="l00750"></a>00750             <span class="keywordflow">if</span> (anEntry-&gt;<a class="code" href="class_i_p_route.html#a07adcdcc04cb4d50f12f060c7206b73e">getHost</a>() == <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].peerIP)
<a name="l00751"></a>00751                 <span class="keywordflow">break</span>;
<a name="l00752"></a>00752         }
<a name="l00753"></a>00753         <span class="keywordflow">if</span> (k == <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#ada2fac98d1d1c80c291be239b075c63b">getNumRoutes</a>())
<a name="l00754"></a>00754             <span class="keywordflow">break</span>;
<a name="l00755"></a>00755     }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     <span class="comment">// return the peer&apos;s address if found, unspecified address otherwise</span>
<a name="l00758"></a>00758     <span class="keywordflow">return</span> i==(int)<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.size() ? <a class="code" href="class_i_p_address.html">IPAddress</a>() : <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].peerIP;
<a name="l00759"></a>00759 }
<a name="l00760"></a>00760 
<a name="l00761"></a>00761 <span class="comment">// Pre-condition: myPeers vector is finalized</span>
<a name="l00762"></a><a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">00762</a> std::string <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">LDP::findInterfaceFromPeerAddr</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> peerIP)
<a name="l00763"></a>00763 {
<a name="l00764"></a>00764 <span class="comment">/*</span>
<a name="l00765"></a>00765 <span class="comment">    int i;</span>
<a name="l00766"></a>00766 <span class="comment">    for (unsigned int i=0;i&lt;myPeers.size();i++)</span>
<a name="l00767"></a>00767 <span class="comment">    {</span>
<a name="l00768"></a>00768 <span class="comment">        if (myPeers[i].peerIP == peerIP)</span>
<a name="l00769"></a>00769 <span class="comment">            return string(myPeers[i].linkInterface);</span>
<a name="l00770"></a>00770 <span class="comment">    }</span>
<a name="l00771"></a>00771 <span class="comment">    return string(&quot;X&quot;);</span>
<a name="l00772"></a>00772 <span class="comment">*/</span>
<a name="l00773"></a>00773 <span class="comment">//    Rely on port index to find the interface name</span>
<a name="l00774"></a>00774 
<a name="l00775"></a>00775     <span class="comment">// this function is a misnomer, we must recognize our own address too</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a3dad8d703bfa05731c44b3b2f0bb4ae5">isLocalAddress</a>(peerIP))
<a name="l00777"></a>00777         <span class="keywordflow">return</span> <span class="stringliteral">&quot;lo0&quot;</span>;
<a name="l00778"></a>00778 
<a name="l00779"></a>00779     <a class="code" href="class_interface_entry.html">InterfaceEntry</a> *ie = <a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a0dda4a87779a949284ccead75001fa30">getInterfaceForDestAddr</a>(peerIP);
<a name="l00780"></a>00780     <span class="keywordflow">if</span> (!ie)
<a name="l00781"></a>00781         error(<span class="stringliteral">&quot;findInterfaceFromPeerAddr(): %s is not routable&quot;</span>, peerIP.<a class="code" href="class_i_p_address.html#a50f58febbf2ded78b9f6e32e579f5d2b">str</a>().c_str());
<a name="l00782"></a>00782     <span class="keywordflow">return</span> ie-&gt;getName();
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a>00785 <span class="comment">//bool LDP::matches(const FEC_TLV&amp; a, const FEC_TLV&amp; b)</span>
<a name="l00786"></a>00786 <span class="comment">//{</span>
<a name="l00787"></a>00787 <span class="comment">//  return b.addr.prefixMatches(a, b.length);</span>
<a name="l00788"></a>00788 <span class="comment">//}</span>
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="class_l_d_p.html#a3f922572f5c41fd96b2cbf7944526baa">00790</a> LDP::FecBindVector::iterator <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">LDP::findFecEntry</a>(FecBindVector&amp; fecs, <span class="keywordtype">int</span> fecid, <a class="code" href="class_i_p_address.html">IPAddress</a> peer)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792     FecBindVector::iterator it;
<a name="l00793"></a>00793     <span class="keywordflow">for</span> (it = fecs.begin(); it != fecs.end(); it++)
<a name="l00794"></a>00794     {
<a name="l00795"></a>00795         <span class="keywordflow">if</span> (it-&gt;fecid != fecid)
<a name="l00796"></a>00796             <span class="keywordflow">continue</span>;
<a name="l00797"></a>00797 
<a name="l00798"></a>00798         <span class="keywordflow">if</span> (it-&gt;peer != peer)
<a name="l00799"></a>00799             <span class="keywordflow">continue</span>;
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <span class="keywordflow">break</span>;
<a name="l00802"></a>00802     }
<a name="l00803"></a>00803     <span class="keywordflow">return</span> it;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">00806</a> LDP::FecVector::iterator <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">LDP::findFecEntry</a>(FecVector&amp; fecs, <a class="code" href="class_i_p_address.html">IPAddress</a> addr, <span class="keywordtype">int</span> length)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808     FecVector::iterator it;
<a name="l00809"></a>00809     <span class="keywordflow">for</span> (it = fecs.begin(); it != fecs.end(); it++)
<a name="l00810"></a>00810     {
<a name="l00811"></a>00811         <span class="keywordflow">if</span> (it-&gt;length != length)
<a name="l00812"></a>00812             <span class="keywordflow">continue</span>;
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <span class="keywordflow">if</span> (it-&gt;addr != addr) <span class="comment">// XXX compare only relevant part (?)</span>
<a name="l00815"></a>00815             <span class="keywordflow">continue</span>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817         <span class="keywordflow">break</span>;
<a name="l00818"></a>00818     }
<a name="l00819"></a>00819     <span class="keywordflow">return</span> it;
<a name="l00820"></a>00820 }
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="class_l_d_p.html#a266295145a120bfc4392554603e3a15a">00822</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a266295145a120bfc4392554603e3a15a">LDP::sendNotify</a>(<span class="keywordtype">int</span> status, <a class="code" href="class_i_p_address.html">IPAddress</a> dest, <a class="code" href="class_i_p_address.html">IPAddress</a> addr, <span class="keywordtype">int</span> length)
<a name="l00823"></a>00823 {
<a name="l00824"></a>00824     <span class="comment">// Send NOTIFY message</span>
<a name="l00825"></a>00825     <a class="code" href="class_l_d_p_notify.html">LDPNotify</a> *lnMessage = <span class="keyword">new</span> <a class="code" href="class_l_d_p_notify.html">LDPNotify</a>(<span class="stringliteral">&quot;Lb-Notify&quot;</span>);
<a name="l00826"></a>00826     lnMessage-&gt;setByteLength(<a class="code" href="_l_d_p_packet__m_8h.html#ae5cdb34a890024cf1fb6cc148a76adfa">LDP_HEADER_BYTES</a>); <span class="comment">// FIXME find out actual length</span>
<a name="l00827"></a>00827     lnMessage-&gt;<a class="code" href="class_l_d_p_packet.html#a484a59e3cb14cb70dac6cbdf22f1fb9d">setType</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3ac471f802051d229d2e12947bbf886f96">NOTIFICATION</a>);
<a name="l00828"></a>00828     lnMessage-&gt;<a class="code" href="class_l_d_p_notify.html#a2299d011d7a82f9782b3815cc12f54f4">setStatus</a>(<a class="code" href="_l_d_p_packet__m_8h.html#ad97f39f1c02ee4465a8cd420fc590d0aa7f3989f2a6e77f5c6df85ff6210c6b5f">NO_ROUTE</a>);
<a name="l00829"></a>00829     lnMessage-&gt;<a class="code" href="class_l_d_p_packet.html#a4d67b67f693a22a8bdfa4ffdd6f0f07d">setReceiverAddress</a>(dest);
<a name="l00830"></a>00830     lnMessage-&gt;<a class="code" href="class_l_d_p_packet.html#ada5cc01f46a8d1285399bc4b84fb1006">setSenderAddress</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>());
<a name="l00831"></a>00831 
<a name="l00832"></a>00832     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec;
<a name="l00833"></a>00833     fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a> = addr;
<a name="l00834"></a>00834     fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a> = length;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836     lnMessage-&gt;<a class="code" href="class_l_d_p_notify.html#a9d5316c4f517facddf7888475ebaeae5">setFec</a>(fec);
<a name="l00837"></a>00837 
<a name="l00838"></a>00838     <a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">sendToPeer</a>(dest, lnMessage);
<a name="l00839"></a>00839 }
<a name="l00840"></a>00840 
<a name="l00841"></a><a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">00841</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">LDP::sendMapping</a>(<span class="keywordtype">int</span> type, <a class="code" href="class_i_p_address.html">IPAddress</a> dest, <span class="keywordtype">int</span> label, <a class="code" href="class_i_p_address.html">IPAddress</a> addr, <span class="keywordtype">int</span> length)
<a name="l00842"></a>00842 {
<a name="l00843"></a>00843     <span class="comment">// Send LABEL MAPPING downstream</span>
<a name="l00844"></a>00844     <a class="code" href="class_l_d_p_label_mapping.html">LDPLabelMapping</a> *lmMessage = <span class="keyword">new</span> <a class="code" href="class_l_d_p_label_mapping.html">LDPLabelMapping</a>(<span class="stringliteral">&quot;Lb-Mapping&quot;</span>);
<a name="l00845"></a>00845     lmMessage-&gt;setByteLength(<a class="code" href="_l_d_p_packet__m_8h.html#ae5cdb34a890024cf1fb6cc148a76adfa">LDP_HEADER_BYTES</a>); <span class="comment">// FIXME find out actual length</span>
<a name="l00846"></a>00846     lmMessage-&gt;<a class="code" href="class_l_d_p_packet.html#a484a59e3cb14cb70dac6cbdf22f1fb9d">setType</a>(type);
<a name="l00847"></a>00847     lmMessage-&gt;<a class="code" href="class_l_d_p_packet.html#a4d67b67f693a22a8bdfa4ffdd6f0f07d">setReceiverAddress</a>(dest);
<a name="l00848"></a>00848     lmMessage-&gt;<a class="code" href="class_l_d_p_packet.html#ada5cc01f46a8d1285399bc4b84fb1006">setSenderAddress</a>(<a class="code" href="class_l_d_p.html#a7eb3dc232661ebe9a2dcaf681f219aae">rt</a>-&gt;<a class="code" href="class_i_routing_table.html#a64a9a5b1414f4da0b7b0a3e079091f62">getRouterId</a>());
<a name="l00849"></a>00849     lmMessage-&gt;<a class="code" href="class_l_d_p_label_mapping.html#a0a642386c4f2a9c0b95057f1771a6bc9">setLabel</a>(label);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec;
<a name="l00852"></a>00852     fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a> = addr;
<a name="l00853"></a>00853     fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a> = length;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855     lmMessage-&gt;<a class="code" href="class_l_d_p_label_mapping.html#ad6c52260c835742b29e1db97c75601a1">setFec</a>(fec);
<a name="l00856"></a>00856 
<a name="l00857"></a>00857     <a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">sendToPeer</a>(dest, lmMessage);
<a name="l00858"></a>00858 }
<a name="l00859"></a>00859 
<a name="l00860"></a><a class="code" href="class_l_d_p.html#aba440f5b0dc9e2ee2a8360388a8503bc">00860</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#aba440f5b0dc9e2ee2a8360388a8503bc">LDP::processNOTIFICATION</a>(<a class="code" href="class_l_d_p_notify.html">LDPNotify</a> *packet)
<a name="l00861"></a>00861 {
<a name="l00862"></a>00862     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec = packet-&gt;<a class="code" href="class_l_d_p_notify.html#ada26aa7a219c92a899d538164510c331">getFec</a>();
<a name="l00863"></a>00863     <a class="code" href="class_i_p_address.html">IPAddress</a> srcAddr = packet-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l00864"></a>00864     <span class="keywordtype">int</span> status = packet-&gt;<a class="code" href="class_l_d_p_notify.html#af64186cdd2b7e4182809cfbb4b97641d">getStatus</a>();
<a name="l00865"></a>00865 
<a name="l00866"></a>00866     <span class="comment">// XXX FIXME NO_ROUTE processing should probably be split into two functions,</span>
<a name="l00867"></a>00867     <span class="comment">// this is not the cleanest thing I ever wrote :)   --Vojta</span>
<a name="l00868"></a>00868 
<a name="l00869"></a>00869     <span class="keywordflow">if</span> (packet-&gt;isSelfMessage())
<a name="l00870"></a>00870     {
<a name="l00871"></a>00871         <span class="comment">// re-scheduled by ourselves</span>
<a name="l00872"></a>00872         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;notification retry for peer=&quot;</span> &lt;&lt; srcAddr &lt;&lt; <span class="stringliteral">&quot; fec=&quot;</span> &lt;&lt; fec &lt;&lt; <span class="stringliteral">&quot; status=&quot;</span> &lt;&lt; status &lt;&lt; endl;
<a name="l00873"></a>00873     }
<a name="l00874"></a>00874     <span class="keywordflow">else</span>
<a name="l00875"></a>00875     {
<a name="l00876"></a>00876         <span class="comment">// received via network</span>
<a name="l00877"></a>00877         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;notification received from=&quot;</span> &lt;&lt; srcAddr &lt;&lt; <span class="stringliteral">&quot; fec=&quot;</span> &lt;&lt; fec &lt;&lt; <span class="stringliteral">&quot; status=&quot;</span> &lt;&lt; status &lt;&lt; endl;
<a name="l00878"></a>00878     }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880     <span class="keywordflow">switch</span>(status)
<a name="l00881"></a>00881     {
<a name="l00882"></a>00882         <span class="keywordflow">case</span> <a class="code" href="_l_d_p_packet__m_8h.html#ad97f39f1c02ee4465a8cd420fc590d0aa7f3989f2a6e77f5c6df85ff6210c6b5f">NO_ROUTE</a>:
<a name="l00883"></a>00883         {
<a name="l00884"></a>00884             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;route does not exit on that peer&quot;</span> &lt;&lt; endl;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886             FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l00887"></a>00887             <span class="keywordflow">if</span> (it != <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end())
<a name="l00888"></a>00888             {
<a name="l00889"></a>00889                 <span class="keywordflow">if</span> (it-&gt;nextHop == srcAddr)
<a name="l00890"></a>00890                 {
<a name="l00891"></a>00891                     <span class="keywordflow">if</span> (!packet-&gt;isSelfMessage())
<a name="l00892"></a>00892                     {
<a name="l00893"></a>00893                         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;we are still interesed in this mapping, we will retry later&quot;</span> &lt;&lt; endl;
<a name="l00894"></a>00894 
<a name="l00895"></a>00895                         scheduleAt(simTime() + 1.0 <span class="comment">/* XXX FIXME */</span>, packet);
<a name="l00896"></a>00896                         <span class="keywordflow">return</span>;
<a name="l00897"></a>00897                     }
<a name="l00898"></a>00898                     <span class="keywordflow">else</span>
<a name="l00899"></a>00899                     {
<a name="l00900"></a>00900                         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;reissuing request&quot;</span> &lt;&lt; endl;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902                         <a class="code" href="class_l_d_p.html#a27a71323af2adb9a34afc88393757312">sendMappingRequest</a>(srcAddr, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l00903"></a>00903                     }
<a name="l00904"></a>00904                 }
<a name="l00905"></a>00905                 <span class="keywordflow">else</span>
<a name="l00906"></a>00906                     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;and we still recognize this FEC, but we use different next hop, forget it&quot;</span> &lt;&lt; endl;
<a name="l00907"></a>00907             }
<a name="l00908"></a>00908             <span class="keywordflow">else</span>
<a name="l00909"></a>00909                 <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;and we do not recognize this any longer, forget it&quot;</span> &lt;&lt; endl;
<a name="l00910"></a>00910 
<a name="l00911"></a>00911             <span class="keywordflow">break</span>;
<a name="l00912"></a>00912         }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914         <span class="keywordflow">default</span>:
<a name="l00915"></a>00915             ASSERT(<span class="keyword">false</span>);
<a name="l00916"></a>00916     }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918     <span class="keyword">delete</span> packet;
<a name="l00919"></a>00919 }
<a name="l00920"></a>00920 
<a name="l00921"></a><a class="code" href="class_l_d_p.html#a8bbf321fe7b9eb4c2ebbc06a2a12c8d4">00921</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a8bbf321fe7b9eb4c2ebbc06a2a12c8d4">LDP::processLABEL_REQUEST</a>(<a class="code" href="class_l_d_p_label_request.html">LDPLabelRequest</a> *packet)
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec = packet-&gt;<a class="code" href="class_l_d_p_label_request.html#aa7f29cdcd7e83e8c5e684495a9fcf4c3">getFec</a>();
<a name="l00924"></a>00924     <a class="code" href="class_i_p_address.html">IPAddress</a> srcAddr = packet-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l00925"></a>00925 
<a name="l00926"></a>00926     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Label Request from LSR &quot;</span> &lt;&lt; srcAddr &lt;&lt; <span class="stringliteral">&quot; for FEC &quot;</span> &lt;&lt; fec &lt;&lt; endl;
<a name="l00927"></a>00927 
<a name="l00928"></a>00928     FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l00929"></a>00929     <span class="keywordflow">if</span> (it == <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end())
<a name="l00930"></a>00930     {
<a name="l00931"></a>00931         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;FEC not recognized, sending back No route message&quot;</span> &lt;&lt; endl;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933         <a class="code" href="class_l_d_p.html#a266295145a120bfc4392554603e3a15a">sendNotify</a>(<a class="code" href="_l_d_p_packet__m_8h.html#ad97f39f1c02ee4465a8cd420fc590d0aa7f3989f2a6e77f5c6df85ff6210c6b5f">NO_ROUTE</a>, srcAddr, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l00934"></a>00934 
<a name="l00935"></a>00935         <span class="keyword">delete</span> packet;
<a name="l00936"></a>00936         <span class="keywordflow">return</span>;
<a name="l00937"></a>00937     }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939     <span class="comment">// do we already have mapping for this fec from our downstream peer?</span>
<a name="l00940"></a>00940 
<a name="l00941"></a>00941     <span class="comment">//</span>
<a name="l00942"></a>00942     <span class="comment">// XXX this code duplicates rebuildFecList</span>
<a name="l00943"></a>00943     <span class="comment">//</span>
<a name="l00944"></a>00944 
<a name="l00945"></a>00945     <span class="comment">// does upstream have mapping from us?</span>
<a name="l00946"></a>00946     FecBindVector::iterator uit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>, it-&gt;fecid, srcAddr);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948     <span class="comment">// shouldn&apos;t!</span>
<a name="l00949"></a>00949     ASSERT(uit == <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end());
<a name="l00950"></a>00950 
<a name="l00951"></a>00951     <span class="comment">// do we have mapping from downstream?</span>
<a name="l00952"></a>00952     FecBindVector::iterator dit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>, it-&gt;fecid, it-&gt;nextHop);
<a name="l00953"></a>00953 
<a name="l00954"></a>00954     <span class="comment">// is next hop our LDP peer?</span>
<a name="l00955"></a>00955     <span class="keywordtype">bool</span> ER = !<a class="code" href="class_l_d_p.html#a43170c3c37870c56f321b8a2e24ec420">findPeerSocket</a>(it-&gt;nextHop);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957     ASSERT(!(ER &amp;&amp; dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())); <span class="comment">// can&apos;t be egress and have mapping at the same time</span>
<a name="l00958"></a>00958 
<a name="l00959"></a>00959     <span class="keywordflow">if</span> (ER || dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())
<a name="l00960"></a>00960     {
<a name="l00961"></a>00961         <a class="code" href="struct_l_d_p_1_1fec__bind__t.html">fec_bind_t</a> newItem;
<a name="l00962"></a>00962         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a641b231f6ae1b8ad59c76872031fe86c">fecid</a> = it-&gt;fecid;
<a name="l00963"></a>00963         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a539f7f3b600b0ab7184622a5f1361f77">label</a> = -1;
<a name="l00964"></a>00964         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a50a515dc50f5f76e99efccaa2145a14b">peer</a> = srcAddr;
<a name="l00965"></a>00965         <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.push_back(newItem);
<a name="l00966"></a>00966         uit = <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end() - 1;
<a name="l00967"></a>00967     }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969     std::string inInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(srcAddr);
<a name="l00970"></a>00970     std::string outInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(it-&gt;nextHop);
<a name="l00971"></a>00971 
<a name="l00972"></a>00972     <span class="keywordflow">if</span> (ER)
<a name="l00973"></a>00973     {
<a name="l00974"></a>00974         <span class="comment">// we are egress, that&apos;s easy:</span>
<a name="l00975"></a>00975         <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a> outLabel = <a class="code" href="class_l_i_b_table.html#ad7eebe93833f85b136e60bc6ac30941e">LIBTable::popLabel</a>();
<a name="l00976"></a>00976 
<a name="l00977"></a>00977         uit-&gt;label = <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a6599a694b9035a18dbc01bd0c52b54f7">installLibEntry</a>(uit-&gt;label, inInterface, outLabel, outInterface, 0);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;installed (egress) LIB entry inLabel=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; inInterface=&quot;</span> &lt;&lt; inInterface &lt;&lt;
<a name="l00980"></a>00980                 <span class="stringliteral">&quot; outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot; outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982         <span class="comment">// We are egress, let our upstream peer know</span>
<a name="l00983"></a>00983         <span class="comment">// about it by sending back a Label Mapping message</span>
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a21684054f4791ac4ad3ecd4cffd4c8f4">LABEL_MAPPING</a>, srcAddr, uit-&gt;label, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l00986"></a>00986 
<a name="l00987"></a>00987     }
<a name="l00988"></a>00988     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())
<a name="l00989"></a>00989     {
<a name="l00990"></a>00990         <span class="comment">// we have mapping from DS, that&apos;s easy</span>
<a name="l00991"></a>00991         <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a> outLabel = <a class="code" href="class_l_i_b_table.html#adc5fdcd5d807e663b467ff91e719873f">LIBTable::swapLabel</a>(dit-&gt;label);
<a name="l00992"></a>00992         uit-&gt;label = <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a6599a694b9035a18dbc01bd0c52b54f7">installLibEntry</a>(uit-&gt;label, inInterface, outLabel, outInterface, <a class="code" href="_l_d_p_8h.html#a819e3794dd985814c77459acdb71042f">LDP_USER_TRAFFIC</a>);
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;installed LIB entry inLabel=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; <span class="stringliteral">&quot; inInterface=&quot;</span> &lt;&lt; inInterface &lt;&lt;
<a name="l00995"></a>00995                 <span class="stringliteral">&quot; outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot; outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         <span class="comment">// We already have a mapping for this FEC, let our upstream peer know</span>
<a name="l00998"></a>00998         <span class="comment">// about it by sending back a Label Mapping message</span>
<a name="l00999"></a>00999 
<a name="l01000"></a>01000         <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a21684054f4791ac4ad3ecd4cffd4c8f4">LABEL_MAPPING</a>, srcAddr, uit-&gt;label, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l01001"></a>01001     }
<a name="l01002"></a>01002     <span class="keywordflow">else</span>
<a name="l01003"></a>01003     {
<a name="l01004"></a>01004         <span class="comment">// no mapping from DS, mark as pending</span>
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;no mapping for this FEC from the downstream router, marking as pending&quot;</span> &lt;&lt; endl;
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <a class="code" href="struct_l_d_p_1_1pending__req__t.html">pending_req_t</a> newItem;
<a name="l01009"></a>01009         newItem.<a class="code" href="struct_l_d_p_1_1pending__req__t.html#ac9e70bc554d3e6126af229f19a097db6">fecid</a> = it-&gt;fecid;
<a name="l01010"></a>01010         newItem.<a class="code" href="struct_l_d_p_1_1pending__req__t.html#a25aacccb518de6def2bce4ca8c01d930">peer</a> = srcAddr;
<a name="l01011"></a>01011         <a class="code" href="class_l_d_p.html#a057aa332bfc1ddcbc2d66e73de161af9">pending</a>.push_back(newItem);
<a name="l01012"></a>01012     }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014     <span class="keyword">delete</span> packet;
<a name="l01015"></a>01015 }
<a name="l01016"></a>01016 
<a name="l01017"></a><a class="code" href="class_l_d_p.html#a266cf0a6e2fe508f383e88a640697afd">01017</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a266cf0a6e2fe508f383e88a640697afd">LDP::processLABEL_RELEASE</a>(<a class="code" href="class_l_d_p_label_mapping.html">LDPLabelMapping</a> *packet)
<a name="l01018"></a>01018 {
<a name="l01019"></a>01019     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#ab4363c064c8a65a3a5eec995462bff66">getFec</a>();
<a name="l01020"></a>01020     <span class="keywordtype">int</span> label = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#a948b6496f30a911cb48ae3dc744f676f">getLabel</a>();
<a name="l01021"></a>01021     <a class="code" href="class_i_p_address.html">IPAddress</a> fromIP = packet-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l01022"></a>01022 
<a name="l01023"></a>01023     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Mapping release received for label=&quot;</span> &lt;&lt; label &lt;&lt; <span class="stringliteral">&quot; fec=&quot;</span> &lt;&lt; fec &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; fromIP &lt;&lt; endl;
<a name="l01024"></a>01024 
<a name="l01025"></a>01025     ASSERT(label &gt; 0);
<a name="l01026"></a>01026 
<a name="l01027"></a>01027     <span class="comment">// remove label from fecUp</span>
<a name="l01028"></a>01028 
<a name="l01029"></a>01029     FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l01030"></a>01030     <span class="keywordflow">if</span> (it == <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end())
<a name="l01031"></a>01031     {
<a name="l01032"></a>01032         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;FEC no longer recognized here, ignoring&quot;</span> &lt;&lt; endl;
<a name="l01033"></a>01033         <span class="keyword">delete</span> packet;
<a name="l01034"></a>01034         <span class="keywordflow">return</span>;
<a name="l01035"></a>01035     }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     FecBindVector::iterator uit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>, it-&gt;fecid, fromIP);
<a name="l01038"></a>01038     <span class="keywordflow">if</span> (uit == <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.end() || label != uit-&gt;label)
<a name="l01039"></a>01039     {
<a name="l01040"></a>01040         <span class="comment">// this is ok and may happen; e.g. we removed the mapping because downstream</span>
<a name="l01041"></a>01041         <span class="comment">// neighbour withdrew its mapping. we sent withdraw upstream as well and</span>
<a name="l01042"></a>01042         <span class="comment">// this is upstream&apos;s response</span>
<a name="l01043"></a>01043         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;mapping not found among sent mappings, ignoring&quot;</span> &lt;&lt; endl;
<a name="l01044"></a>01044         <span class="keyword">delete</span> packet;
<a name="l01045"></a>01045         <span class="keywordflow">return</span>;
<a name="l01046"></a>01046     }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing from LIB table label=&quot;</span> &lt;&lt; uit-&gt;label &lt;&lt; endl;
<a name="l01049"></a>01049     <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#aeaf750f1e663ddd1a5a6e76406ad8a14">removeLibEntry</a>(uit-&gt;label);
<a name="l01050"></a>01050 
<a name="l01051"></a>01051     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing label from list of sent mappings&quot;</span> &lt;&lt; endl;
<a name="l01052"></a>01052     <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.erase(uit);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054     <span class="keyword">delete</span> packet;
<a name="l01055"></a>01055 }
<a name="l01056"></a>01056 
<a name="l01057"></a><a class="code" href="class_l_d_p.html#a615dc36ac669f35619acc9d4a7f35d2b">01057</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a615dc36ac669f35619acc9d4a7f35d2b">LDP::processLABEL_WITHDRAW</a>(<a class="code" href="class_l_d_p_label_mapping.html">LDPLabelMapping</a> *packet)
<a name="l01058"></a>01058 {
<a name="l01059"></a>01059     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#ab4363c064c8a65a3a5eec995462bff66">getFec</a>();
<a name="l01060"></a>01060     <span class="keywordtype">int</span> label = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#a948b6496f30a911cb48ae3dc744f676f">getLabel</a>();
<a name="l01061"></a>01061     <a class="code" href="class_i_p_address.html">IPAddress</a> fromIP = packet-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l01062"></a>01062 
<a name="l01063"></a>01063     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Mapping withdraw received for label=&quot;</span> &lt;&lt; label &lt;&lt; <span class="stringliteral">&quot; fec=&quot;</span> &lt;&lt; fec &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; fromIP &lt;&lt; endl;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065     ASSERT(label &gt; 0);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067     <span class="comment">// remove label from fecDown</span>
<a name="l01068"></a>01068 
<a name="l01069"></a>01069     FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l01070"></a>01070     <span class="keywordflow">if</span> (it == <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end())
<a name="l01071"></a>01071     {
<a name="l01072"></a>01072         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;matching FEC not found, ignoring withdraw message&quot;</span> &lt;&lt; endl;
<a name="l01073"></a>01073         <span class="keyword">delete</span> packet;
<a name="l01074"></a>01074         <span class="keywordflow">return</span>;
<a name="l01075"></a>01075     }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077     FecBindVector::iterator dit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>, it-&gt;fecid, fromIP);
<a name="l01078"></a>01078 
<a name="l01079"></a>01079     <span class="keywordflow">if</span> (dit == <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end() || label != dit-&gt;label)
<a name="l01080"></a>01080     {
<a name="l01081"></a>01081         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;matching mapping not found, ignoring withdraw message&quot;</span> &lt;&lt; endl;
<a name="l01082"></a>01082         <span class="keyword">delete</span> packet;
<a name="l01083"></a>01083         <span class="keywordflow">return</span>;
<a name="l01084"></a>01084     }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086     ASSERT(dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end());
<a name="l01087"></a>01087     ASSERT(label == dit-&gt;label);
<a name="l01088"></a>01088 
<a name="l01089"></a>01089     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;removing label from list of received mappings&quot;</span> &lt;&lt; endl;
<a name="l01090"></a>01090     <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.erase(dit);
<a name="l01091"></a>01091 
<a name="l01092"></a>01092     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;sending back relase message&quot;</span> &lt;&lt; endl;
<a name="l01093"></a>01093     packet-&gt;<a class="code" href="class_l_d_p_packet.html#a484a59e3cb14cb70dac6cbdf22f1fb9d">setType</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3ad4cdfab707c90f09c9bd6481e3c2406d">LABEL_RELEASE</a>);
<a name="l01094"></a>01094 
<a name="l01095"></a>01095     <span class="comment">// send msg to peer over TCP</span>
<a name="l01096"></a>01096     <a class="code" href="class_l_d_p.html#a05a988b6638a853db0ea2fe3cdef0f12">sendToPeer</a>(fromIP, packet);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098     <a class="code" href="class_l_d_p.html#a9ebd9c14dc3c8b3818252dad37dcc5a5">updateFecListEntry</a>(*it);
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a><a class="code" href="class_l_d_p.html#ad4960396a93e0b4b3b71f9cd16c2a9b7">01101</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#ad4960396a93e0b4b3b71f9cd16c2a9b7">LDP::processLABEL_MAPPING</a>(<a class="code" href="class_l_d_p_label_mapping.html">LDPLabelMapping</a> *packet)
<a name="l01102"></a>01102 {
<a name="l01103"></a>01103     <a class="code" href="struct_f_e_c___t_l_v.html">FEC_TLV</a> fec = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#ab4363c064c8a65a3a5eec995462bff66">getFec</a>();
<a name="l01104"></a>01104     <span class="keywordtype">int</span> label = packet-&gt;<a class="code" href="class_l_d_p_label_mapping.html#a948b6496f30a911cb48ae3dc744f676f">getLabel</a>();
<a name="l01105"></a>01105     <a class="code" href="class_i_p_address.html">IPAddress</a> fromIP = packet-&gt;<a class="code" href="class_l_d_p_packet.html#a5969f516c19ff0d0c6b4ce6429e49f76">getSenderAddress</a>();
<a name="l01106"></a>01106 
<a name="l01107"></a>01107     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;Label mapping label=&quot;</span> &lt;&lt; label &lt;&lt; <span class="stringliteral">&quot; received for fec=&quot;</span> &lt;&lt; fec &lt;&lt; <span class="stringliteral">&quot; from &quot;</span> &lt;&lt; fromIP &lt;&lt; endl;
<a name="l01108"></a>01108 
<a name="l01109"></a>01109     ASSERT(label &gt; 0);
<a name="l01110"></a>01110 
<a name="l01111"></a>01111     FecVector::iterator it = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#abd7a5297a97dd0212bae8e2c86d285d2">addr</a>, fec.<a class="code" href="struct_f_e_c___t_l_v.html#a2458693c3117cfa3fc4e43aa0c17f84e">length</a>);
<a name="l01112"></a>01112     ASSERT(it != <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end());
<a name="l01113"></a>01113 
<a name="l01114"></a>01114     FecBindVector::iterator dit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>, it-&gt;fecid, fromIP);
<a name="l01115"></a>01115     ASSERT(dit == <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end());
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     <span class="comment">// insert among received mappings</span>
<a name="l01118"></a>01118 
<a name="l01119"></a>01119     <a class="code" href="struct_l_d_p_1_1fec__bind__t.html">fec_bind_t</a> newItem;
<a name="l01120"></a>01120     newItem.fecid = it-&gt;fecid;
<a name="l01121"></a>01121     newItem.peer = fromIP;
<a name="l01122"></a>01122     newItem.label = label;
<a name="l01123"></a>01123     <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.push_back(newItem);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">// respond to pending requests</span>
<a name="l01126"></a>01126 
<a name="l01127"></a>01127     PendingVector::iterator pit;
<a name="l01128"></a>01128     <span class="keywordflow">for</span> (pit = <a class="code" href="class_l_d_p.html#a057aa332bfc1ddcbc2d66e73de161af9">pending</a>.begin(); pit != <a class="code" href="class_l_d_p.html#a057aa332bfc1ddcbc2d66e73de161af9">pending</a>.end();)
<a name="l01129"></a>01129     {
<a name="l01130"></a>01130         <span class="keywordflow">if</span> (pit-&gt;fecid != it-&gt;fecid)
<a name="l01131"></a>01131         {
<a name="l01132"></a>01132             pit++;
<a name="l01133"></a>01133             <span class="keywordflow">continue</span>;
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;there&apos;s pending request for this FEC from &quot;</span> &lt;&lt; pit-&gt;peer &lt;&lt; <span class="stringliteral">&quot;, sending mapping&quot;</span> &lt;&lt; endl;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138         std::string inInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(pit-&gt;peer);
<a name="l01139"></a>01139         std::string outInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(fromIP);
<a name="l01140"></a>01140         <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a> outLabel = <a class="code" href="class_l_i_b_table.html#adc5fdcd5d807e663b467ff91e719873f">LIBTable::swapLabel</a>(label);
<a name="l01141"></a>01141 
<a name="l01142"></a>01142         <a class="code" href="struct_l_d_p_1_1fec__bind__t.html">fec_bind_t</a> newItem;
<a name="l01143"></a>01143         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a641b231f6ae1b8ad59c76872031fe86c">fecid</a> = it-&gt;fecid;
<a name="l01144"></a>01144         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a50a515dc50f5f76e99efccaa2145a14b">peer</a> = pit-&gt;peer;
<a name="l01145"></a>01145         newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a539f7f3b600b0ab7184622a5f1361f77">label</a> = <a class="code" href="class_l_d_p.html#ad01cfb57e93718e4bcb371baa1b40b2c">lt</a>-&gt;<a class="code" href="class_l_i_b_table.html#a6599a694b9035a18dbc01bd0c52b54f7">installLibEntry</a>(-1, inInterface, outLabel, outInterface, <a class="code" href="_l_d_p_8h.html#a819e3794dd985814c77459acdb71042f">LDP_USER_TRAFFIC</a>);
<a name="l01146"></a>01146         <a class="code" href="class_l_d_p.html#a4a68ff892f3bf90bf48be17ab784ab68">fecUp</a>.push_back(newItem);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;installed LIB entry inLabel=&quot;</span> &lt;&lt; newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a539f7f3b600b0ab7184622a5f1361f77">label</a> &lt;&lt; <span class="stringliteral">&quot; inInterface=&quot;</span> &lt;&lt; inInterface &lt;&lt;
<a name="l01149"></a>01149                 <span class="stringliteral">&quot; outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot; outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l01150"></a>01150 
<a name="l01151"></a>01151         <a class="code" href="class_l_d_p.html#a3aade2e69231697175fe874a2ef9d2b2">sendMapping</a>(<a class="code" href="_l_d_p_packet__m_8h.html#a0427916c08194b31d2adf5da83f635b3a21684054f4791ac4ad3ecd4cffd4c8f4">LABEL_MAPPING</a>, pit-&gt;peer, newItem.<a class="code" href="struct_l_d_p_1_1fec__bind__t.html#a539f7f3b600b0ab7184622a5f1361f77">label</a>, it-&gt;addr, it-&gt;length);
<a name="l01152"></a>01152 
<a name="l01153"></a>01153         <span class="comment">// remove request from the list</span>
<a name="l01154"></a>01154         pit = <a class="code" href="class_l_d_p.html#a057aa332bfc1ddcbc2d66e73de161af9">pending</a>.erase(pit);
<a name="l01155"></a>01155     }
<a name="l01156"></a>01156 
<a name="l01157"></a>01157     <span class="keyword">delete</span> packet;
<a name="l01158"></a>01158 }
<a name="l01159"></a>01159 
<a name="l01160"></a><a class="code" href="class_l_d_p.html#aaf2b4ec7ae7b2006fccd8d208dfbb471">01160</a> <span class="keywordtype">int</span> <a class="code" href="class_l_d_p.html#aaf2b4ec7ae7b2006fccd8d208dfbb471">LDP::findPeer</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> peerAddr)
<a name="l01161"></a>01161 {
<a name="l01162"></a>01162     <span class="keywordflow">for</span> (PeerVector::iterator i=<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.begin(); i!=<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.end(); ++i)
<a name="l01163"></a>01163         <span class="keywordflow">if</span> (i-&gt;peerIP==peerAddr)
<a name="l01164"></a>01164             <span class="keywordflow">return</span> i-<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>.begin();
<a name="l01165"></a>01165     <span class="keywordflow">return</span> -1;
<a name="l01166"></a>01166 }
<a name="l01167"></a>01167 
<a name="l01168"></a><a class="code" href="class_l_d_p.html#a43170c3c37870c56f321b8a2e24ec420">01168</a> <a class="code" href="class_t_c_p_socket.html">TCPSocket</a> *<a class="code" href="class_l_d_p.html#a43170c3c37870c56f321b8a2e24ec420">LDP::findPeerSocket</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> peerAddr)
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170     <span class="comment">// find peer in table and return its socket</span>
<a name="l01171"></a>01171     <span class="keywordtype">int</span> i = <a class="code" href="class_l_d_p.html#aaf2b4ec7ae7b2006fccd8d208dfbb471">findPeer</a>(peerAddr);
<a name="l01172"></a>01172     <span class="keywordflow">if</span> (i==-1 || !(<a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket) || <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket-&gt;getState()!=<a class="code" href="class_t_c_p_socket.html#a67a345df44f8b47c59c59cca81c9f7f9a45c2bba31a1f55997af51b27d0df4d72">TCPSocket::CONNECTED</a>)
<a name="l01173"></a>01173         <span class="keywordflow">return</span> NULL; <span class="comment">// we don&apos;t have an LDP session to this peer</span>
<a name="l01174"></a>01174     <span class="keywordflow">return</span> <a class="code" href="class_l_d_p.html#ac6b7a183f4c0b9b0ee62844602c81234">myPeers</a>[i].socket;
<a name="l01175"></a>01175 }
<a name="l01176"></a>01176 
<a name="l01177"></a><a class="code" href="class_l_d_p.html#a37df6239993d84988793c63eaf8f1940">01177</a> <a class="code" href="class_t_c_p_socket.html">TCPSocket</a> *<a class="code" href="class_l_d_p.html#a37df6239993d84988793c63eaf8f1940">LDP::getPeerSocket</a>(<a class="code" href="class_i_p_address.html">IPAddress</a> peerAddr)
<a name="l01178"></a>01178 {
<a name="l01179"></a>01179     <a class="code" href="class_t_c_p_socket.html">TCPSocket</a> *sock = <a class="code" href="class_l_d_p.html#a43170c3c37870c56f321b8a2e24ec420">findPeerSocket</a>(peerAddr);
<a name="l01180"></a>01180     ASSERT(sock);
<a name="l01181"></a>01181     <span class="keywordflow">if</span> (!sock)
<a name="l01182"></a>01182         error(<span class="stringliteral">&quot;No LDP session to peer %s yet&quot;</span>, peerAddr.<a class="code" href="class_i_p_address.html#a50f58febbf2ded78b9f6e32e579f5d2b">str</a>().c_str());
<a name="l01183"></a>01183     <span class="keywordflow">return</span> sock;
<a name="l01184"></a>01184 }
<a name="l01185"></a>01185 
<a name="l01186"></a><a class="code" href="class_l_d_p.html#a32c1d82d8c9a523a4c1e09858f14d315">01186</a> <span class="keywordtype">bool</span> <a class="code" href="class_l_d_p.html#a32c1d82d8c9a523a4c1e09858f14d315">LDP::lookupLabel</a>(<a class="code" href="class_i_p_datagram.html">IPDatagram</a> *ipdatagram, <a class="code" href="_l_i_b_table_8h.html#a40d505abe4d03bca1c9776ebb1a874e5">LabelOpVector</a>&amp; outLabel, std::string&amp; outInterface, <span class="keywordtype">int</span>&amp; color)
<a name="l01187"></a>01187 {
<a name="l01188"></a>01188     <a class="code" href="class_i_p_address.html">IPAddress</a> destAddr = ipdatagram-&gt;<a class="code" href="class_i_p_datagram.html#afe5a14d5aefc5cc9e0ffeedb31a62d1c">getDestAddress</a>();
<a name="l01189"></a>01189     <span class="keywordtype">int</span> protocol = ipdatagram-&gt;<a class="code" href="class_i_p_datagram.html#acbe285538d27d18ab788c63399e81947">getTransportProtocol</a>();
<a name="l01190"></a>01190 
<a name="l01191"></a>01191     <span class="comment">// never match and always route via L3 if:</span>
<a name="l01192"></a>01192 
<a name="l01193"></a>01193     <span class="comment">// OSPF traffic (TED)</span>
<a name="l01194"></a>01194     <span class="keywordflow">if</span> (protocol == <a class="code" href="_i_p_protocol_id__m_8h.html#a4297c2f400ba53cf6866e6d45bc81b70a286260df5de676497bee26c4c6ea7f1e">IP_PROT_OSPF</a>)
<a name="l01195"></a>01195         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01196"></a>01196 
<a name="l01197"></a>01197     <span class="comment">// LDP traffic (both discovery...</span>
<a name="l01198"></a>01198     <span class="keywordflow">if</span> (protocol == <a class="code" href="_i_p_protocol_id__m_8h.html#a4297c2f400ba53cf6866e6d45bc81b70ab9e6b0f8ec9223d758f4825004489bd2">IP_PROT_UDP</a> &amp;&amp; check_and_cast&lt;UDPPacket*&gt;(ipdatagram-&gt;getEncapsulatedMsg())-&gt;getDestinationPort() == <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>)
<a name="l01199"></a>01199         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01200"></a>01200 
<a name="l01201"></a>01201     <span class="comment">// ...and session)</span>
<a name="l01202"></a>01202     <span class="keywordflow">if</span> (protocol == <a class="code" href="_i_p_protocol_id__m_8h.html#a4297c2f400ba53cf6866e6d45bc81b70a69fd8777dfd279b247a88b6eec793bd7">IP_PROT_TCP</a> &amp;&amp; check_and_cast&lt;TCPSegment*&gt;(ipdatagram-&gt;getEncapsulatedMsg())-&gt;getDestPort() == <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>)
<a name="l01203"></a>01203         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01204"></a>01204     <span class="keywordflow">if</span> (protocol == <a class="code" href="_i_p_protocol_id__m_8h.html#a4297c2f400ba53cf6866e6d45bc81b70a69fd8777dfd279b247a88b6eec793bd7">IP_PROT_TCP</a> &amp;&amp; check_and_cast&lt;TCPSegment*&gt;(ipdatagram-&gt;getEncapsulatedMsg())-&gt;getSrcPort() == <a class="code" href="_l_d_p_8h.html#a10b9b0d50dcb805c5a1db8aa8c02ca3d">LDP_PORT</a>)
<a name="l01205"></a>01205         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01206"></a>01206 
<a name="l01207"></a>01207     <span class="comment">// regular traffic, classify, label etc.</span>
<a name="l01208"></a>01208 
<a name="l01209"></a>01209     FecVector::iterator it;
<a name="l01210"></a>01210     <span class="keywordflow">for</span> (it = <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.begin(); it != <a class="code" href="class_l_d_p.html#a9e200f70feb90376616a54cc2f097495">fecList</a>.end(); it++)
<a name="l01211"></a>01211     {
<a name="l01212"></a>01212         <span class="keywordflow">if</span> (!destAddr.<a class="code" href="class_i_p_address.html#aedd7377a261c477938810b12ad214bbe">prefixMatches</a>(it-&gt;addr, it-&gt;length))
<a name="l01213"></a>01213             <span class="keywordflow">continue</span>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215         <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;FEC matched: &quot;</span> &lt;&lt; *it &lt;&lt; endl;
<a name="l01216"></a>01216 
<a name="l01217"></a>01217         FecBindVector::iterator dit = <a class="code" href="class_l_d_p.html#ab4e2317f84829818f0e37149da27853c">findFecEntry</a>(<a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>, it-&gt;fecid, it-&gt;nextHop);
<a name="l01218"></a>01218         <span class="keywordflow">if</span> (dit != <a class="code" href="class_l_d_p.html#ae1b59d4f467febb09406e13f610f7c7c">fecDown</a>.end())
<a name="l01219"></a>01219         {
<a name="l01220"></a>01220             outLabel = <a class="code" href="class_l_i_b_table.html#ac2df27758d1ee76e52d22d3ced09bbbd">LIBTable::pushLabel</a>(dit-&gt;label);
<a name="l01221"></a>01221             outInterface = <a class="code" href="class_l_d_p.html#ab124d80cf623c4a5d4551075612b1243">findInterfaceFromPeerAddr</a>(it-&gt;nextHop);
<a name="l01222"></a>01222             color = <a class="code" href="_l_d_p_8h.html#a819e3794dd985814c77459acdb71042f">LDP_USER_TRAFFIC</a>;
<a name="l01223"></a>01223             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;mapping found, outLabel=&quot;</span> &lt;&lt; outLabel &lt;&lt; <span class="stringliteral">&quot;, outInterface=&quot;</span> &lt;&lt; outInterface &lt;&lt; endl;
<a name="l01224"></a>01224             <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01225"></a>01225         }
<a name="l01226"></a>01226         <span class="keywordflow">else</span>
<a name="l01227"></a>01227         {
<a name="l01228"></a>01228             <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;no mapping for this FEC exists&quot;</span> &lt;&lt; endl;
<a name="l01229"></a>01229             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01230"></a>01230         }
<a name="l01231"></a>01231     }
<a name="l01232"></a>01232     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l01233"></a>01233 }
<a name="l01234"></a>01234 
<a name="l01235"></a><a class="code" href="class_l_d_p.html#a075009e8998b02f670d1439c33863e90">01235</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a075009e8998b02f670d1439c33863e90">LDP::receiveChangeNotification</a>(<span class="keywordtype">int</span> category, <span class="keyword">const</span> cPolymorphic *details)
<a name="l01236"></a>01236 {
<a name="l01237"></a>01237     Enter_Method_Silent();
<a name="l01238"></a>01238     <a class="code" href="_notifier_consts_8cc.html#a68fd4b933fae636048bb9ee52fd922e5">printNotificationBanner</a>(category, details);
<a name="l01239"></a>01239 
<a name="l01240"></a>01240     ASSERT(category==<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba38a4632902da5c126d1b1bc992799303">NF_IPv4_ROUTE_ADDED</a> || category==<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba250243f132a5001e082e2c58b25eb0f1">NF_IPv4_ROUTE_DELETED</a>);
<a name="l01241"></a>01241 
<a name="l01242"></a>01242     <a class="code" href="_basic_module_8h.html#a650ef3eff8a2900bef69dae29c05d2dd">EV</a> &lt;&lt; <span class="stringliteral">&quot;routing table changed, rebuild list of known FEC&quot;</span> &lt;&lt; endl;
<a name="l01243"></a>01243 
<a name="l01244"></a>01244     <a class="code" href="class_l_d_p.html#a4f61fee380b47683aef8f450b4704940">rebuildFecList</a>();
<a name="l01245"></a>01245 }
<a name="l01246"></a>01246 
<a name="l01247"></a><a class="code" href="class_l_d_p.html#a62f103f31701a61dd42b6814770245fe">01247</a> <span class="keywordtype">void</span> <a class="code" href="class_l_d_p.html#a62f103f31701a61dd42b6814770245fe">LDP::announceLinkChange</a>(<span class="keywordtype">int</span> tedlinkindex)
<a name="l01248"></a>01248 {
<a name="l01249"></a>01249     <a class="code" href="class_t_e_d_change_info.html">TEDChangeInfo</a> d;
<a name="l01250"></a>01250     d.<a class="code" href="class_t_e_d_change_info.html#a9b38462cb6f5358730bfc8c84ce2edf8">setTedLinkIndicesArraySize</a>(1);
<a name="l01251"></a>01251     d.<a class="code" href="class_t_e_d_change_info.html#a0266442f016422d4bc5048953f082cb9">setTedLinkIndices</a>(0, tedlinkindex);
<a name="l01252"></a>01252     <a class="code" href="class_l_d_p.html#a6cd3cdeb303dcbcd51acecae0615ffbd">nb</a>-&gt;<a class="code" href="class_notification_board.html#a2bb0a5aa0cb272a9b15cb5a58a253fcc">fireChangeNotification</a>(<a class="code" href="_notifier_consts_8h.html#a06fc87d81c62e9abb8790b6e5713c55ba8434e8b760269c6f9680f8fdb45b8a2c">NF_TED_CHANGED</a>, &amp;d);
<a name="l01253"></a>01253 }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Mar 23 17:08:28 2010 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
