<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>INET Framework for OMNeT++/OMNEST: TCPConnectionRcvSegment.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_493eba74639f722aa88bd3d010f621b5.html">src</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_34a6fbd47227bd78d46d19b24c6937db.html">transport</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_23dcbde7125bae442be2e4354e9c80e9.html">tcp_old</a>
  </div>
</div>
<div class="contents">
<h1>old/TCPConnectionRcvSegment.cc</h1><a href="old_2_t_c_p_connection_rcv_segment_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">//</span>
<a name="l00002"></a>00002 <span class="comment">// Copyright (C) 2004 Andras Varga</span>
<a name="l00003"></a>00003 <span class="comment">//</span>
<a name="l00004"></a>00004 <span class="comment">// This program is free software; you can redistribute it and/or</span>
<a name="l00005"></a>00005 <span class="comment">// modify it under the terms of the GNU Lesser General Public License</span>
<a name="l00006"></a>00006 <span class="comment">// as published by the Free Software Foundation; either version 2</span>
<a name="l00007"></a>00007 <span class="comment">// of the License, or (at your option) any later version.</span>
<a name="l00008"></a>00008 <span class="comment">//</span>
<a name="l00009"></a>00009 <span class="comment">// This program is distributed in the hope that it will be useful,</span>
<a name="l00010"></a>00010 <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00011"></a>00011 <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00012"></a>00012 <span class="comment">// GNU Lesser General Public License for more details.</span>
<a name="l00013"></a>00013 <span class="comment">//</span>
<a name="l00014"></a>00014 <span class="comment">// You should have received a copy of the GNU Lesser General Public License</span>
<a name="l00015"></a>00015 <span class="comment">// along with this program; if not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l00016"></a>00016 <span class="comment">//</span>
<a name="l00017"></a>00017 
<a name="l00018"></a>00018 
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00020"></a>00020 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p__old_8h.html">TCP_old.h</a>&quot;</span>
<a name="l00021"></a>00021 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_connection__old_8h.html">TCPConnection_old.h</a>&quot;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_segment_8h.html">TCPSegment.h</a>&quot;</span>
<a name="l00023"></a>00023 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_command__m_8h.html">TCPCommand_m.h</a>&quot;</span>
<a name="l00024"></a>00024 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_send_queue__old_8h.html">TCPSendQueue_old.h</a>&quot;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_receive_queue__old_8h.html">TCPReceiveQueue_old.h</a>&quot;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="_t_c_p_algorithm__old_8h.html">TCPAlgorithm_old.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <span class="keyword">using namespace </span>tcp_old;
<a name="l00029"></a>00029 
<a name="l00030"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a9b7d3f811eab0367d3826dfb20c8d931">00030</a> <span class="keywordtype">bool</span> <a class="code" href="class_t_c_p_connection.html#a9b7d3f811eab0367d3826dfb20c8d931">TCPConnection::tryFastRoute</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00031"></a>00031 {
<a name="l00032"></a>00032     <span class="comment">// fast route processing not yet implemented</span>
<a name="l00033"></a>00033     <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00034"></a>00034 }
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 
<a name="l00037"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a82f6b7680530f0f784e9d8efa78fa5a5">00037</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a82f6b7680530f0f784e9d8efa78fa5a5">TCPConnection::segmentArrivalWhileClosed</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00038"></a>00038 {
<a name="l00039"></a>00039     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Seg arrived: &quot;</span>;
<a name="l00040"></a>00040     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a188549e7c936c8cad622c180d3200c69">printSegmentBrief</a>(tcpseg);
<a name="l00041"></a>00041 
<a name="l00042"></a>00042     <span class="comment">// This segment doesn&apos;t belong to any connection, so this object</span>
<a name="l00043"></a>00043     <span class="comment">// must be a temp object created solely for the purpose of calling us</span>
<a name="l00044"></a>00044     ASSERT(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>==NULL);
<a name="l00045"></a>00045     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Segment doesn&apos;t belong to any existing connection\n&quot;</span>;
<a name="l00046"></a>00046 
<a name="l00047"></a>00047     <span class="comment">// RFC 793:</span>
<a name="l00048"></a>00048     <span class="comment">//&quot;</span>
<a name="l00049"></a>00049     <span class="comment">// all data in the incoming segment is discarded.  An incoming</span>
<a name="l00050"></a>00050     <span class="comment">// segment containing a RST is discarded.  An incoming segment not</span>
<a name="l00051"></a>00051     <span class="comment">// containing a RST causes a RST to be sent in response.  The</span>
<a name="l00052"></a>00052     <span class="comment">// acknowledgment and sequence field values are selected to make the</span>
<a name="l00053"></a>00053     <span class="comment">// reset sequence acceptable to the TCP that sent the offending</span>
<a name="l00054"></a>00054     <span class="comment">// segment.</span>
<a name="l00055"></a>00055     <span class="comment">//</span>
<a name="l00056"></a>00056     <span class="comment">// If the ACK bit is off, sequence number zero is used,</span>
<a name="l00057"></a>00057     <span class="comment">//</span>
<a name="l00058"></a>00058     <span class="comment">//    &lt;SEQ=0&gt;&lt;ACK=SEG.SEQ+SEG.LEN&gt;&lt;CTL=RST,ACK&gt;</span>
<a name="l00059"></a>00059     <span class="comment">//</span>
<a name="l00060"></a>00060     <span class="comment">// If the ACK bit is on,</span>
<a name="l00061"></a>00061     <span class="comment">//</span>
<a name="l00062"></a>00062     <span class="comment">//    &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00063"></a>00063     <span class="comment">//&quot;</span>
<a name="l00064"></a>00064     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00065"></a>00065     {
<a name="l00066"></a>00066         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST bit set: dropping segment\n&quot;</span>;
<a name="l00067"></a>00067         <span class="keywordflow">return</span>;
<a name="l00068"></a>00068     }
<a name="l00069"></a>00069 
<a name="l00070"></a>00070     <span class="keywordflow">if</span> (!tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00071"></a>00071     {
<a name="l00072"></a>00072         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit not set: sending RST+ACK\n&quot;</span>;
<a name="l00073"></a>00073         uint32 ackNo = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00074"></a>00074         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ade3c9c38be0aa758b4eb448d5c1169b9">sendRstAck</a>(0,ackNo,destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00075"></a>00075     }
<a name="l00076"></a>00076     <span class="keywordflow">else</span>
<a name="l00077"></a>00077     {
<a name="l00078"></a>00078         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set: sending RST\n&quot;</span>;
<a name="l00079"></a>00079         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081 }
<a name="l00082"></a>00082 
<a name="l00083"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a46ac1b09624942471db2eb76ef991143">00083</a> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a46ac1b09624942471db2eb76ef991143">TCPConnection::process_RCV_SEGMENT</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> src, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> dest)
<a name="l00084"></a>00084 {
<a name="l00085"></a>00085     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Seg arrived: &quot;</span>;
<a name="l00086"></a>00086     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a188549e7c936c8cad622c180d3200c69">printSegmentBrief</a>(tcpseg);
<a name="l00087"></a>00087     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;TCB: &quot;</span> &lt;&lt; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a93fbf3558fe0e1dfa27bdbab25c36aff">info</a>() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#acb4230bb789e0bf3e413479e26316d60">rcvSeqVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#acb4230bb789e0bf3e413479e26316d60">rcvSeqVector</a>-&gt;record(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>());
<a name="l00090"></a>00090     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7b6c1fcdd10a035c035dea350420286d">rcvAckVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7b6c1fcdd10a035c035dea350420286d">rcvAckVector</a>-&gt;record(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l00091"></a>00091 
<a name="l00092"></a>00092     <span class="comment">//</span>
<a name="l00093"></a>00093     <span class="comment">// Note: this code is organized exactly as RFC 793, section &quot;3.9 Event</span>
<a name="l00094"></a>00094     <span class="comment">// Processing&quot;, subsection &quot;SEGMENT ARRIVES&quot;.</span>
<a name="l00095"></a>00095     <span class="comment">//</span>
<a name="l00096"></a>00096     <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> event;
<a name="l00097"></a>00097     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a809324e3edea6ff6800a639d7bcea2">TCP_S_LISTEN</a>)
<a name="l00098"></a>00098     {
<a name="l00099"></a>00099         <span class="keyword">event</span> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">processSegmentInListen</a>(tcpseg, src, dest);
<a name="l00100"></a>00100     }
<a name="l00101"></a>00101     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaafde4b4cc43d59d14ba2cbf0bc3adb525">TCP_S_SYN_SENT</a>)
<a name="l00102"></a>00102     {
<a name="l00103"></a>00103         <span class="keyword">event</span> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">processSegmentInSynSent</a>(tcpseg, src, dest);
<a name="l00104"></a>00104     }
<a name="l00105"></a>00105     <span class="keywordflow">else</span>
<a name="l00106"></a>00106     {
<a name="l00107"></a>00107         <span class="comment">// RFC 793 steps &quot;first check sequence number&quot;, &quot;second check the RST bit&quot;, etc</span>
<a name="l00108"></a>00108         <span class="keyword">event</span> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">processSegment1stThru8th</a>(tcpseg);
<a name="l00109"></a>00109     }
<a name="l00110"></a>00110     <span class="keyword">delete</span> tcpseg;
<a name="l00111"></a>00111     <span class="keywordflow">return</span> event;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 
<a name="l00114"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">00114</a> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa0758284e5bd6bd162b6ff267add2e2d">TCPConnection::processSegment1stThru8th</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00115"></a>00115 {
<a name="l00116"></a>00116     <span class="comment">//</span>
<a name="l00117"></a>00117     <span class="comment">// RFC 793: first check sequence number</span>
<a name="l00118"></a>00118     <span class="comment">//</span>
<a name="l00119"></a>00119     <span class="keywordtype">bool</span> acceptable = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#acceb561b23349d06b298858e39433435">isSegmentAcceptable</a>(tcpseg);
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (!acceptable)
<a name="l00121"></a>00121     {
<a name="l00122"></a>00122         <span class="comment">//&quot;</span>
<a name="l00123"></a>00123         <span class="comment">// If an incoming segment is not acceptable, an acknowledgment</span>
<a name="l00124"></a>00124         <span class="comment">// should be sent in reply (unless the RST bit is set, if so drop</span>
<a name="l00125"></a>00125         <span class="comment">// the segment and return):</span>
<a name="l00126"></a>00126         <span class="comment">//</span>
<a name="l00127"></a>00127         <span class="comment">//  &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00128"></a>00128         <span class="comment">//&quot;</span>
<a name="l00129"></a>00129         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00130"></a>00130         {
<a name="l00131"></a>00131             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST with unacceptable seqNum: dropping\n&quot;</span>;
<a name="l00132"></a>00132         }
<a name="l00133"></a>00133         <span class="keywordflow">else</span>
<a name="l00134"></a>00134         {
<a name="l00135"></a>00135             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Segment seqNum not acceptable, sending ACK with current receive seq\n&quot;</span>;
<a name="l00136"></a>00136             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a60ee5bc5b391d621e7e684857e195151">sendAck</a>();
<a name="l00137"></a>00137         }
<a name="l00138"></a>00138         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00139"></a>00139     }
<a name="l00140"></a>00140 
<a name="l00141"></a>00141     <span class="comment">//</span>
<a name="l00142"></a>00142     <span class="comment">// RFC 793: second check the RST bit,</span>
<a name="l00143"></a>00143     <span class="comment">//</span>
<a name="l00144"></a>00144     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00145"></a>00145     {
<a name="l00146"></a>00146         <span class="comment">// Note: if we come from LISTEN, processSegmentInListen() has already handled RST.</span>
<a name="l00147"></a>00147         <span class="keywordflow">switch</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l00148"></a>00148         {
<a name="l00149"></a>00149             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a>:
<a name="l00150"></a>00150                 <span class="comment">//&quot;</span>
<a name="l00151"></a>00151                 <span class="comment">// If this connection was initiated with a passive OPEN (i.e.,</span>
<a name="l00152"></a>00152                 <span class="comment">// came from the LISTEN state), then return this connection to</span>
<a name="l00153"></a>00153                 <span class="comment">// LISTEN state and return.  The user need not be informed.  If</span>
<a name="l00154"></a>00154                 <span class="comment">// this connection was initiated with an active OPEN (i.e., came</span>
<a name="l00155"></a>00155                 <span class="comment">// from SYN-SENT state) then the connection was refused, signal</span>
<a name="l00156"></a>00156                 <span class="comment">// the user &quot;connection refused&quot;.  In either case, all segments</span>
<a name="l00157"></a>00157                 <span class="comment">// on the retransmission queue should be removed.  And in the</span>
<a name="l00158"></a>00158                 <span class="comment">// active OPEN case, enter the CLOSED state and delete the TCB,</span>
<a name="l00159"></a>00159                 <span class="comment">// and return.</span>
<a name="l00160"></a>00160                 <span class="comment">//&quot;</span>
<a name="l00161"></a>00161                 <span class="keywordflow">return</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">processRstInSynReceived</a>(tcpseg);
<a name="l00162"></a>00162 
<a name="l00163"></a>00163             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3b4387f45a765235dfda0bf3111ba1c6">TCP_S_ESTABLISHED</a>:
<a name="l00164"></a>00164             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a>:
<a name="l00165"></a>00165             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>:
<a name="l00166"></a>00166             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3395b6fd6b4cf5d6165b37929d44eaa1">TCP_S_CLOSE_WAIT</a>:
<a name="l00167"></a>00167                 <span class="comment">//&quot;</span>
<a name="l00168"></a>00168                 <span class="comment">// If the RST bit is set then, any outstanding RECEIVEs and SEND</span>
<a name="l00169"></a>00169                 <span class="comment">// should receive &quot;reset&quot; responses.  All segment queues should be</span>
<a name="l00170"></a>00170                 <span class="comment">// flushed.  Users should also receive an unsolicited general</span>
<a name="l00171"></a>00171                 <span class="comment">// &quot;connection reset&quot; signal.</span>
<a name="l00172"></a>00172                 <span class="comment">//</span>
<a name="l00173"></a>00173                 <span class="comment">// Enter the CLOSED state, delete the TCB, and return.</span>
<a name="l00174"></a>00174                 <span class="comment">//&quot;</span>
<a name="l00175"></a>00175                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST: performing connection reset, closing connection\n&quot;</span>;
<a name="l00176"></a>00176                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00177"></a>00177                 <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a050c79add513afca8554e29b61fd5389">TCP_E_RCV_RST</a>;  <span class="comment">// this will trigger state transition</span>
<a name="l00178"></a>00178 
<a name="l00179"></a>00179             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaacdbad950a89de6fc964c3257d45e07a9">TCP_S_CLOSING</a>:
<a name="l00180"></a>00180             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaac5147b505ddf6bb15d84853242bcfdf">TCP_S_LAST_ACK</a>:
<a name="l00181"></a>00181             <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>:
<a name="l00182"></a>00182                 <span class="comment">//&quot;</span>
<a name="l00183"></a>00183                 <span class="comment">// enter the CLOSED state, delete the TCB, and return.</span>
<a name="l00184"></a>00184                 <span class="comment">//&quot;</span>
<a name="l00185"></a>00185                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST: closing connection\n&quot;</span>;
<a name="l00186"></a>00186                 <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()!=<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>)
<a name="l00187"></a>00187                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>); <span class="comment">// in TIME_WAIT, we&apos;ve already sent it</span>
<a name="l00188"></a>00188                 <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a050c79add513afca8554e29b61fd5389">TCP_E_RCV_RST</a>; <span class="comment">// this will trigger state transition</span>
<a name="l00189"></a>00189 
<a name="l00190"></a>00190             <span class="keywordflow">default</span>: ASSERT(0);
<a name="l00191"></a>00191         }
<a name="l00192"></a>00192     }
<a name="l00193"></a>00193 
<a name="l00194"></a>00194     <span class="comment">// RFC 793: third check security and precedence</span>
<a name="l00195"></a>00195     <span class="comment">// This step is ignored.</span>
<a name="l00196"></a>00196 
<a name="l00197"></a>00197     <span class="comment">//</span>
<a name="l00198"></a>00198     <span class="comment">// RFC 793: fourth, check the SYN bit,</span>
<a name="l00199"></a>00199     <span class="comment">//</span>
<a name="l00200"></a>00200     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00201"></a>00201     {
<a name="l00202"></a>00202         <span class="comment">//&quot;</span>
<a name="l00203"></a>00203         <span class="comment">// If the SYN is in the window it is an error, send a reset, any</span>
<a name="l00204"></a>00204         <span class="comment">// outstanding RECEIVEs and SEND should receive &quot;reset&quot; responses,</span>
<a name="l00205"></a>00205         <span class="comment">// all segment queues should be flushed, the user should also</span>
<a name="l00206"></a>00206         <span class="comment">// receive an unsolicited general &quot;connection reset&quot; signal, enter</span>
<a name="l00207"></a>00207         <span class="comment">// the CLOSED state, delete the TCB, and return.</span>
<a name="l00208"></a>00208         <span class="comment">//</span>
<a name="l00209"></a>00209         <span class="comment">// If the SYN is not in the window this step would not be reached</span>
<a name="l00210"></a>00210         <span class="comment">// and an ack would have been sent in the first step (sequence</span>
<a name="l00211"></a>00211         <span class="comment">// number check).</span>
<a name="l00212"></a>00212         <span class="comment">//&quot;</span>
<a name="l00213"></a>00213 
<a name="l00214"></a>00214         ASSERT(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#acceb561b23349d06b298858e39433435">isSegmentAcceptable</a>(tcpseg));  <span class="comment">// assert SYN is in the window</span>
<a name="l00215"></a>00215         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN is in the window: performing connection reset, closing connection\n&quot;</span>;
<a name="l00216"></a>00216         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00217"></a>00217         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a55dbf4b3147f64f1baeac365b019dea6">TCP_E_RCV_UNEXP_SYN</a>;
<a name="l00218"></a>00218     }
<a name="l00219"></a>00219 
<a name="l00220"></a>00220     <span class="comment">//</span>
<a name="l00221"></a>00221     <span class="comment">// RFC 793: fifth check the ACK field,</span>
<a name="l00222"></a>00222     <span class="comment">//</span>
<a name="l00223"></a>00223     <span class="keywordflow">if</span> (!tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00224"></a>00224     {
<a name="l00225"></a>00225         <span class="comment">// if the ACK bit is off drop the segment and return</span>
<a name="l00226"></a>00226         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK not set, dropping segment\n&quot;</span>;
<a name="l00227"></a>00227         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00228"></a>00228     }
<a name="l00229"></a>00229 
<a name="l00230"></a>00230     <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a>)
<a name="l00233"></a>00233     {
<a name="l00234"></a>00234         <span class="comment">//&quot;</span>
<a name="l00235"></a>00235         <span class="comment">// If SND.UNA =&lt; SEG.ACK =&lt; SND.NXT then enter ESTABLISHED state</span>
<a name="l00236"></a>00236         <span class="comment">// and continue processing.</span>
<a name="l00237"></a>00237         <span class="comment">//</span>
<a name="l00238"></a>00238         <span class="comment">// If the segment acknowledgment is not acceptable, form a</span>
<a name="l00239"></a>00239         <span class="comment">// reset segment,</span>
<a name="l00240"></a>00240         <span class="comment">//</span>
<a name="l00241"></a>00241         <span class="comment">//  &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00242"></a>00242         <span class="comment">//</span>
<a name="l00243"></a>00243         <span class="comment">// and send it.</span>
<a name="l00244"></a>00244         <span class="comment">//&quot;</span>
<a name="l00245"></a>00245         <span class="keywordflow">if</span> (!<a class="code" href="namespacetcp__old.html#a2a4d76c437a6e0eb1e1440c02153e5db">seqLE</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()) || !<a class="code" href="namespacetcp__old.html#a2a4d76c437a6e0eb1e1440c02153e5db">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>))
<a name="l00246"></a>00246         {
<a name="l00247"></a>00247             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l00248"></a>00248             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00249"></a>00249         }
<a name="l00250"></a>00250 
<a name="l00251"></a>00251         <span class="comment">// notify tcpAlgorithm and app layer</span>
<a name="l00252"></a>00252         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a6bbeaec803a6c9e148ba36c838c267a5">established</a>(<span class="keyword">false</span>);
<a name="l00253"></a>00253         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab04a91abde05d21293c30a78ab968eef">sendEstabIndicationToApp</a>();
<a name="l00254"></a>00254 
<a name="l00255"></a>00255         <span class="comment">// This will trigger transition to ESTABLISHED. Timers and notifying</span>
<a name="l00256"></a>00256         <span class="comment">// app will be taken care of in stateEntered().</span>
<a name="l00257"></a>00257         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a823e4834ff13aaff8408c38ac1b0f350">TCP_E_RCV_ACK</a>;
<a name="l00258"></a>00258     }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260     uint32 old_snd_nxt = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>; <span class="comment">// later we&apos;ll need to see if snd_nxt changed</span>
<a name="l00261"></a>00261     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3b4387f45a765235dfda0bf3111ba1c6">TCP_S_ESTABLISHED</a> ||
<a name="l00262"></a>00262         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a> ||
<a name="l00263"></a>00263         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3395b6fd6b4cf5d6165b37929d44eaa1">TCP_S_CLOSE_WAIT</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaacdbad950a89de6fc964c3257d45e07a9">TCP_S_CLOSING</a>)
<a name="l00264"></a>00264     {
<a name="l00265"></a>00265         <span class="comment">//</span>
<a name="l00266"></a>00266         <span class="comment">// ESTABLISHED processing:</span>
<a name="l00267"></a>00267         <span class="comment">//&quot;</span>
<a name="l00268"></a>00268         <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT then, set SND.UNA &lt;- SEG.ACK.</span>
<a name="l00269"></a>00269         <span class="comment">//  Any segments on the retransmission queue which are thereby</span>
<a name="l00270"></a>00270         <span class="comment">//  entirely acknowledged are removed.  Users should receive</span>
<a name="l00271"></a>00271         <span class="comment">//  positive acknowledgments for buffers which have been SENT and</span>
<a name="l00272"></a>00272         <span class="comment">//  fully acknowledged (i.e., SEND buffer should be returned with</span>
<a name="l00273"></a>00273         <span class="comment">//  &quot;ok&quot; response).  If the ACK is a duplicate</span>
<a name="l00274"></a>00274         <span class="comment">//  (SEG.ACK &lt; SND.UNA), it can be ignored.  If the ACK acks</span>
<a name="l00275"></a>00275         <span class="comment">//  something not yet sent (SEG.ACK &gt; SND.NXT) then send an ACK,</span>
<a name="l00276"></a>00276         <span class="comment">//  drop the segment, and return.</span>
<a name="l00277"></a>00277         <span class="comment">//</span>
<a name="l00278"></a>00278         <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT, the send window should be</span>
<a name="l00279"></a>00279         <span class="comment">//  updated.  If (SND.WL1 &lt; SEG.SEQ or (SND.WL1 = SEG.SEQ and</span>
<a name="l00280"></a>00280         <span class="comment">//  SND.WL2 =&lt; SEG.ACK)), set SND.WND &lt;- SEG.WND, set</span>
<a name="l00281"></a>00281         <span class="comment">//  SND.WL1 &lt;- SEG.SEQ, and set SND.WL2 &lt;- SEG.ACK.</span>
<a name="l00282"></a>00282         <span class="comment">//</span>
<a name="l00283"></a>00283         <span class="comment">//  Note that SND.WND is an offset from SND.UNA, that SND.WL1</span>
<a name="l00284"></a>00284         <span class="comment">//  records the sequence number of the last segment used to update</span>
<a name="l00285"></a>00285         <span class="comment">//  SND.WND, and that SND.WL2 records the acknowledgment number of</span>
<a name="l00286"></a>00286         <span class="comment">//  the last segment used to update SND.WND.  The check here</span>
<a name="l00287"></a>00287         <span class="comment">//  prevents using old segments to update the window.</span>
<a name="l00288"></a>00288         <span class="comment">//&quot;</span>
<a name="l00289"></a>00289         <span class="keywordtype">bool</span> ok = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">processAckInEstabEtc</a>(tcpseg);
<a name="l00290"></a>00290         <span class="keywordflow">if</span> (!ok)
<a name="l00291"></a>00291             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;  <span class="comment">// if acks something not yet sent, drop it</span>
<a name="l00292"></a>00292     }
<a name="l00293"></a>00293 
<a name="l00294"></a>00294     <span class="keywordflow">if</span> ((<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a> &amp;&amp; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ad2deb1000d47f2e1524f1f5dee059b34">fin_ack_rcvd</a>))
<a name="l00295"></a>00295     {
<a name="l00296"></a>00296         <span class="comment">//&quot;</span>
<a name="l00297"></a>00297         <span class="comment">// FIN-WAIT-1 STATE</span>
<a name="l00298"></a>00298         <span class="comment">//   In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00299"></a>00299         <span class="comment">//   our FIN is now acknowledged then enter FIN-WAIT-2 and continue</span>
<a name="l00300"></a>00300         <span class="comment">//   processing in that state.</span>
<a name="l00301"></a>00301         <span class="comment">//&quot;</span>
<a name="l00302"></a>00302         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a823e4834ff13aaff8408c38ac1b0f350">TCP_E_RCV_ACK</a>;  <span class="comment">// will trigger transition to FIN-WAIT-2</span>
<a name="l00303"></a>00303     }
<a name="l00304"></a>00304 
<a name="l00305"></a>00305     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>)
<a name="l00306"></a>00306     {
<a name="l00307"></a>00307         <span class="comment">//&quot;</span>
<a name="l00308"></a>00308         <span class="comment">// FIN-WAIT-2 STATE</span>
<a name="l00309"></a>00309         <span class="comment">//  In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00310"></a>00310         <span class="comment">//  the retransmission queue is empty, the user&apos;s CLOSE can be</span>
<a name="l00311"></a>00311         <span class="comment">//  acknowledged (&quot;ok&quot;) but do not delete the TCB.</span>
<a name="l00312"></a>00312         <span class="comment">//&quot;</span>
<a name="l00313"></a>00313         <span class="comment">// nothing to do here (in our model, used commands don&apos;t need to be</span>
<a name="l00314"></a>00314         <span class="comment">// acknowledged)</span>
<a name="l00315"></a>00315     }
<a name="l00316"></a>00316 
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaacdbad950a89de6fc964c3257d45e07a9">TCP_S_CLOSING</a>)
<a name="l00318"></a>00318     {
<a name="l00319"></a>00319         <span class="comment">//&quot;</span>
<a name="l00320"></a>00320         <span class="comment">// In addition to the processing for the ESTABLISHED state, if</span>
<a name="l00321"></a>00321         <span class="comment">// the ACK acknowledges our FIN then enter the TIME-WAIT state,</span>
<a name="l00322"></a>00322         <span class="comment">// otherwise ignore the segment.</span>
<a name="l00323"></a>00323         <span class="comment">//&quot;</span>
<a name="l00324"></a>00324         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ad2deb1000d47f2e1524f1f5dee059b34">fin_ack_rcvd</a>)
<a name="l00325"></a>00325         {
<a name="l00326"></a>00326             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Our FIN acked -- can go to TIME_WAIT now\n&quot;</span>;
<a name="l00327"></a>00327             <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a823e4834ff13aaff8408c38ac1b0f350">TCP_E_RCV_ACK</a>;  <span class="comment">// will trigger transition to TIME-WAIT</span>
<a name="l00328"></a>00328             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);  <span class="comment">// start timer</span>
<a name="l00329"></a>00329 
<a name="l00330"></a>00330             <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00331"></a>00331             <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00332"></a>00332             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00333"></a>00333         }
<a name="l00334"></a>00334     }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaac5147b505ddf6bb15d84853242bcfdf">TCP_S_LAST_ACK</a>)
<a name="l00337"></a>00337     {
<a name="l00338"></a>00338         <span class="comment">//&quot;</span>
<a name="l00339"></a>00339         <span class="comment">// The only thing that can arrive in this state is an</span>
<a name="l00340"></a>00340         <span class="comment">// acknowledgment of our FIN.  If our FIN is now acknowledged,</span>
<a name="l00341"></a>00341         <span class="comment">// delete the TCB, enter the CLOSED state, and return.</span>
<a name="l00342"></a>00342         <span class="comment">//&quot;</span>
<a name="l00343"></a>00343         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a2a8d544b5707071afcc5402e6318e245">send_fin</a> &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a1156c4cdd71d0e83c9bb401a68e9f606">snd_fin_seq</a>+1)
<a name="l00344"></a>00344         {
<a name="l00345"></a>00345             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Last ACK arrived\n&quot;</span>;
<a name="l00346"></a>00346             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00347"></a>00347             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a823e4834ff13aaff8408c38ac1b0f350">TCP_E_RCV_ACK</a>; <span class="comment">// will trigger transition to CLOSED</span>
<a name="l00348"></a>00348         }
<a name="l00349"></a>00349     }
<a name="l00350"></a>00350 
<a name="l00351"></a>00351     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>)
<a name="l00352"></a>00352     {
<a name="l00353"></a>00353         <span class="comment">//&quot;</span>
<a name="l00354"></a>00354         <span class="comment">// The only thing that can arrive in this state is a</span>
<a name="l00355"></a>00355         <span class="comment">// retransmission of the remote FIN.  Acknowledge it, and restart</span>
<a name="l00356"></a>00356         <span class="comment">// the 2 MSL timeout.</span>
<a name="l00357"></a>00357         <span class="comment">//&quot;</span>
<a name="l00358"></a>00358         <span class="comment">// And we are staying in the TIME_WAIT state.</span>
<a name="l00359"></a>00359         <span class="comment">//</span>
<a name="l00360"></a>00360         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a60ee5bc5b391d621e7e684857e195151">sendAck</a>();
<a name="l00361"></a>00361         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>);
<a name="l00362"></a>00362         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00363"></a>00363     }
<a name="l00364"></a>00364 
<a name="l00365"></a>00365     <span class="comment">//</span>
<a name="l00366"></a>00366     <span class="comment">// RFC 793: sixth, check the URG bit,</span>
<a name="l00367"></a>00367     <span class="comment">//</span>
<a name="l00368"></a>00368     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() &amp;&amp; (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3b4387f45a765235dfda0bf3111ba1c6">TCP_S_ESTABLISHED</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a> ||
<a name="l00369"></a>00369         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>))
<a name="l00370"></a>00370     {
<a name="l00371"></a>00371         <span class="comment">//&quot;</span>
<a name="l00372"></a>00372         <span class="comment">// If the URG bit is set, RCV.UP &lt;- max(RCV.UP,SEG.UP), and signal</span>
<a name="l00373"></a>00373         <span class="comment">// the user that the remote side has urgent data if the urgent</span>
<a name="l00374"></a>00374         <span class="comment">// pointer (RCV.UP) is in advance of the data consumed.  If the</span>
<a name="l00375"></a>00375         <span class="comment">// user has already been signaled (or is still in the &quot;urgent</span>
<a name="l00376"></a>00376         <span class="comment">// mode&quot;) for this continuous sequence of urgent data, do not</span>
<a name="l00377"></a>00377         <span class="comment">// signal the user again.</span>
<a name="l00378"></a>00378         <span class="comment">//&quot;</span>
<a name="l00379"></a>00379 
<a name="l00380"></a>00380         <span class="comment">// TBD: URG currently not supported</span>
<a name="l00381"></a>00381     }
<a name="l00382"></a>00382 
<a name="l00383"></a>00383     <span class="comment">//</span>
<a name="l00384"></a>00384     <span class="comment">// RFC 793: seventh, process the segment text,</span>
<a name="l00385"></a>00385     <span class="comment">//</span>
<a name="l00386"></a>00386     uint32 old_rcv_nxt = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>; <span class="comment">// if rcv_nxt changes, we need to send/schedule an ACK</span>
<a name="l00387"></a>00387     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3b4387f45a765235dfda0bf3111ba1c6">TCP_S_ESTABLISHED</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>)
<a name="l00388"></a>00388     {
<a name="l00389"></a>00389         <span class="comment">//&quot;</span>
<a name="l00390"></a>00390         <span class="comment">// Once in the ESTABLISHED state, it is possible to deliver segment</span>
<a name="l00391"></a>00391         <span class="comment">// text to user RECEIVE buffers.  Text from segments can be moved</span>
<a name="l00392"></a>00392         <span class="comment">// into buffers until either the buffer is full or the segment is</span>
<a name="l00393"></a>00393         <span class="comment">// empty.  If the segment empties and carries an PUSH flag, then</span>
<a name="l00394"></a>00394         <span class="comment">// the user is informed, when the buffer is returned, that a PUSH</span>
<a name="l00395"></a>00395         <span class="comment">// has been received.</span>
<a name="l00396"></a>00396         <span class="comment">//</span>
<a name="l00397"></a>00397         <span class="comment">// When the TCP takes responsibility for delivering the data to the</span>
<a name="l00398"></a>00398         <span class="comment">// user it must also acknowledge the receipt of the data.</span>
<a name="l00399"></a>00399         <span class="comment">//</span>
<a name="l00400"></a>00400         <span class="comment">// Once the TCP takes responsibility for the data it advances</span>
<a name="l00401"></a>00401         <span class="comment">// RCV.NXT over the data accepted, and adjusts RCV.WND as</span>
<a name="l00402"></a>00402         <span class="comment">// apporopriate to the current buffer availability.  The total of</span>
<a name="l00403"></a>00403         <span class="comment">// RCV.NXT and RCV.WND should not be reduced.</span>
<a name="l00404"></a>00404         <span class="comment">//</span>
<a name="l00405"></a>00405         <span class="comment">// Please note the window management suggestions in section 3.7.</span>
<a name="l00406"></a>00406         <span class="comment">//</span>
<a name="l00407"></a>00407         <span class="comment">// Send an acknowledgment of the form:</span>
<a name="l00408"></a>00408         <span class="comment">//</span>
<a name="l00409"></a>00409         <span class="comment">//   &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00410"></a>00410         <span class="comment">//</span>
<a name="l00411"></a>00411         <span class="comment">// This acknowledgment should be piggybacked on a segment being</span>
<a name="l00412"></a>00412         <span class="comment">// transmitted if possible without incurring undue delay.</span>
<a name="l00413"></a>00413         <span class="comment">//&quot;</span>
<a name="l00414"></a>00414         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00415"></a>00415         {
<a name="l00416"></a>00416             <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment text in a data transfer state\n&quot;</span>;
<a name="l00417"></a>00417 
<a name="l00418"></a>00418             <span class="comment">// insert into receive buffers. If this segment is contiguous with</span>
<a name="l00419"></a>00419             <span class="comment">// previously received ones (seqNo==rcv_nxt), rcv_nxt can be increased;</span>
<a name="l00420"></a>00420             <span class="comment">// otherwise it stays the same but the data must be cached nevertheless</span>
<a name="l00421"></a>00421             <span class="comment">// (to avoid &quot;Failure to retain above-sequence data&quot; problem, RFC 2525</span>
<a name="l00422"></a>00422             <span class="comment">// section 2.5).</span>
<a name="l00423"></a>00423             uint32 old_rcv_nxt = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>;
<a name="l00424"></a>00424             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#a28492372a4252f374ba62fbdcce7a566">insertBytesFromSegment</a>(tcpseg);
<a name="l00425"></a>00425 
<a name="l00426"></a>00426             <span class="comment">// out-of-order segment?</span>
<a name="l00427"></a>00427             <span class="keywordflow">if</span> (old_rcv_nxt==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>)
<a name="l00428"></a>00428             {
<a name="l00429"></a>00429                 <span class="comment">// we&apos;ll probably want to send an ACK here</span>
<a name="l00430"></a>00430                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a7ea3a177d38f6a05e84637233ae3b63d">receivedOutOfOrderSegment</a>();
<a name="l00431"></a>00431             }
<a name="l00432"></a>00432             <span class="keywordflow">else</span>
<a name="l00433"></a>00433             {
<a name="l00434"></a>00434                 <span class="comment">// forward data to app</span>
<a name="l00435"></a>00435                 <span class="comment">//</span>
<a name="l00436"></a>00436                 <span class="comment">// FIXME observe PSH bit</span>
<a name="l00437"></a>00437                 <span class="comment">//</span>
<a name="l00438"></a>00438                 <span class="comment">// FIXME we should implement socket READ command, and pass up only</span>
<a name="l00439"></a>00439                 <span class="comment">// as many bytes as requested. rcv_wnd should be decreased</span>
<a name="l00440"></a>00440                 <span class="comment">// accordingly! (right now we *always* advertise win=16384,</span>
<a name="l00441"></a>00441                 <span class="comment">// that is, there&apos;s practically no receiver-imposed flow control!)</span>
<a name="l00442"></a>00442                 <span class="comment">//</span>
<a name="l00443"></a>00443                 cPacket *msg;
<a name="l00444"></a>00444                 <span class="keywordflow">while</span> ((msg=<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#a8d5fa8d22c976a8be92512e11b350f9f">extractBytesUpTo</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>))!=NULL)
<a name="l00445"></a>00445                 {
<a name="l00446"></a>00446                     msg-&gt;setKind(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba78bce3d41e158816c5212ed2fc959b06">TCP_I_DATA</a>);  <span class="comment">// TBD currently we never send TCP_I_URGENT_DATA</span>
<a name="l00447"></a>00447                     <a class="code" href="class_t_c_p_command.html">TCPCommand</a> *cmd = <span class="keyword">new</span> <a class="code" href="class_t_c_p_command.html">TCPCommand</a>();
<a name="l00448"></a>00448                     cmd-&gt;<a class="code" href="class_t_c_p_command.html#a2688defdcadd3de43faae9c27748be24">setConnId</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae6ce2bfc0b9aa9d110db13efe08b7a0e">connId</a>);
<a name="l00449"></a>00449                     msg-&gt;setControlInfo(cmd);
<a name="l00450"></a>00450                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a6aa48826843116a0f5c4e0fa37a69cfc">sendToApp</a>(msg);
<a name="l00451"></a>00451                 }
<a name="l00452"></a>00452 
<a name="l00453"></a>00453                 <span class="comment">// if this segment &quot;filled the gap&quot; until the previously arrived segment</span>
<a name="l00454"></a>00454                 <span class="comment">// that carried a FIN (i.e.rcv_nxt==rcv_fin_seq), we have to advance</span>
<a name="l00455"></a>00455                 <span class="comment">// rcv_nxt over the FIN.</span>
<a name="l00456"></a>00456                 <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a595ba253f26cb674ecd990bfd6d929c1">fin_rcvd</a> &amp;&amp; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4e7a46f4ab93fc16930f38b65cc5ff07">rcv_fin_seq</a>)
<a name="l00457"></a>00457                 {
<a name="l00458"></a>00458                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;All segments arrived up to the FIN segment, advancing rcv_nxt over the FIN\n&quot;</span>;
<a name="l00459"></a>00459                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4e7a46f4ab93fc16930f38b65cc5ff07">rcv_fin_seq</a>+1;
<a name="l00460"></a>00460                     <span class="comment">// state transitions will be done in the state machine, here we just set</span>
<a name="l00461"></a>00461                     <span class="comment">// the proper event code (TCP_E_RCV_FIN or TCP_E_RCV_FIN_ACK)</span>
<a name="l00462"></a>00462                     <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a59323c4bb3247640d61362e7f6ba824e">TCP_E_RCV_FIN</a>;
<a name="l00463"></a>00463                     <span class="keywordflow">switch</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l00464"></a>00464                     {
<a name="l00465"></a>00465                         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a>:
<a name="l00466"></a>00466                             <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ad2deb1000d47f2e1524f1f5dee059b34">fin_ack_rcvd</a>)
<a name="l00467"></a>00467                             {
<a name="l00468"></a>00468                                 <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a2f4afa3cc8122b708143ae335b542179">TCP_E_RCV_FIN_ACK</a>;
<a name="l00469"></a>00469                                 <span class="comment">// start the time-wait timer, turn off the other timers</span>
<a name="l00470"></a>00470                                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2a3d3f1792941e08c490795d1d2a4bc0">finWait2Timer</a>);
<a name="l00471"></a>00471                                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473                                 <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00474"></a>00474                                 <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00475"></a>00475                                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00476"></a>00476                             }
<a name="l00477"></a>00477                             <span class="keywordflow">break</span>;
<a name="l00478"></a>00478                         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>:
<a name="l00479"></a>00479                             <span class="comment">// Start the time-wait timer, turn off the other timers.</span>
<a name="l00480"></a>00480                             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2a3d3f1792941e08c490795d1d2a4bc0">finWait2Timer</a>);
<a name="l00481"></a>00481                             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00482"></a>00482 
<a name="l00483"></a>00483                             <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00484"></a>00484                             <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00485"></a>00485                             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00486"></a>00486                             <span class="keywordflow">break</span>;
<a name="l00487"></a>00487                         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>:
<a name="l00488"></a>00488                             <span class="comment">// Restart the 2 MSL time-wait timeout.</span>
<a name="l00489"></a>00489                             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>);
<a name="l00490"></a>00490                             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00491"></a>00491                             <span class="keywordflow">break</span>;
<a name="l00492"></a>00492                     }
<a name="l00493"></a>00493                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba98ff9f82c08b1d7ae58049835c47368a">TCP_I_PEER_CLOSED</a>);
<a name="l00494"></a>00494                 }
<a name="l00495"></a>00495             }
<a name="l00496"></a>00496         }
<a name="l00497"></a>00497     }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499     <span class="comment">//</span>
<a name="l00500"></a>00500     <span class="comment">// RFC 793: eighth, check the FIN bit,</span>
<a name="l00501"></a>00501     <span class="comment">//</span>
<a name="l00502"></a>00502     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00503"></a>00503     {
<a name="l00504"></a>00504         <span class="comment">//&quot;</span>
<a name="l00505"></a>00505         <span class="comment">// If the FIN bit is set, signal the user &quot;connection closing&quot; and</span>
<a name="l00506"></a>00506         <span class="comment">// return any pending RECEIVEs with same message, advance RCV.NXT</span>
<a name="l00507"></a>00507         <span class="comment">// over the FIN, and send an acknowledgment for the FIN.  Note that</span>
<a name="l00508"></a>00508         <span class="comment">// FIN implies PUSH for any segment text not yet delivered to the</span>
<a name="l00509"></a>00509         <span class="comment">// user.</span>
<a name="l00510"></a>00510         <span class="comment">//&quot;</span>
<a name="l00511"></a>00511 
<a name="l00512"></a>00512         <span class="comment">// Note: seems like RFC 793 is not entirely correct here: if the</span>
<a name="l00513"></a>00513         <span class="comment">// segment is &quot;above sequence&quot; (ie. RCV.NXT &lt; SEG.SEQ), we cannot</span>
<a name="l00514"></a>00514         <span class="comment">// advance RCV.NXT over the FIN. Instead we remember this sequence</span>
<a name="l00515"></a>00515         <span class="comment">// number and do it later.</span>
<a name="l00516"></a>00516         uint32 fin_seq = (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() + (uint32)tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>();
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>==fin_seq)
<a name="l00518"></a>00518         {
<a name="l00519"></a>00519             <span class="comment">// advance rcv_nxt over FIN now</span>
<a name="l00520"></a>00520             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;FIN arrived, advancing rcv_nxt over the FIN\n&quot;</span>;
<a name="l00521"></a>00521             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>++;
<a name="l00522"></a>00522             <span class="comment">// state transitions will be done in the state machine, here we just set</span>
<a name="l00523"></a>00523             <span class="comment">// the proper event code (TCP_E_RCV_FIN or TCP_E_RCV_FIN_ACK)</span>
<a name="l00524"></a>00524             <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a59323c4bb3247640d61362e7f6ba824e">TCP_E_RCV_FIN</a>;
<a name="l00525"></a>00525             <span class="keywordflow">switch</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l00526"></a>00526             {
<a name="l00527"></a>00527                 <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa1366e9fbbf862cd3fdfa3ea08e641cb0">TCP_S_FIN_WAIT_1</a>:
<a name="l00528"></a>00528                     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ad2deb1000d47f2e1524f1f5dee059b34">fin_ack_rcvd</a>)
<a name="l00529"></a>00529                     {
<a name="l00530"></a>00530                         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a2f4afa3cc8122b708143ae335b542179">TCP_E_RCV_FIN_ACK</a>;
<a name="l00531"></a>00531                         <span class="comment">// start the time-wait timer, turn off the other timers</span>
<a name="l00532"></a>00532                         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2a3d3f1792941e08c490795d1d2a4bc0">finWait2Timer</a>);
<a name="l00533"></a>00533                         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00534"></a>00534 
<a name="l00535"></a>00535                         <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00536"></a>00536                         <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00537"></a>00537                         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00538"></a>00538                     }
<a name="l00539"></a>00539                     <span class="keywordflow">break</span>;
<a name="l00540"></a>00540                 <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>:
<a name="l00541"></a>00541                     <span class="comment">// Start the time-wait timer, turn off the other timers.</span>
<a name="l00542"></a>00542                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2a3d3f1792941e08c490795d1d2a4bc0">finWait2Timer</a>);
<a name="l00543"></a>00543                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545                     <span class="comment">// we&apos;re entering TIME_WAIT, so we can signal CLOSED the user</span>
<a name="l00546"></a>00546                     <span class="comment">// (the only thing left to do is wait until the 2MSL timer expires)</span>
<a name="l00547"></a>00547                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l00548"></a>00548                     <span class="keywordflow">break</span>;
<a name="l00549"></a>00549                 <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>:
<a name="l00550"></a>00550                     <span class="comment">// Restart the 2 MSL time-wait timeout.</span>
<a name="l00551"></a>00551                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>);
<a name="l00552"></a>00552                     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a67c3fa718ee0542b4bd93eda8785c0fc">the2MSLTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a25bdc88481176d96d87d31d71f32579b">TCP_TIMEOUT_2MSL</a>);
<a name="l00553"></a>00553                     <span class="keywordflow">break</span>;
<a name="l00554"></a>00554             }
<a name="l00555"></a>00555             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba98ff9f82c08b1d7ae58049835c47368a">TCP_I_PEER_CLOSED</a>);
<a name="l00556"></a>00556         }
<a name="l00557"></a>00557         <span class="keywordflow">else</span>
<a name="l00558"></a>00558         {
<a name="l00559"></a>00559             <span class="comment">// we&apos;ll have to do it later (when an arriving segment &quot;fills the gap&quot;)</span>
<a name="l00560"></a>00560             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;FIN segment above sequence, storing sequence number of FIN\n&quot;</span>;
<a name="l00561"></a>00561             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a595ba253f26cb674ecd990bfd6d929c1">fin_rcvd</a> = <span class="keyword">true</span>;
<a name="l00562"></a>00562             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4e7a46f4ab93fc16930f38b65cc5ff07">rcv_fin_seq</a> = fin_seq;
<a name="l00563"></a>00563         }
<a name="l00564"></a>00564 
<a name="l00565"></a>00565         <span class="comment">// TBD do PUSH stuff</span>
<a name="l00566"></a>00566     }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568     <span class="keywordflow">if</span> (old_rcv_nxt!=<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>)
<a name="l00569"></a>00569     {
<a name="l00570"></a>00570         <span class="comment">// if rcv_nxt changed, either because we received segment text or we</span>
<a name="l00571"></a>00571         <span class="comment">// received a FIN that needs to be acked (or both), we need to send or</span>
<a name="l00572"></a>00572         <span class="comment">// schedule an ACK.</span>
<a name="l00573"></a>00573 
<a name="l00574"></a>00574         <span class="comment">// tcpAlgorithm decides when and how to do ACKs</span>
<a name="l00575"></a>00575         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a3c59a57936e92218369a8702956df1c7">receiveSeqChanged</a>();
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577 
<a name="l00578"></a>00578     <span class="keywordflow">if</span> ((<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3b4387f45a765235dfda0bf3111ba1c6">TCP_S_ESTABLISHED</a> || <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a>) &amp;&amp;
<a name="l00579"></a>00579         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a2a8d544b5707071afcc5402e6318e245">send_fin</a> &amp;&amp; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a1156c4cdd71d0e83c9bb401a68e9f606">snd_fin_seq</a>+1)
<a name="l00580"></a>00580     {
<a name="l00581"></a>00581         <span class="comment">// if the user issued the CLOSE command a long time ago and we&apos;ve just</span>
<a name="l00582"></a>00582         <span class="comment">// managed to send off FIN, we simulate a CLOSE command now (we had to</span>
<a name="l00583"></a>00583         <span class="comment">// defer it at that time because we still had data in the send queue.)</span>
<a name="l00584"></a>00584         <span class="comment">// This CLOSE will take us into the FIN_WAIT_1 state.</span>
<a name="l00585"></a>00585         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Now we can do the CLOSE which was deferred a while ago\n&quot;</span>;
<a name="l00586"></a>00586         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a2c5c582787e0b87a4a913e34c4d20d1b">TCP_E_CLOSE</a>;
<a name="l00587"></a>00587     }
<a name="l00588"></a>00588 
<a name="l00589"></a>00589     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()==<a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa3395b6fd6b4cf5d6165b37929d44eaa1">TCP_S_CLOSE_WAIT</a> &amp;&amp; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a2a8d544b5707071afcc5402e6318e245">send_fin</a> &amp;&amp;
<a name="l00590"></a>00590         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a1156c4cdd71d0e83c9bb401a68e9f606">snd_fin_seq</a>+1 &amp;&amp; old_snd_nxt!=<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>)
<a name="l00591"></a>00591     {
<a name="l00592"></a>00592         <span class="comment">// if we&apos;re in CLOSE_WAIT and we just got to sent our long-pending FIN,</span>
<a name="l00593"></a>00593         <span class="comment">// we simulate a CLOSE command now (we had to defer it at that time because</span>
<a name="l00594"></a>00594         <span class="comment">// we still had data in the send queue.) This CLOSE will take us into the</span>
<a name="l00595"></a>00595         <span class="comment">// LAST_ACK state.</span>
<a name="l00596"></a>00596         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Now we can do the CLOSE which was deferred a while ago\n&quot;</span>;
<a name="l00597"></a>00597         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a2c5c582787e0b87a4a913e34c4d20d1b">TCP_E_CLOSE</a>;
<a name="l00598"></a>00598     }
<a name="l00599"></a>00599 
<a name="l00600"></a>00600     <span class="keywordflow">return</span> event;
<a name="l00601"></a>00601 }
<a name="l00602"></a>00602 
<a name="l00603"></a>00603 <span class="comment">//----</span>
<a name="l00604"></a>00604 
<a name="l00605"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">00605</a> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d034577df86997140d627feeda66a1f">TCPConnection::processSegmentInListen</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment in LISTEN\n&quot;</span>;
<a name="l00608"></a>00608 
<a name="l00609"></a>00609     <span class="comment">//&quot;</span>
<a name="l00610"></a>00610     <span class="comment">// first check for an RST</span>
<a name="l00611"></a>00611     <span class="comment">//   An incoming RST should be ignored.  Return.</span>
<a name="l00612"></a>00612     <span class="comment">//&quot;</span>
<a name="l00613"></a>00613     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00614"></a>00614     {
<a name="l00615"></a>00615         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST bit set: dropping segment\n&quot;</span>;
<a name="l00616"></a>00616         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00617"></a>00617     }
<a name="l00618"></a>00618 
<a name="l00619"></a>00619     <span class="comment">//&quot;</span>
<a name="l00620"></a>00620     <span class="comment">// second check for an ACK</span>
<a name="l00621"></a>00621     <span class="comment">//    Any acknowledgment is bad if it arrives on a connection still in</span>
<a name="l00622"></a>00622     <span class="comment">//    the LISTEN state.  An acceptable reset segment should be formed</span>
<a name="l00623"></a>00623     <span class="comment">//    for any arriving ACK-bearing segment.  The RST should be</span>
<a name="l00624"></a>00624     <span class="comment">//    formatted as follows:</span>
<a name="l00625"></a>00625     <span class="comment">//</span>
<a name="l00626"></a>00626     <span class="comment">//      &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00627"></a>00627     <span class="comment">//</span>
<a name="l00628"></a>00628     <span class="comment">//    Return.</span>
<a name="l00629"></a>00629     <span class="comment">//&quot;</span>
<a name="l00630"></a>00630     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00631"></a>00631     {
<a name="l00632"></a>00632         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set: dropping segment and sending RST\n&quot;</span>;
<a name="l00633"></a>00633         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00634"></a>00634         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00635"></a>00635     }
<a name="l00636"></a>00636 
<a name="l00637"></a>00637     <span class="comment">//&quot;</span>
<a name="l00638"></a>00638     <span class="comment">// third check for a SYN</span>
<a name="l00639"></a>00639     <span class="comment">//&quot;</span>
<a name="l00640"></a>00640     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00641"></a>00641     {
<a name="l00642"></a>00642         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00643"></a>00643         {
<a name="l00644"></a>00644             <span class="comment">// Looks like implementations vary on how to react to SYN+FIN.</span>
<a name="l00645"></a>00645             <span class="comment">// Some treat it as plain SYN (and reply with SYN+ACK), some send RST+ACK.</span>
<a name="l00646"></a>00646             <span class="comment">// Let&apos;s just do the former here.</span>
<a name="l00647"></a>00647             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00648"></a>00648         }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN bit set: filling in foreign socket and sending SYN+ACK\n&quot;</span>;
<a name="l00651"></a>00651 
<a name="l00652"></a>00652         <span class="comment">//&quot;</span>
<a name="l00653"></a>00653         <span class="comment">// If the listen was not fully specified (i.e., the foreign socket was not</span>
<a name="l00654"></a>00654         <span class="comment">// fully specified), then the unspecified fields should be filled in now.</span>
<a name="l00655"></a>00655         <span class="comment">//&quot;</span>
<a name="l00656"></a>00656         <span class="comment">//</span>
<a name="l00657"></a>00657         <span class="comment">// Also, we may need to fork, in order to leave another connection</span>
<a name="l00658"></a>00658         <span class="comment">// LISTENing on the port. Note: forking will change our connId.</span>
<a name="l00659"></a>00659         <span class="comment">//</span>
<a name="l00660"></a>00660         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4f418e2320cca13bdf3a673ae74989ac">fork</a>)
<a name="l00661"></a>00661         {
<a name="l00662"></a>00662             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html">TCPConnection</a> *conn = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a1d5624dcbc77e79d142f6a886b3e788d">cloneListeningConnection</a>(); <span class="comment">// this will stay LISTENing</span>
<a name="l00663"></a>00663             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a6f9eb8f2af118d2f1fcd90df3c87249e">tcpMain</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p.html#abec1cedad1e72a349f7bd804501584fa">addForkedConnection</a>(<span class="keyword">this</span>, conn, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00664"></a>00664             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Connection forked: this connection got new connId=&quot;</span> &lt;&lt; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae6ce2bfc0b9aa9d110db13efe08b7a0e">connId</a> &lt;&lt; <span class="stringliteral">&quot;, &quot;</span>
<a name="l00665"></a>00665                      <span class="stringliteral">&quot;spinoff keeps LISTENing with connId=&quot;</span> &lt;&lt; conn-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae6ce2bfc0b9aa9d110db13efe08b7a0e">connId</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l00666"></a>00666         }
<a name="l00667"></a>00667         <span class="keywordflow">else</span>
<a name="l00668"></a>00668         {
<a name="l00669"></a>00669             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a6f9eb8f2af118d2f1fcd90df3c87249e">tcpMain</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p.html#a89cade3eb3a3f44ffae57c08dedd9285">updateSockPair</a>(<span class="keyword">this</span>, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00670"></a>00670         }
<a name="l00671"></a>00671 
<a name="l00672"></a>00672         <span class="comment">//&quot;</span>
<a name="l00673"></a>00673         <span class="comment">//  Set RCV.NXT to SEG.SEQ+1, IRS is set to SEG.SEQ and any other</span>
<a name="l00674"></a>00674         <span class="comment">//  control or text should be queued for processing later.  ISS</span>
<a name="l00675"></a>00675         <span class="comment">//  should be selected and a SYN segment sent of the form:</span>
<a name="l00676"></a>00676         <span class="comment">//</span>
<a name="l00677"></a>00677         <span class="comment">//    &lt;SEQ=ISS&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=SYN,ACK&gt;</span>
<a name="l00678"></a>00678         <span class="comment">//</span>
<a name="l00679"></a>00679         <span class="comment">//  SND.NXT is set to ISS+1 and SND.UNA to ISS.  The connection</span>
<a name="l00680"></a>00680         <span class="comment">//  state should be changed to SYN-RECEIVED.</span>
<a name="l00681"></a>00681         <span class="comment">//&quot;</span>
<a name="l00682"></a>00682         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()+1;
<a name="l00683"></a>00683         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#af9fc103c0361bcaffc4c894627abfc2d">irs</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00684"></a>00684         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#aeec7fc4688fecfdd84653b748ff1c21e">init</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>);   <span class="comment">// FIXME may init twice...</span>
<a name="l00685"></a>00685         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a585bbcdd70565eb01b6bfe17a1487c78">selectInitialSeqNum</a>();
<a name="l00686"></a>00686 
<a name="l00687"></a>00687         <span class="comment">// although not mentioned in RFC 793, seems like we have to pick up</span>
<a name="l00688"></a>00688         <span class="comment">// initial snd_wnd from the segment here.</span>
<a name="l00689"></a>00689         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8ef1b3d7dceadd931a331c121e55c556">getWindow</a>();
<a name="l00690"></a>00690         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4ddf055ba61bab9723814bfb1f55cfe5">snd_wl1</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00691"></a>00691         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#aae32069f7798da55852c7244d816b9a1">snd_wl2</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74b7f93c1777b2428f37a7b8d2d8a5a4">iss</a>;
<a name="l00692"></a>00692         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>-&gt;record(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a>);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>();
<a name="l00695"></a>00695         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">startSynRexmitTimer</a>();
<a name="l00696"></a>00696         <span class="keywordflow">if</span> (!<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a757386355261e95064b75f2dfec3788e">connEstabTimer</a>-&gt;isScheduled())
<a name="l00697"></a>00697             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a757386355261e95064b75f2dfec3788e">connEstabTimer</a>, <a class="code" href="_t_c_p_connection_8h.html#a512458671be6d68703cc89178b0b35f0">TCP_TIMEOUT_CONN_ESTAB</a>);
<a name="l00698"></a>00698 
<a name="l00699"></a>00699         <span class="comment">//&quot;</span>
<a name="l00700"></a>00700         <span class="comment">// Note that any other incoming control or data (combined with SYN)</span>
<a name="l00701"></a>00701         <span class="comment">// will be processed in the SYN-RECEIVED state, but processing of SYN</span>
<a name="l00702"></a>00702         <span class="comment">// and ACK should not be repeated.</span>
<a name="l00703"></a>00703         <span class="comment">//&quot;</span>
<a name="l00704"></a>00704         <span class="comment">// We don&apos;t send text in SYN or SYN+ACK, but accept it. Otherwise</span>
<a name="l00705"></a>00705         <span class="comment">// there isn&apos;t much left to do: RST, SYN, ACK, FIN got processed already,</span>
<a name="l00706"></a>00706         <span class="comment">// so there&apos;s only URG and PSH left to handle.</span>
<a name="l00707"></a>00707         <span class="comment">//</span>
<a name="l00708"></a>00708         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00709"></a>00709             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#a28492372a4252f374ba62fbdcce7a566">insertBytesFromSegment</a>(tcpseg);
<a name="l00710"></a>00710         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l00711"></a>00711             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l00712"></a>00712 
<a name="l00713"></a>00713         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a6769520e2e41d511462d3608d18326ed">TCP_E_RCV_SYN</a>;  <span class="comment">// this will take us to SYN_RCVD</span>
<a name="l00714"></a>00714     }
<a name="l00715"></a>00715 
<a name="l00716"></a>00716     <span class="comment">//&quot;</span>
<a name="l00717"></a>00717     <span class="comment">//  fourth other text or control</span>
<a name="l00718"></a>00718     <span class="comment">//   So you are unlikely to get here, but if you do, drop the segment, and return.</span>
<a name="l00719"></a>00719     <span class="comment">//&quot;</span>
<a name="l00720"></a>00720     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Unexpected segment: dropping it\n&quot;</span>;
<a name="l00721"></a>00721     <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00722"></a>00722 }
<a name="l00723"></a>00723 
<a name="l00724"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">00724</a> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a12b903f9e148f5c26f926dcdc8107c86">TCPConnection::processSegmentInSynSent</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> srcAddr, <a class="code" href="class_i_pv_x_address.html">IPvXAddress</a> destAddr)
<a name="l00725"></a>00725 {
<a name="l00726"></a>00726     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing segment in SYN_SENT\n&quot;</span>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728     <span class="comment">//&quot;</span>
<a name="l00729"></a>00729     <span class="comment">// first check the ACK bit</span>
<a name="l00730"></a>00730     <span class="comment">//</span>
<a name="l00731"></a>00731     <span class="comment">//   If the ACK bit is set</span>
<a name="l00732"></a>00732     <span class="comment">//</span>
<a name="l00733"></a>00733     <span class="comment">//     If SEG.ACK =&lt; ISS, or SEG.ACK &gt; SND.NXT, send a reset (unless</span>
<a name="l00734"></a>00734     <span class="comment">//     the RST bit is set, if so drop the segment and return)</span>
<a name="l00735"></a>00735     <span class="comment">//</span>
<a name="l00736"></a>00736     <span class="comment">//       &lt;SEQ=SEG.ACK&gt;&lt;CTL=RST&gt;</span>
<a name="l00737"></a>00737     <span class="comment">//</span>
<a name="l00738"></a>00738     <span class="comment">//     and discard the segment.  Return.</span>
<a name="l00739"></a>00739     <span class="comment">//</span>
<a name="l00740"></a>00740     <span class="comment">//     If SND.UNA =&lt; SEG.ACK =&lt; SND.NXT then the ACK is acceptable.</span>
<a name="l00741"></a>00741     <span class="comment">//&quot;</span>
<a name="l00742"></a>00742     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00743"></a>00743     {
<a name="l00744"></a>00744         <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a2a4d76c437a6e0eb1e1440c02153e5db">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74b7f93c1777b2428f37a7b8d2d8a5a4">iss</a>) || <a class="code" href="namespacetcp__old.html#a91800c1929091c104e787a01f5955a9f">seqGreater</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>))
<a name="l00745"></a>00745         {
<a name="l00746"></a>00746             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set but wrong AckNo, sending RST\n&quot;</span>;
<a name="l00747"></a>00747             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#afa03f88fc4589249aefe6f828eed9dd6">sendRst</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(),destAddr,srcAddr,tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(),tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00748"></a>00748             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00749"></a>00749         }
<a name="l00750"></a>00750         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK bit set, AckNo acceptable\n&quot;</span>;
<a name="l00751"></a>00751     }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753     <span class="comment">//&quot;</span>
<a name="l00754"></a>00754     <span class="comment">// second check the RST bit</span>
<a name="l00755"></a>00755     <span class="comment">//</span>
<a name="l00756"></a>00756     <span class="comment">//   If the RST bit is set</span>
<a name="l00757"></a>00757     <span class="comment">//</span>
<a name="l00758"></a>00758     <span class="comment">//     If the ACK was acceptable then signal the user &quot;error:</span>
<a name="l00759"></a>00759     <span class="comment">//     connection reset&quot;, drop the segment, enter CLOSED state,</span>
<a name="l00760"></a>00760     <span class="comment">//     delete TCB, and return.  Otherwise (no ACK) drop the segment</span>
<a name="l00761"></a>00761     <span class="comment">//     and return.</span>
<a name="l00762"></a>00762     <span class="comment">//&quot;</span>
<a name="l00763"></a>00763     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a606da99a84d95c74bb1626436b6e5e12">getRstBit</a>())
<a name="l00764"></a>00764     {
<a name="l00765"></a>00765         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00766"></a>00766         {
<a name="l00767"></a>00767             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST+ACK: performing connection reset\n&quot;</span>;
<a name="l00768"></a>00768             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba4e8f4551a34a27e607201754b36fdbe0">TCP_I_CONNECTION_RESET</a>);
<a name="l00769"></a>00769             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a050c79add513afca8554e29b61fd5389">TCP_E_RCV_RST</a>;
<a name="l00770"></a>00770         }
<a name="l00771"></a>00771         <span class="keywordflow">else</span>
<a name="l00772"></a>00772         {
<a name="l00773"></a>00773             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;RST without ACK: dropping segment\n&quot;</span>;
<a name="l00774"></a>00774             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00775"></a>00775         }
<a name="l00776"></a>00776     }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778     <span class="comment">//&quot;</span>
<a name="l00779"></a>00779     <span class="comment">// third check the security and precedence -- not done</span>
<a name="l00780"></a>00780     <span class="comment">//</span>
<a name="l00781"></a>00781     <span class="comment">// fourth check the SYN bit</span>
<a name="l00782"></a>00782     <span class="comment">//</span>
<a name="l00783"></a>00783     <span class="comment">//   This step should be reached only if the ACK is ok, or there is</span>
<a name="l00784"></a>00784     <span class="comment">//   no ACK, and it the segment did not contain a RST.</span>
<a name="l00785"></a>00785     <span class="comment">//</span>
<a name="l00786"></a>00786     <span class="comment">//   If the SYN bit is on and the security/compartment and precedence</span>
<a name="l00787"></a>00787     <span class="comment">//   are acceptable then,</span>
<a name="l00788"></a>00788     <span class="comment">//&quot;</span>
<a name="l00789"></a>00789     <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#affebf261c9d4fc303151a484d61d8bb7">getSynBit</a>())
<a name="l00790"></a>00790     {
<a name="l00791"></a>00791         <span class="comment">//</span>
<a name="l00792"></a>00792         <span class="comment">//   RCV.NXT is set to SEG.SEQ+1, IRS is set to</span>
<a name="l00793"></a>00793         <span class="comment">//   SEG.SEQ.  SND.UNA should be advanced to equal SEG.ACK (if there</span>
<a name="l00794"></a>00794         <span class="comment">//   is an ACK), and any segments on the retransmission queue which</span>
<a name="l00795"></a>00795         <span class="comment">//   are thereby acknowledged should be removed.</span>
<a name="l00796"></a>00796         <span class="comment">//</span>
<a name="l00797"></a>00797         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()+1;
<a name="l00798"></a>00798         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#af9fc103c0361bcaffc4c894627abfc2d">irs</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00799"></a>00799         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#aeec7fc4688fecfdd84653b748ff1c21e">init</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a>);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8415708f568387985da223286a9e5bfa">getAckBit</a>())
<a name="l00802"></a>00802         {
<a name="l00803"></a>00803             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l00804"></a>00804             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7bd9b6b2b4422771b92e00d307983d19">sendQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_send_queue.html#aced2fde7fde0ec8f6a32b1e16d6bbda9">discardUpTo</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>);
<a name="l00805"></a>00805 
<a name="l00806"></a>00806             <span class="comment">// although not mentioned in RFC 793, seems like we have to pick up</span>
<a name="l00807"></a>00807             <span class="comment">// initial snd_wnd from the segment here.</span>
<a name="l00808"></a>00808             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8ef1b3d7dceadd931a331c121e55c556">getWindow</a>();
<a name="l00809"></a>00809             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4ddf055ba61bab9723814bfb1f55cfe5">snd_wl1</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l00810"></a>00810             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#aae32069f7798da55852c7244d816b9a1">snd_wl2</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l00811"></a>00811             <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>-&gt;record(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a>);
<a name="l00812"></a>00812         }
<a name="l00813"></a>00813 
<a name="l00814"></a>00814         <span class="comment">// this also seems to be a good time to learn our local IP address</span>
<a name="l00815"></a>00815         <span class="comment">// (was probably unspecified at connection open)</span>
<a name="l00816"></a>00816         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a6f9eb8f2af118d2f1fcd90df3c87249e">tcpMain</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p.html#a89cade3eb3a3f44ffae57c08dedd9285">updateSockPair</a>(<span class="keyword">this</span>, destAddr, srcAddr, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a9120715e275fdb4745fa15b300236d9a">getDestPort</a>(), tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aca825ab6ff9fc98f52315c36254a66be">getSrcPort</a>());
<a name="l00817"></a>00817 
<a name="l00818"></a>00818         <span class="comment">//&quot;</span>
<a name="l00819"></a>00819         <span class="comment">//   If SND.UNA &gt; ISS (our SYN has been ACKed), change the connection</span>
<a name="l00820"></a>00820         <span class="comment">//   state to ESTABLISHED, form an ACK segment</span>
<a name="l00821"></a>00821         <span class="comment">//</span>
<a name="l00822"></a>00822         <span class="comment">//     &lt;SEQ=SND.NXT&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=ACK&gt;</span>
<a name="l00823"></a>00823         <span class="comment">//</span>
<a name="l00824"></a>00824         <span class="comment">//   and send it.  Data or controls which were queued for</span>
<a name="l00825"></a>00825         <span class="comment">//   transmission may be included.  If there are other controls or</span>
<a name="l00826"></a>00826         <span class="comment">//   text in the segment then continue processing at the sixth step</span>
<a name="l00827"></a>00827         <span class="comment">//   below where the URG bit is checked, otherwise return.</span>
<a name="l00828"></a>00828         <span class="comment">//&quot;</span>
<a name="l00829"></a>00829         <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a91800c1929091c104e787a01f5955a9f">seqGreater</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74b7f93c1777b2428f37a7b8d2d8a5a4">iss</a>))
<a name="l00830"></a>00830         {
<a name="l00831"></a>00831             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+ACK bits set, connection established.\n&quot;</span>;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833             <span class="comment">// RFC says &quot;continue processing at the sixth step below where</span>
<a name="l00834"></a>00834             <span class="comment">// the URG bit is checked&quot;. Those steps deal with: URG, segment text</span>
<a name="l00835"></a>00835             <span class="comment">// (and PSH), and FIN.</span>
<a name="l00836"></a>00836             <span class="comment">// Now: URG and PSH we don&apos;t support yet; in SYN+FIN we ignore FIN;</span>
<a name="l00837"></a>00837             <span class="comment">// with segment text we just take it easy and put it in the receiveQueue</span>
<a name="l00838"></a>00838             <span class="comment">// -- we&apos;ll forward it to the user when more data arrives.</span>
<a name="l00839"></a>00839             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00840"></a>00840                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+ACK+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00841"></a>00841             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00842"></a>00842                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a18b8a2c7e52c332378bd9f70b1d91b29">rcv_nxt</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#a28492372a4252f374ba62fbdcce7a566">insertBytesFromSegment</a>(tcpseg); <span class="comment">// TBD forward to app, etc.</span>
<a name="l00843"></a>00843             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l00844"></a>00844                 <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN+ACK\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l00845"></a>00845 
<a name="l00846"></a>00846             <span class="comment">// notify tcpAlgorithm (it has to send ACK of SYN) and app layer</span>
<a name="l00847"></a>00847             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a6bbeaec803a6c9e148ba36c838c267a5">established</a>(<span class="keyword">true</span>);
<a name="l00848"></a>00848             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab04a91abde05d21293c30a78ab968eef">sendEstabIndicationToApp</a>();
<a name="l00849"></a>00849 
<a name="l00850"></a>00850             <span class="comment">// This will trigger transition to ESTABLISHED. Timers and notifying</span>
<a name="l00851"></a>00851             <span class="comment">// app will be taken care of in stateEntered().</span>
<a name="l00852"></a>00852             <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a3239eea5ba6edf6850289914cfac51c8">TCP_E_RCV_SYN_ACK</a>;
<a name="l00853"></a>00853         }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855         <span class="comment">//&quot;</span>
<a name="l00856"></a>00856         <span class="comment">//   Otherwise enter SYN-RECEIVED, form a SYN,ACK segment</span>
<a name="l00857"></a>00857         <span class="comment">//</span>
<a name="l00858"></a>00858         <span class="comment">//     &lt;SEQ=ISS&gt;&lt;ACK=RCV.NXT&gt;&lt;CTL=SYN,ACK&gt;</span>
<a name="l00859"></a>00859         <span class="comment">//</span>
<a name="l00860"></a>00860         <span class="comment">//   and send it.  If there are other controls or text in the</span>
<a name="l00861"></a>00861         <span class="comment">//   segment, queue them for processing after the ESTABLISHED state</span>
<a name="l00862"></a>00862         <span class="comment">//   has been reached, return.</span>
<a name="l00863"></a>00863         <span class="comment">//&quot;</span>
<a name="l00864"></a>00864         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN bit set: sending SYN+ACK\n&quot;</span>;
<a name="l00865"></a>00865         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74b7f93c1777b2428f37a7b8d2d8a5a4">iss</a>;
<a name="l00866"></a>00866         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>();
<a name="l00867"></a>00867         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">startSynRexmitTimer</a>();
<a name="l00868"></a>00868 
<a name="l00869"></a>00869         <span class="comment">// Note: code below is similar to processing SYN in LISTEN.</span>
<a name="l00870"></a>00870 
<a name="l00871"></a>00871         <span class="comment">// For consistency with that code, we ignore SYN+FIN here</span>
<a name="l00872"></a>00872         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#aa7615b353254cbd11ea14f03e80c55f6">getFinBit</a>())
<a name="l00873"></a>00873             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;SYN+FIN received: ignoring FIN\n&quot;</span>;
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         <span class="comment">// We don&apos;t send text in SYN or SYN+ACK, but accept it. Otherwise</span>
<a name="l00876"></a>00876         <span class="comment">// there isn&apos;t much left to do: RST, SYN, ACK, FIN got processed already,</span>
<a name="l00877"></a>00877         <span class="comment">// so there&apos;s only URG and PSH left to handle.</span>
<a name="l00878"></a>00878         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()&gt;0)
<a name="l00879"></a>00879             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2602ec64d45270793076abe5938d16ac">receiveQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_receive_queue.html#a28492372a4252f374ba62fbdcce7a566">insertBytesFromSegment</a>(tcpseg);
<a name="l00880"></a>00880         <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a31028187ac8cf1f844d389b0e56baf8b">getUrgBit</a>() || tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a951517b397bea146bb642976521469d7">getPshBit</a>())
<a name="l00881"></a>00881             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Ignoring URG and PSH bits in SYN\n&quot;</span>; <span class="comment">// TBD</span>
<a name="l00882"></a>00882         <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a6769520e2e41d511462d3608d18326ed">TCP_E_RCV_SYN</a>;
<a name="l00883"></a>00883     }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885     <span class="comment">//&quot;</span>
<a name="l00886"></a>00886     <span class="comment">// fifth, if neither of the SYN or RST bits is set then drop the</span>
<a name="l00887"></a>00887     <span class="comment">// segment and return.</span>
<a name="l00888"></a>00888     <span class="comment">//&quot;</span>
<a name="l00889"></a>00889     <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32acd405552b4f4c9973d5d5b7e8aae88f5">TCP_E_IGNORE</a>;
<a name="l00890"></a>00890 }
<a name="l00891"></a>00891 
<a name="l00892"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">00892</a> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a4d240ca8f36aa37a29b8bcc44ec052cd">TCPConnection::processRstInSynReceived</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing RST in SYN_RCVD\n&quot;</span>;
<a name="l00895"></a>00895 
<a name="l00896"></a>00896     <span class="comment">//&quot;</span>
<a name="l00897"></a>00897     <span class="comment">// If this connection was initiated with a passive OPEN (i.e.,</span>
<a name="l00898"></a>00898     <span class="comment">// came from the LISTEN state), then return this connection to</span>
<a name="l00899"></a>00899     <span class="comment">// LISTEN state and return.  The user need not be informed.  If</span>
<a name="l00900"></a>00900     <span class="comment">// this connection was initiated with an active OPEN (i.e., came</span>
<a name="l00901"></a>00901     <span class="comment">// from SYN-SENT state) then the connection was refused, signal</span>
<a name="l00902"></a>00902     <span class="comment">// the user &quot;connection refused&quot;.  In either case, all segments</span>
<a name="l00903"></a>00903     <span class="comment">// on the retransmission queue should be removed.  And in the</span>
<a name="l00904"></a>00904     <span class="comment">// active OPEN case, enter the CLOSED state and delete the TCB,</span>
<a name="l00905"></a>00905     <span class="comment">// and return.</span>
<a name="l00906"></a>00906     <span class="comment">//&quot;</span>
<a name="l00907"></a>00907 
<a name="l00908"></a>00908     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7bd9b6b2b4422771b92e00d307983d19">sendQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_send_queue.html#aced2fde7fde0ec8f6a32b1e16d6bbda9">discardUpTo</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7bd9b6b2b4422771b92e00d307983d19">sendQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_send_queue.html#addf53d15d095b683486ca61554dccae3">getBufferEndSeq</a>()); <span class="comment">// flush send queue</span>
<a name="l00909"></a>00909 
<a name="l00910"></a>00910     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#afba4a9f34c546c37533eb5311c1da682">active</a>)
<a name="l00911"></a>00911     {
<a name="l00912"></a>00912         <span class="comment">// signal &quot;connection refused&quot;</span>
<a name="l00913"></a>00913         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba21824d5a95e3b86c41f35775bb5f23ab">TCP_I_CONNECTION_REFUSED</a>);
<a name="l00914"></a>00914     }
<a name="l00915"></a>00915 
<a name="l00916"></a>00916     <span class="comment">// on RCV_RST, FSM will go either to LISTEN or to CLOSED, depending on state-&gt;active</span>
<a name="l00917"></a>00917     <span class="keywordflow">return</span> <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a050c79add513afca8554e29b61fd5389">TCP_E_RCV_RST</a>;
<a name="l00918"></a>00918 }
<a name="l00919"></a>00919 
<a name="l00920"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">00920</a> <span class="keywordtype">bool</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ac1144f5ca6e960176d6e623998cb7456">TCPConnection::processAckInEstabEtc</a>(<a class="code" href="class_t_c_p_segment.html">TCPSegment</a> *tcpseg)
<a name="l00921"></a>00921 {
<a name="l00922"></a>00922     <a class="code" href="_t_c_p_8h.html#a5eb334f5e4b6d6bb414d16141aca18af">tcpEV2</a> &lt;&lt; <span class="stringliteral">&quot;Processing ACK in a data transfer state\n&quot;</span>;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924     <span class="comment">//</span>
<a name="l00925"></a>00925     <span class="comment">//&quot;</span>
<a name="l00926"></a>00926     <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT then, set SND.UNA &lt;- SEG.ACK.</span>
<a name="l00927"></a>00927     <span class="comment">//  Any segments on the retransmission queue which are thereby</span>
<a name="l00928"></a>00928     <span class="comment">//  entirely acknowledged are removed.  Users should receive</span>
<a name="l00929"></a>00929     <span class="comment">//  positive acknowledgments for buffers which have been SENT and</span>
<a name="l00930"></a>00930     <span class="comment">//  fully acknowledged (i.e., SEND buffer should be returned with</span>
<a name="l00931"></a>00931     <span class="comment">//  &quot;ok&quot; response).  If the ACK is a duplicate</span>
<a name="l00932"></a>00932     <span class="comment">//  (SEG.ACK &lt; SND.UNA), it can be ignored.  If the ACK acks</span>
<a name="l00933"></a>00933     <span class="comment">//  something not yet sent (SEG.ACK &gt; SND.NXT) then send an ACK,</span>
<a name="l00934"></a>00934     <span class="comment">//  drop the segment, and return.</span>
<a name="l00935"></a>00935     <span class="comment">//</span>
<a name="l00936"></a>00936     <span class="comment">//  If SND.UNA &lt; SEG.ACK =&lt; SND.NXT, the send window should be</span>
<a name="l00937"></a>00937     <span class="comment">//  updated.  If (SND.WL1 &lt; SEG.SEQ or (SND.WL1 = SEG.SEQ and</span>
<a name="l00938"></a>00938     <span class="comment">//  SND.WL2 =&lt; SEG.ACK)), set SND.WND &lt;- SEG.WND, set</span>
<a name="l00939"></a>00939     <span class="comment">//  SND.WL1 &lt;- SEG.SEQ, and set SND.WL2 &lt;- SEG.ACK.</span>
<a name="l00940"></a>00940     <span class="comment">//</span>
<a name="l00941"></a>00941     <span class="comment">//  Note that SND.WND is an offset from SND.UNA, that SND.WL1</span>
<a name="l00942"></a>00942     <span class="comment">//  records the sequence number of the last segment used to update</span>
<a name="l00943"></a>00943     <span class="comment">//  SND.WND, and that SND.WL2 records the acknowledgment number of</span>
<a name="l00944"></a>00944     <span class="comment">//  the last segment used to update SND.WND.  The check here</span>
<a name="l00945"></a>00945     <span class="comment">//  prevents using old segments to update the window.</span>
<a name="l00946"></a>00946     <span class="comment">//&quot;</span>
<a name="l00947"></a>00947     <span class="comment">// Note: should use SND.MAX instead of SND.NXT in above checks</span>
<a name="l00948"></a>00948     <span class="comment">//</span>
<a name="l00949"></a>00949     <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a0012c6f2a0631480574729efd85a05c9">seqGE</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()))
<a name="l00950"></a>00950     {
<a name="l00951"></a>00951         <span class="comment">//</span>
<a name="l00952"></a>00952         <span class="comment">// duplicate ACK? A received TCP segment is a duplicate ACK if all of</span>
<a name="l00953"></a>00953         <span class="comment">// the following apply:</span>
<a name="l00954"></a>00954         <span class="comment">//    (1) snd_una==ackNo</span>
<a name="l00955"></a>00955         <span class="comment">//    (2) segment contains no data</span>
<a name="l00956"></a>00956         <span class="comment">//    (3) there&apos;s unacked data (snd_una!=snd_max)</span>
<a name="l00957"></a>00957         <span class="comment">//</span>
<a name="l00958"></a>00958         <span class="comment">// Note: ssfnet uses additional constraint &quot;window is the same as last</span>
<a name="l00959"></a>00959         <span class="comment">// received (not an update)&quot; -- we don&apos;t do that because window updates</span>
<a name="l00960"></a>00960         <span class="comment">// are ignored anyway if neither seqNo nor ackNo has changed.</span>
<a name="l00961"></a>00961         <span class="comment">//</span>
<a name="l00962"></a>00962         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>==tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>() &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()==0 &amp;&amp;
<a name="l00963"></a>00963             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>!=<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a>)
<a name="l00964"></a>00964         {
<a name="l00965"></a>00965             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74cb98612a9fa541a2682e33f3991582">dupacks</a>++;
<a name="l00966"></a>00966             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a7ea85ca6cca058d942c83cb76eb3109a">receivedDuplicateAck</a>();
<a name="l00967"></a>00967         }
<a name="l00968"></a>00968         <span class="keywordflow">else</span>
<a name="l00969"></a>00969         {
<a name="l00970"></a>00970             <span class="comment">// if doesn&apos;t qualify as duplicate ACK, just ignore it.</span>
<a name="l00971"></a>00971             <span class="keywordflow">if</span> (tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a7d9f010b71e3bfa267873ab21195fb73">getPayloadLength</a>()==0)
<a name="l00972"></a>00972             {
<a name="l00973"></a>00973                 <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>!=tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>())
<a name="l00974"></a>00974                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Old ACK: ackNo&lt;snd_una\n&quot;</span>;
<a name="l00975"></a>00975                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a>)
<a name="l00976"></a>00976                     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK looks duplicate but we have currently no unacked data (snd_una==snd_max)\n&quot;</span>;
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978 
<a name="l00979"></a>00979             <span class="comment">// reset counter</span>
<a name="l00980"></a>00980             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74cb98612a9fa541a2682e33f3991582">dupacks</a> = 0;
<a name="l00981"></a>00981         }
<a name="l00982"></a>00982     }
<a name="l00983"></a>00983     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a2a4d76c437a6e0eb1e1440c02153e5db">seqLE</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(), <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a>))
<a name="l00984"></a>00984     {
<a name="l00985"></a>00985         <span class="comment">// ack in window.</span>
<a name="l00986"></a>00986         uint32 old_snd_una = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>;
<a name="l00987"></a>00987         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l00988"></a>00988         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a529775c184153f33ff75a91bacc8b0fc">unackedVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a529775c184153f33ff75a91bacc8b0fc">unackedVector</a>-&gt;record(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a> - <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>);
<a name="l00989"></a>00989 
<a name="l00990"></a>00990         <span class="comment">// after retransmitting a lost segment, we may get an ack well ahead of snd_nxt</span>
<a name="l00991"></a>00991         <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a17c7a0744a549bb90de7d1bc6b8b72ad">seqLess</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>))
<a name="l00992"></a>00992             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#acab59efee35f446ab6310db804cd164d">snd_nxt</a> = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>;
<a name="l00993"></a>00993 
<a name="l00994"></a>00994         uint32 discardUpToSeq = <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ace4a453b30bdffb99c1c0646fba597dc">snd_una</a>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996         <span class="comment">// our FIN acked?</span>
<a name="l00997"></a>00997         <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a2a8d544b5707071afcc5402e6318e245">send_fin</a> &amp;&amp; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>()==<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a1156c4cdd71d0e83c9bb401a68e9f606">snd_fin_seq</a>+1)
<a name="l00998"></a>00998         {
<a name="l00999"></a>00999             <span class="comment">// set flag that our FIN has been acked</span>
<a name="l01000"></a>01000             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;ACK acks our FIN\n&quot;</span>;
<a name="l01001"></a>01001             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#ad2deb1000d47f2e1524f1f5dee059b34">fin_ack_rcvd</a> = <span class="keyword">true</span>;
<a name="l01002"></a>01002             discardUpToSeq--; <span class="comment">// the FIN sequence number is not real data</span>
<a name="l01003"></a>01003         }
<a name="l01004"></a>01004 
<a name="l01005"></a>01005         <span class="comment">// acked data no longer needed in send queue</span>
<a name="l01006"></a>01006         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7bd9b6b2b4422771b92e00d307983d19">sendQueue</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_send_queue.html#aced2fde7fde0ec8f6a32b1e16d6bbda9">discardUpTo</a>(discardUpToSeq);
<a name="l01007"></a>01007 
<a name="l01008"></a>01008         <span class="keywordflow">if</span> (<a class="code" href="namespacetcp__old.html#a17c7a0744a549bb90de7d1bc6b8b72ad">seqLess</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4ddf055ba61bab9723814bfb1f55cfe5">snd_wl1</a>, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>()) ||
<a name="l01009"></a>01009             (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4ddf055ba61bab9723814bfb1f55cfe5">snd_wl1</a>==tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>() &amp;&amp; <a class="code" href="namespacetcp__old.html#a2a4d76c437a6e0eb1e1440c02153e5db">seqLE</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#aae32069f7798da55852c7244d816b9a1">snd_wl2</a>, tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>())))
<a name="l01010"></a>01010         {
<a name="l01011"></a>01011             <span class="comment">// send window should be updated</span>
<a name="l01012"></a>01012             <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Updating send window from segment: new wnd=&quot;</span> &lt;&lt; tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8ef1b3d7dceadd931a331c121e55c556">getWindow</a>() &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01013"></a>01013             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a8ef1b3d7dceadd931a331c121e55c556">getWindow</a>();
<a name="l01014"></a>01014             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a4ddf055ba61bab9723814bfb1f55cfe5">snd_wl1</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a0dafe41ef5a4306a4106fdb1e22b19e8">getSequenceNo</a>();
<a name="l01015"></a>01015             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#aae32069f7798da55852c7244d816b9a1">snd_wl2</a> = tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>();
<a name="l01016"></a>01016             <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>) <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab58ab42e2f19a58edcfa549b51a7179b">sndWndVector</a>-&gt;record(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a98ce75b56709cdf80549bf95b9b02023">snd_wnd</a>);
<a name="l01017"></a>01017         }
<a name="l01018"></a>01018 
<a name="l01019"></a>01019         <span class="comment">// notify</span>
<a name="l01020"></a>01020         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#aca06733ab569ab16f026d31a3bfe5077">receivedDataAck</a>(old_snd_una);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022         <span class="comment">// in the receivedDataAck we need the old value</span>
<a name="l01023"></a>01023         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74cb98612a9fa541a2682e33f3991582">dupacks</a> = 0;
<a name="l01024"></a>01024     }
<a name="l01025"></a>01025     <span class="keywordflow">else</span>
<a name="l01026"></a>01026     {
<a name="l01027"></a>01027         ASSERT(<a class="code" href="namespacetcp__old.html#a91800c1929091c104e787a01f5955a9f">seqGreater</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>(), <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a7589e90fe54f9579ab547d55760b4d17">snd_max</a>)); <span class="comment">// from if-ladder</span>
<a name="l01028"></a>01028 
<a name="l01029"></a>01029         <span class="comment">// send an ACK, drop the segment, and return.</span>
<a name="l01030"></a>01030         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a2212cb0deb11d2b1c5826cab57b3f42e">tcpAlgorithm</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_algorithm.html#a9f6805c97af24ed1cfe2b94adf983a64">receivedAckForDataNotYetSent</a>(tcpseg-&gt;<a class="code" href="class_t_c_p_segment___base.html#a853ab8ce8acfb5da053fa9ca24592ce8">getAckNo</a>());
<a name="l01031"></a>01031         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a74cb98612a9fa541a2682e33f3991582">dupacks</a> = 0;
<a name="l01032"></a>01032         <span class="keywordflow">return</span> <span class="keyword">false</span>;  <span class="comment">// means &quot;drop&quot;</span>
<a name="l01033"></a>01033     }
<a name="l01034"></a>01034     <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l01035"></a>01035 }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037 <span class="comment">//----</span>
<a name="l01038"></a>01038 
<a name="l01039"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7b47d21fa8a97f13cab52097f3332ea6">01039</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a7b47d21fa8a97f13cab52097f3332ea6">TCPConnection::process_TIMEOUT_CONN_ESTAB</a>()
<a name="l01040"></a>01040 {
<a name="l01041"></a>01041     <span class="keywordflow">switch</span>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l01042"></a>01042     {
<a name="l01043"></a>01043         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a>:
<a name="l01044"></a>01044         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaafde4b4cc43d59d14ba2cbf0bc3adb525">TCP_S_SYN_SENT</a>:
<a name="l01045"></a>01045             <span class="comment">// Nothing to do here. TIMEOUT_CONN_ESTAB event will automatically</span>
<a name="l01046"></a>01046             <span class="comment">// take the connection to LISTEN or CLOSED, and cancel SYN-REXMIT timer.</span>
<a name="l01047"></a>01047             <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#afba4a9f34c546c37533eb5311c1da682">active</a>)
<a name="l01048"></a>01048             {
<a name="l01049"></a>01049                 <span class="comment">// notify user if we&apos;re on the active side</span>
<a name="l01050"></a>01050                 <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba06629e44a0aef5201b4cd424596127bf">TCP_I_TIMED_OUT</a>);
<a name="l01051"></a>01051             }
<a name="l01052"></a>01052             <span class="keywordflow">break</span>;
<a name="l01053"></a>01053         <span class="keywordflow">default</span>:
<a name="l01054"></a>01054             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01055"></a>01055             opp_error(<span class="stringliteral">&quot;Internal error: received CONN_ESTAB timeout in state %s&quot;</span>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()));
<a name="l01056"></a>01056     }
<a name="l01057"></a>01057 }
<a name="l01058"></a>01058 
<a name="l01059"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae29072ef963e593c4c3053827ebbec6e">01059</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae29072ef963e593c4c3053827ebbec6e">TCPConnection::process_TIMEOUT_2MSL</a>()
<a name="l01060"></a>01060 {
<a name="l01061"></a>01061     <span class="comment">//&quot;</span>
<a name="l01062"></a>01062     <span class="comment">// If the time-wait timeout expires on a connection delete the TCB,</span>
<a name="l01063"></a>01063     <span class="comment">// enter the CLOSED state and return.</span>
<a name="l01064"></a>01064     <span class="comment">//&quot;</span>
<a name="l01065"></a>01065     <span class="keywordflow">switch</span>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l01066"></a>01066     {
<a name="l01067"></a>01067         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaa8a4fa6fa69c727999ad6b8fe056a6fd1">TCP_S_TIME_WAIT</a>:
<a name="l01068"></a>01068             <span class="comment">// Nothing to do here. The TIMEOUT_2MSL event will automatically take</span>
<a name="l01069"></a>01069             <span class="comment">// the connection to CLOSED. We already notified the user</span>
<a name="l01070"></a>01070             <span class="comment">// (TCP_I_CLOSED) when we entered the TIME_WAIT state from CLOSING,</span>
<a name="l01071"></a>01071             <span class="comment">// FIN_WAIT_1 or FIN_WAIT_2.</span>
<a name="l01072"></a>01072             <span class="keywordflow">break</span>;
<a name="l01073"></a>01073         <span class="keywordflow">default</span>:
<a name="l01074"></a>01074             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01075"></a>01075             opp_error(<span class="stringliteral">&quot;Internal error: received time-wait (2MSL) timeout in state %s&quot;</span>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()));
<a name="l01076"></a>01076     }
<a name="l01077"></a>01077 
<a name="l01078"></a>01078 }
<a name="l01079"></a>01079 
<a name="l01080"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a53d62d237307ad56bae8d320ff557e48">01080</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a53d62d237307ad56bae8d320ff557e48">TCPConnection::process_TIMEOUT_FIN_WAIT_2</a>()
<a name="l01081"></a>01081 {
<a name="l01082"></a>01082     <span class="keywordflow">switch</span>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l01083"></a>01083     {
<a name="l01084"></a>01084         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaea07c6aa092a0b2e9141385fb4734797">TCP_S_FIN_WAIT_2</a>:
<a name="l01085"></a>01085             <span class="comment">// Nothing to do here. The TIMEOUT_FIN_WAIT_2 event will automatically take</span>
<a name="l01086"></a>01086             <span class="comment">// the connection to CLOSED.</span>
<a name="l01087"></a>01087             <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a65a8dc93c08a685f145248d0fb327428">sendIndicationToApp</a>(<a class="code" href="_t_c_p_command__m_8h.html#a68611fc79dbc74e8744d74b746cd956ba994690e6a29c6e7c3eedc8fbb29d7a8c">TCP_I_CLOSED</a>);
<a name="l01088"></a>01088             <span class="keywordflow">break</span>;
<a name="l01089"></a>01089         <span class="keywordflow">default</span>:
<a name="l01090"></a>01090             <span class="comment">// We should not receive this timeout in this state.</span>
<a name="l01091"></a>01091             opp_error(<span class="stringliteral">&quot;Internal error: received FIN_WAIT_2 timeout in state %s&quot;</span>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()));
<a name="l01092"></a>01092     }
<a name="l01093"></a>01093 }
<a name="l01094"></a>01094 
<a name="l01095"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">01095</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#aa58f44bc38ec0af46aca654f9403771f">TCPConnection::startSynRexmitTimer</a>()
<a name="l01096"></a>01096 {
<a name="l01097"></a>01097     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#add0426103a74138a0599e58049526e8a">syn_rexmit_count</a> = 0;
<a name="l01098"></a>01098     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a> = <a class="code" href="_t_c_p_connection_8h.html#a89ce38305130a5021e21134602a88f79">TCP_TIMEOUT_SYN_REXMIT</a>;
<a name="l01099"></a>01099 
<a name="l01100"></a>01100     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad70c187b499189b370f99433eb825dcd">synRexmitTimer</a>-&gt;isScheduled())
<a name="l01101"></a>01101         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad06a2b75a619021592db07ab486f0fed">cancelEvent</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad70c187b499189b370f99433eb825dcd">synRexmitTimer</a>);
<a name="l01102"></a>01102     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad70c187b499189b370f99433eb825dcd">synRexmitTimer</a>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a>);
<a name="l01103"></a>01103 }
<a name="l01104"></a>01104 
<a name="l01105"></a><a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a33c6fe420de8b7fc6c09761f70118ed0">01105</a> <span class="keywordtype">void</span> <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a33c6fe420de8b7fc6c09761f70118ed0">TCPConnection::process_TIMEOUT_SYN_REXMIT</a>(<a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32">TCPEventCode</a>&amp; event)
<a name="l01106"></a>01106 {
<a name="l01107"></a>01107     <span class="keywordflow">if</span> (++<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#add0426103a74138a0599e58049526e8a">syn_rexmit_count</a>&gt;<a class="code" href="_t_c_p_connection_8h.html#acd69c7cf1d3622b1d7aa706d7f9b97f9">MAX_SYN_REXMIT_COUNT</a>)
<a name="l01108"></a>01108     {
<a name="l01109"></a>01109         <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Retransmission count during connection setup exceeds &quot;</span> &lt;&lt; <a class="code" href="_t_c_p_connection_8h.html#acd69c7cf1d3622b1d7aa706d7f9b97f9">MAX_SYN_REXMIT_COUNT</a> &lt;&lt; <span class="stringliteral">&quot;, giving up\n&quot;</span>;
<a name="l01110"></a>01110         <span class="comment">// Note ABORT will take the connection to closed, and cancel CONN-ESTAB timer as well</span>
<a name="l01111"></a>01111         <span class="keyword">event</span> = <a class="code" href="namespacetcp__old.html#abfa4f59944c07369d42e86a72040dd32a1fd07d5de8615b02fe30cc7159af37af">TCP_E_ABORT</a>;
<a name="l01112"></a>01112         <span class="keywordflow">return</span>;
<a name="l01113"></a>01113     }
<a name="l01114"></a>01114 
<a name="l01115"></a>01115     <a class="code" href="_t_c_p_8h.html#a601325e92d65fe658c80eab711e12304">tcpEV</a> &lt;&lt; <span class="stringliteral">&quot;Performing retransmission #&quot;</span> &lt;&lt; <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#add0426103a74138a0599e58049526e8a">syn_rexmit_count</a> &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l01116"></a>01116 
<a name="l01117"></a>01117     <span class="comment">// resend what&apos;s needed</span>
<a name="l01118"></a>01118     <span class="keywordflow">switch</span>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState())
<a name="l01119"></a>01119     {
<a name="l01120"></a>01120         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaafde4b4cc43d59d14ba2cbf0bc3adb525">TCP_S_SYN_SENT</a>: <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#abcd8f7efecc7c0077050184d3384b493">sendSyn</a>(); <span class="keywordflow">break</span>;
<a name="l01121"></a>01121         <span class="keywordflow">case</span> <a class="code" href="namespacetcp__old.html#acdbb7986967662f90bca9b6ef46f3acaaf96abc23364b3cdd51216d5cc9a4f3fc">TCP_S_SYN_RCVD</a>: <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a675b131a43de7429552a574cabcc12dd">sendSynAck</a>(); <span class="keywordflow">break</span>;
<a name="l01122"></a>01122         <span class="keywordflow">default</span>:  opp_error(<span class="stringliteral">&quot;Internal error: SYN-REXMIT timer expired while in state %s&quot;</span>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ab991cf2680a63832310a4a56ac17972e">stateName</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#a3b7998c1cae436f8d35cabdb073d3881">fsm</a>.getState()));
<a name="l01123"></a>01123     }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125     <span class="comment">// reschedule timer</span>
<a name="l01126"></a>01126     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a> *= 2;
<a name="l01127"></a>01127 
<a name="l01128"></a>01128     <span class="keywordflow">if</span> (<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a> &gt; <a class="code" href="_t_c_p_connection_8h.html#a0b48410b2bd35dbc6509568bfb1842aa">TCP_TIMEOUT_SYN_REXMIT_MAX</a>)
<a name="l01129"></a>01129         <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a> = <a class="code" href="_t_c_p_connection_8h.html#a0b48410b2bd35dbc6509568bfb1842aa">TCP_TIMEOUT_SYN_REXMIT_MAX</a>;
<a name="l01130"></a>01130     <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae1ff44c73d20293a446adc091842bedd">scheduleTimeout</a>(<a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ad70c187b499189b370f99433eb825dcd">synRexmitTimer</a>, <a class="code" href="classtcp__old_1_1_t_c_p_connection.html#ae549dc567d3d71f2981c3be27cee0ccb">state</a>-&gt;<a class="code" href="classtcp__old_1_1_t_c_p_state_variables.html#a9aec9c42959150643d39bde968908d39">syn_rexmit_timeout</a>);
<a name="l01131"></a>01131 }
<a name="l01132"></a>01132 
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 <span class="comment">//</span>
<a name="l01135"></a>01135 <span class="comment">//TBD:</span>
<a name="l01136"></a>01136 <span class="comment">//&quot;</span>
<a name="l01137"></a>01137 <span class="comment">// USER TIMEOUT</span>
<a name="l01138"></a>01138 <span class="comment">//</span>
<a name="l01139"></a>01139 <span class="comment">//    For any state if the user timeout expires, flush all queues, signal</span>
<a name="l01140"></a>01140 <span class="comment">//    the user &quot;error:  connection aborted due to user timeout&quot; in general</span>
<a name="l01141"></a>01141 <span class="comment">//    and for any outstanding calls, delete the TCB, enter the CLOSED</span>
<a name="l01142"></a>01142 <span class="comment">//    state and return.</span>
<a name="l01143"></a>01143 <span class="comment">//&quot;</span>
<a name="l01144"></a>01144 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Tue Mar 23 17:08:30 2010 for INET Framework for OMNeT++/OMNEST by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
